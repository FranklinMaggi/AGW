francescomaggi@MacBook-Pro agw-app % showall
├─ .wrangler/tmp/dev-WycVxd/api.js
```javascript
var __defProp = Object.defineProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });

// workers/core/cors.js
function cors(type = "application/json") {
  return {
    "Content-Type": type,
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, x-admin-token"
  };
}
__name(cors, "cors");

// workers/core/response.js
function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: cors("application/json")
  });
}
__name(json, "json");

// workers/user/repo/saveUser.js
async function saveUser(env, id, user) {
  await env.AGW_USERS.put(`user:${id}`, JSON.stringify(user));
}
__name(saveUser, "saveUser");

// workers/user/repo/getUser.js
async function getUser(env, id) {
  const raw = await env.AGW_USERS.get(`user:${id}`);
  return raw ? JSON.parse(raw) : null;
}
__name(getUser, "getUser");

// workers/user/model/defaultUser.js
function createDefaultUser(id) {
  return {
    id,
    nickname: "",
    firstname: "",
    lastname: "",
    email: "",
    profile_image: null,
    avatar_ai: null,
    password_reset: {
      token: null,
      expires_at: null
    },
    mailing: {
      primary: "",
      secondary: null,
      verified: false,
      verification_sent_at: null,
      verified_at: null,
      preferences: {
        newsletter: true,
        missions: true,
        rewards: true,
        billing: true,
        security: true
      },
      status: {
        bounced: false,
        soft_bounce_count: 0,
        hard_bounce: false,
        unsubscribe: false,
        unsubscribe_at: null
      },
      log: []
    },
    personal: {
      birthdate: null,
      weight: null,
      height: null,
      gender: null,
      job: null
    },
    status: {
      suspended: false,
      createdAt: Date.now()
    },
    stats: {
      level_total: 1,
      level_year: 1,
      rank_month: 0,
      motivation_week: 0,
      assessment_day: 0,
      krm_total: 0,
      krm_year: 0,
      krm_month: 0,
      krm_week: 0,
      krm_day: 0,
      missions_completed_total: 0,
      missions_completed_month: 0,
      missions_completed_week: 0,
      missions_completed_today: 0,
      dayPurchasesLast7Days: 0
    },
    discipline: {
      daily_completed: 0,
      daily_goal: 3,
      weekly_completed: 0,
      weekly_goal: 7
    },
    subscription: {
      type: null,
      renew_every: null,
      last_payment_at: null,
      payment_status: null,
      expires_at: null
    },
    bonus: null
  };
}
__name(createDefaultUser, "createDefaultUser");

// workers/user/repo/findUserByEmail.js
async function findUserByEmail(env, email) {
  const norm = /* @__PURE__ */ __name((v) => (v || "").trim().toLowerCase(), "norm");
  const target = norm(email);
  if (!target) return null;
  const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
  for (const k of keys) {
    if (k.name === "user:index") continue;
    const raw = await env.AGW_USERS.get(k.name);
    if (!raw) continue;
    let user;
    try {
      user = JSON.parse(raw);
    } catch {
      continue;
    }
    if (norm(user.email) === target || norm(user.mailing?.primary) === target) {
      return user;
    }
  }
  return null;
}
__name(findUserByEmail, "findUserByEmail");

// workers/user/logic/registerUser.js
async function registerUserHandler(request, env) {
  const body = await request.json();
  const { email, firstname, lastname, password } = body;
  if (!email) return json({ error: "Missing email" }, 400);
  if (!password) return json({ error: "Missing password" }, 400);
  const existing = await findUserByEmail(env, email);
  if (existing) return json({ error: "Email already registered" }, 409);
  const id = crypto.randomUUID();
  const user = createDefaultUser(id);
  user.email = email;
  user.mailing.primary = email;
  user.firstname = firstname || "";
  user.lastname = lastname || "";
  user.password = password;
  await saveUser(env, id, user);
  return json({ ok: true, user });
}
__name(registerUserHandler, "registerUserHandler");

// workers/user/logic/deleteUser.js
async function deleteUser(env, id) {
  if (!id) return json({ error: "Missing id" }, 400);
  await env.AGW_USERS.delete(`user:${id}`);
  return json({ deleted: true });
}
__name(deleteUser, "deleteUser");

// workers/security/verifyPassword.js
async function verifyPassword(password, hash, salt) {
  const encoder = new TextEncoder();
  const saltBytes = Uint8Array.from(atob(salt), (c) => c.charCodeAt(0));
  const hashBytes = Uint8Array.from(atob(hash), (c) => c.charCodeAt(0));
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    encoder.encode(password),
    { name: "PBKDF2" },
    false,
    ["deriveBits", "deriveKey"]
  );
  const key = await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: saltBytes,
      iterations: 2e5,
      hash: "SHA-256"
    },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    true,
    ["encrypt", "decrypt"]
  );
  const rawKey = new Uint8Array(await crypto.subtle.exportKey("raw", key));
  return crypto.subtle.timingSafeEqual ? crypto.subtle.timingSafeEqual(rawKey, hashBytes) : rawKey.every((b, i) => b === hashBytes[i]);
}
__name(verifyPassword, "verifyPassword");

// workers/sessions/createSession.js
async function createSession(env, userId, role = "user") {
  const sessionId = crypto.randomUUID();
  const data = {
    userId,
    role,
    createdAt: Date.now()
  };
  await env.AGW_SESSIONS.put(`sess:${sessionId}`, JSON.stringify(data), {
    expirationTtl: 60 * 60 * 24 * 30
  });
  return sessionId;
}
__name(createSession, "createSession");

// workers/user/logic/loginUser.js
async function loginUser(env, body) {
  const { email, password } = body;
  if (!email || !password)
    return json({ ok: false, error: "Missing credentials" }, 400);
  const user = await findUserByEmail(env, email);
  if (!user)
    return json({ ok: false, error: "EMAIL_NOT_FOUND" }, 404);
  const match = await verifyPassword(password, user.password_hash, user.password_salt);
  if (!match)
    return json({ ok: false, error: "WRONG_PASSWORD" }, 401);
  if (user.status?.suspended)
    return json({ ok: false, error: "ACCOUNT_SUSPENDED" }, 403);
  const sessionId = await createSession(env, user.id, "user");
  return json({
    ok: true,
    sessionId,
    user: {
      id: user.id,
      email: user.email,
      firstname: user.firstname,
      lastname: user.lastname
    }
  });
}
__name(loginUser, "loginUser");

// workers/user/logic/requestPasswordReset.js
async function requestPasswordReset(env, email) {
  const user = await findUserByEmail(env, email);
  if (!user) {
    return { ok: true };
  }
  const token = crypto.randomUUID();
  const expiresAt = Date.now() + 15 * 60 * 1e3;
  user.password_reset = {
    token,
    expires_at: expiresAt
  };
  await saveUser(env, user.id, user);
  return {
    ok: true,
    reset_token: token
    // solo per dev, da togliere in prod
  };
}
__name(requestPasswordReset, "requestPasswordReset");

// workers/user/logic/resetPassword.js
async function resetPassword(env, token, newPassword) {
  const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
  let targetUser = null;
  for (const k of keys) {
    if (k.name === "user:index") continue;
    const raw = await env.AGW_USERS.get(k.name);
    if (!raw) continue;
    let u;
    try {
      u = JSON.parse(raw);
    } catch {
      continue;
    }
    if (u.password_reset?.token === token) {
      targetUser = u;
      break;
    }
  }
  if (!targetUser) {
    return { ok: false, error: "Invalid token", status: 400 };
  }
  if (targetUser.password_reset.expires_at < Date.now()) {
    return { ok: false, error: "Token expired", status: 400 };
  }
  targetUser.password = newPassword;
  targetUser.password_reset = {
    token: null,
    expires_at: null
  };
  await saveUser(env, targetUser.id, targetUser);
  return { ok: true };
}
__name(resetPassword, "resetPassword");

// workers/user/logic/evaluateWeeklyBonus.js
function evaluateWeeklyBonus(dailyCount) {
  if (dailyCount >= 15)
    return {
      award: "ADVANCED",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  if (dailyCount >= 8)
    return {
      award: "COMFORT",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  if (dailyCount >= 5)
    return {
      award: "BASIC",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  return {
    award: null,
    days: 0,
    expiresAt: null
  };
}
__name(evaluateWeeklyBonus, "evaluateWeeklyBonus");

// workers/user/route.js
function userRoutes(url, method, request, env) {
  if (url.pathname === "/api/user/login" && method === "POST") {
    return (async () => {
      const body = await request.json();
      const result = await loginUser(env, body);
      const status = result?.status ?? (result.error ? 400 : 200);
      return json(result, status);
    })();
  }
  if (url.pathname === "/api/user/request-password-reset" && method === "POST") {
    return (async () => {
      const { email } = await request.json();
      const result = await requestPasswordReset(env, email);
      return json(result);
    })();
  }
  if (url.pathname === "/api/user/reset-password" && method === "POST") {
    return (async () => {
      const { token, new_password } = await request.json();
      const result = await resetPassword(env, token, new_password);
      return json(result, result.ok ? 200 : 400);
    })();
  }
  if (url.pathname === "/api/user/register" && method === "POST") {
    return registerUserHandler(request, env);
  }
  if (url.pathname === "/api/user/get" && method === "POST") {
    return (async () => {
      const { id } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      return json(user);
    })();
  }
  if (url.pathname === "/api/user/add-day" && method === "POST") {
    return (async () => {
      const { id } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      user.stats.dayPurchasesLast7Days = (user.stats.dayPurchasesLast7Days || 0) + 1;
      const daily = user.stats.dayPurchasesLast7Days;
      const bonus = evaluateWeeklyBonus(daily);
      if (bonus.award) {
        user.bonus = bonus;
        user.subscription = {
          type: bonus.award,
          expiresAt: bonus.expiresAt
        };
      }
      await saveUser(env, id, user);
      return json(user);
    })();
  }
  if (url.pathname === "/api/user/apply-bonus" && method === "POST") {
    return (async () => {
      const { id, dailyCount } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      const count = Number(dailyCount ?? 0);
      const bonus = evaluateWeeklyBonus(count);
      user.bonus = bonus;
      if (bonus.award) {
        user.subscription = {
          type: bonus.award,
          expiresAt: bonus.expiresAt
        };
      }
      user.stats.dayPurchasesLast7Days = count;
      await saveUser(env, id, user);
      return json(user);
    })();
  }
  if (url.pathname === "/api/admin/user/delete" && method === "POST") {
    return deleteUser(request, env);
  }
  if (url.pathname === "/api/user/update-avatar" && method === "POST") {
    return (async () => {
      const { userId, avatarBase64 } = await request.json();
      if (!userId) return json({ error: "Missing userId" }, 400);
      const user = await getUser(env, userId);
      if (!user) return json({ error: "User not found" }, 404);
      user.profile_image = avatarBase64;
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-profile" && method === "POST") {
    return (async () => {
      const { userId, data } = await request.json();
      if (!userId) return json({ error: "Missing userId" }, 400);
      const user = await getUser(env, userId);
      if (!user) return json({ error: "Not found" }, 404);
      user.firstname = data.firstname || user.firstname;
      user.lastname = data.lastname || user.lastname;
      user.nickname = data.nickname || user.nickname;
      user.personal = { ...user.personal, ...data.personal };
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-email-prefs" && method === "POST") {
    return (async () => {
      const { userId, prefs } = await request.json();
      const user = await getUser(env, userId);
      if (!user) return json({ error: "Not found" }, 404);
      user.mailing.preferences = {
        ...user.mailing.preferences,
        ...prefs
      };
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-password" && method === "POST") {
    return (async () => {
      const { userId, oldPassword, newPassword } = await request.json();
      const user = await getUser(env, userId);
      if (!user) return json({ error: "User not found" }, 404);
      if (user.password !== oldPassword) {
        return json({ error: "Old password incorrect" }, 403);
      }
      user.password = newPassword;
      await saveUser(env, userId, user);
      return json({ ok: true });
    })();
  }
  return null;
}
__name(userRoutes, "userRoutes");

// workers/admin/getAdmin.js
async function getAdmin(env, email) {
  const { keys } = await env.AGW_ADMIN.list({ prefix: "admin:" });
  for (const k of keys) {
    const raw = await env.AGW_ADMIN.get(k.name);
    if (!raw) continue;
    const admin = JSON.parse(raw);
    if (admin.email.toLowerCase() === email.toLowerCase()) {
      return admin;
    }
  }
  return null;
}
__name(getAdmin, "getAdmin");

// workers/admin/createAdminSession.js
async function createAdminSession(env, adminId) {
  const sessionId = crypto.randomUUID();
  const expiresAt = Date.now() + 1e3 * 60 * 60 * 24;
  const payload = {
    adminId,
    createdAt: Date.now(),
    expiresAt
  };
  await env.AGW_ADMIN_SESSIONS.put(`session:${sessionId}`, JSON.stringify(payload));
  return sessionId;
}
__name(createAdminSession, "createAdminSession");

// workers/admin/loginAdmin.js
async function loginAdmin(env, email, password) {
  const admin = await getAdmin(env, email);
  if (!admin) {
    return { ok: false, error: "ADMIN_NOT_FOUND", status: 404 };
  }
  if (admin.password !== password) {
    return { ok: false, error: "WRONG_PASSWORD", status: 401 };
  }
  const sessionId = await createAdminSession(env, admin.id);
  return { ok: true, sessionId, admin };
}
__name(loginAdmin, "loginAdmin");

// workers/admin/logoutAdminSession.js
async function logoutAdmin(env, sessionId) {
  await env.AGW_ADMIN_SESSIONS.delete(`session:${sessionId}`);
  return true;
}
__name(logoutAdmin, "logoutAdmin");

// workers/admin/verifyAdminSession.js
async function verifyAdminSession(env, sessionId) {
  const raw = await env.AGW_ADMIN_SESSIONS.get(`session:${sessionId}`);
  if (!raw) return null;
  const session = JSON.parse(raw);
  if (session.expiresAt < Date.now()) {
    await env.AGW_ADMIN_SESSIONS.delete(`session:${sessionId}`);
    return null;
  }
  return session;
}
__name(verifyAdminSession, "verifyAdminSession");

// workers/api.js
var api_default = {
  async fetch(request, env, ctx) {
    try {
      const url = new URL(request.url);
      const method = request.method;
      const userResult = userRoutes(url, method, request, env);
      if (userResult) return userResult;
      if (method === "OPTIONS") {
        return new Response(null, { status: 204, headers: cors() });
      }
      if (url.pathname === "/api/admin/login" && method === "POST") {
        const { email, password } = await request.json();
        const result = await loginAdmin(env, email, password);
        if (!result.ok) {
          return json(result, result.status ?? 400);
        }
        return json({
          ok: true,
          sessionId: result.sessionId,
          admin: result.admin
        });
      }
      if (url.pathname === "/api/admin/logout" && method === "POST") {
        const { sessionId } = await request.json();
        await logoutAdmin(env, sessionId);
        return json({ ok: true });
      }
      if (url.pathname === "/api/admin/me" && method === "POST") {
        const { sessionId } = await request.json();
        const session = await verifyAdminSession(env, sessionId);
        return json({ ok: !!session, session });
      }
      async function requireAdminSession() {
        const { sessionId } = await request.json();
        const session = await verifyAdminSession(env, sessionId);
        if (!session) return null;
        return session;
      }
      __name(requireAdminSession, "requireAdminSession");
      if (url.pathname === "/api/admin/overview" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
        let totalUsers = 0;
        let subs = 0;
        let bonuses = 0;
        let krm = 0;
        let day = 0;
        let missions = 0;
        for (const k of keys) {
          if (k.name === "user:index") continue;
          const raw = await env.AGW_USERS.get(k.name);
          if (!raw) continue;
          const user = JSON.parse(raw);
          totalUsers++;
          if (user.subscription?.type) subs++;
          if (user.bonus?.award) bonuses++;
          krm += user.stats?.krm_total ?? 0;
          missions += user.stats?.missions_completed_total ?? 0;
          day += user.stats?.dayPurchasesLast7Days ?? 0;
        }
        return json({
          totalUsers,
          activeSubscriptions: subs,
          activeBonuses: bonuses,
          totalKRM: krm,
          totalDay: day,
          totalMissions: missions
        });
      }
      if (url.pathname === "/api/admin/users/list" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
        const users = [];
        for (const k of keys) {
          if (k.name === "user:index") continue;
          const raw = await env.AGW_USERS.get(k.name);
          if (!raw) continue;
          try {
            const user = JSON.parse(raw);
            if (user?.id) users.push(user);
          } catch {
          }
        }
        return json({ users });
      }
      if (url.pathname === "/api/admin/user/create" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        let index = Number(await env.AGW_USERS.get("user:index") || 0);
        index++;
        await env.AGW_USERS.put("user:index", String(index));
        const id = crypto.randomUUID();
        const user = {
          id,
          index,
          nickname: `user${index}`,
          firstname: `name${index}`,
          lastname: `lastname${index}`,
          email: `name${index}.lastname${index}@mail.com`,
          password: "_" + index,
          stats: { level_total: 1 }
        };
        await env.AGW_USERS.put(`user:${id}`, JSON.stringify(user));
        return json(user);
      }
      if (url.pathname === "/api/admin/user/update" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { id, field, value } = body;
        const user = await getUser(env, id);
        if (!user) return json({ error: "User not found" }, 404);
        if (field === "delete") {
          return deleteUser(env, id);
        }
        if (field === "krm") user.stats.krm_total = Number(value);
        if (field === "level") user.stats.level_total = Number(value);
        if (field === "suspend") user.status.suspended = true;
        if (field === "unsuspend") user.status.suspended = false;
        await saveUser(env, id, user);
        return json(user);
      }
      return new Response("Not found", {
        status: 404,
        headers: cors()
      });
    } catch (err) {
      return json({ error: "Internal Error", detail: err?.message }, 500);
    }
  }
};

// ../../../../../.nvm/versions/node/v22.18.0/lib/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts
var drainBody = /* @__PURE__ */ __name(async (request, env, _ctx, middlewareCtx) => {
  try {
    return await middlewareCtx.next(request, env);
  } finally {
    try {
      if (request.body !== null && !request.bodyUsed) {
        const reader = request.body.getReader();
        while (!(await reader.read()).done) {
        }
      }
    } catch (e) {
      console.error("Failed to drain the unused request body.", e);
    }
  }
}, "drainBody");
var middleware_ensure_req_body_drained_default = drainBody;

// .wrangler/tmp/bundle-Wnah6p/middleware-insertion-facade.js
var __INTERNAL_WRANGLER_MIDDLEWARE__ = [
  middleware_ensure_req_body_drained_default
];
var middleware_insertion_facade_default = api_default;

// ../../../../../.nvm/versions/node/v22.18.0/lib/node_modules/wrangler/templates/middleware/common.ts
```

├─ .wrangler/tmp/dev-fVZfc6/api.js
```javascript
var __defProp = Object.defineProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });

// workers/core/cors.js
function cors(type = "application/json") {
  return {
    "Content-Type": type,
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, x-admin-token"
  };
}
__name(cors, "cors");

// workers/core/response.js
function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: cors("application/json")
  });
}
__name(json, "json");

// workers/user/repo/saveUser.js
async function saveUser(env, id, user) {
  await env.AGW_USERS.put(`user:${id}`, JSON.stringify(user));
}
__name(saveUser, "saveUser");

// workers/user/repo/getUser.js
async function getUser(env, id) {
  const raw = await env.AGW_USERS.get(`user:${id}`);
  return raw ? JSON.parse(raw) : null;
}
__name(getUser, "getUser");

// workers/user/model/defaultUser.js
function createDefaultUser(id) {
  return {
    id,
    nickname: "",
    firstname: "",
    lastname: "",
    email: "",
    profile_image: null,
    avatar_ai: null,
    password_reset: {
      token: null,
      expires_at: null
    },
    mailing: {
      primary: "",
      secondary: null,
      verified: false,
      verification_sent_at: null,
      verified_at: null,
      preferences: {
        newsletter: true,
        missions: true,
        rewards: true,
        billing: true,
        security: true
      },
      status: {
        bounced: false,
        soft_bounce_count: 0,
        hard_bounce: false,
        unsubscribe: false,
        unsubscribe_at: null
      },
      log: []
    },
    personal: {
      birthdate: null,
      weight: null,
      height: null,
      gender: null,
      job: null
    },
    status: {
      suspended: false,
      createdAt: Date.now()
    },
    stats: {
      level_total: 1,
      level_year: 1,
      rank_month: 0,
      motivation_week: 0,
      assessment_day: 0,
      krm_total: 0,
      krm_year: 0,
      krm_month: 0,
      krm_week: 0,
      krm_day: 0,
      missions_completed_total: 0,
      missions_completed_month: 0,
      missions_completed_week: 0,
      missions_completed_today: 0,
      dayPurchasesLast7Days: 0
    },
    discipline: {
      daily_completed: 0,
      daily_goal: 3,
      weekly_completed: 0,
      weekly_goal: 7
    },
    subscription: {
      type: null,
      renew_every: null,
      last_payment_at: null,
      payment_status: null,
      expires_at: null
    },
    bonus: null
  };
}
__name(createDefaultUser, "createDefaultUser");

// workers/user/repo/findUserByEmail.js
async function findUserByEmail(env, email) {
  const norm = /* @__PURE__ */ __name((v) => (v || "").trim().toLowerCase(), "norm");
  const target = norm(email);
  if (!target) return null;
  const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
  for (const k of keys) {
    if (k.name === "user:index") continue;
    const raw = await env.AGW_USERS.get(k.name);
    if (!raw) continue;
    let user;
    try {
      user = JSON.parse(raw);
    } catch {
      continue;
    }
    if (norm(user.email) === target || norm(user.mailing?.primary) === target) {
      return user;
    }
  }
  return null;
}
__name(findUserByEmail, "findUserByEmail");

// workers/user/logic/registerUser.js
async function registerUserHandler(request, env) {
  const body = await request.json();
  const { email, firstname, lastname, password } = body;
  if (!email) return json({ error: "Missing email" }, 400);
  if (!password) return json({ error: "Missing password" }, 400);
  const existing = await findUserByEmail(env, email);
  if (existing) return json({ error: "Email already registered" }, 409);
  const id = crypto.randomUUID();
  const user = createDefaultUser(id);
  user.email = email;
  user.mailing.primary = email;
  user.firstname = firstname || "";
  user.lastname = lastname || "";
  user.password = password;
  await saveUser(env, id, user);
  return json({ ok: true, user });
}
__name(registerUserHandler, "registerUserHandler");

// workers/user/logic/deleteUser.js
async function deleteUser(env, id) {
  if (!id) return json({ error: "Missing id" }, 400);
  await env.AGW_USERS.delete(`user:${id}`);
  return json({ deleted: true });
}
__name(deleteUser, "deleteUser");

// workers/security/verifyPassword.js
async function verifyPassword(password, hash, salt) {
  const encoder = new TextEncoder();
  const saltBytes = Uint8Array.from(atob(salt), (c) => c.charCodeAt(0));
  const hashBytes = Uint8Array.from(atob(hash), (c) => c.charCodeAt(0));
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    encoder.encode(password),
    { name: "PBKDF2" },
    false,
    ["deriveBits", "deriveKey"]
  );
  const key = await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: saltBytes,
      iterations: 2e5,
      hash: "SHA-256"
    },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    true,
    ["encrypt", "decrypt"]
  );
  const rawKey = new Uint8Array(await crypto.subtle.exportKey("raw", key));
  return crypto.subtle.timingSafeEqual ? crypto.subtle.timingSafeEqual(rawKey, hashBytes) : rawKey.every((b, i) => b === hashBytes[i]);
}
__name(verifyPassword, "verifyPassword");

// workers/sessions/createSession.js
async function createSession(env, userId, role = "user") {
  const sessionId = crypto.randomUUID();
  const data = {
    userId,
    role,
    createdAt: Date.now()
  };
  await env.AGW_SESSIONS.put(`sess:${sessionId}`, JSON.stringify(data), {
    expirationTtl: 60 * 60 * 24 * 30
  });
  return sessionId;
}
__name(createSession, "createSession");

// workers/user/logic/loginUser.js
async function loginUser(env, body) {
  const { email, password } = body;
  if (!email || !password)
    return json({ ok: false, error: "Missing credentials" }, 400);
  const user = await findUserByEmail(env, email);
  if (!user)
    return json({ ok: false, error: "EMAIL_NOT_FOUND" }, 404);
  const match = await verifyPassword(password, user.password_hash, user.password_salt);
  if (!match)
    return json({ ok: false, error: "WRONG_PASSWORD" }, 401);
  if (user.status?.suspended)
    return json({ ok: false, error: "ACCOUNT_SUSPENDED" }, 403);
  const sessionId = await createSession(env, user.id, "user");
  return json({
    ok: true,
    sessionId,
    user: {
      id: user.id,
      email: user.email,
      firstname: user.firstname,
      lastname: user.lastname
    }
  });
}
__name(loginUser, "loginUser");

// workers/user/logic/requestPasswordReset.js
async function requestPasswordReset(env, email) {
  const user = await findUserByEmail(env, email);
  if (!user) {
    return { ok: true };
  }
  const token = crypto.randomUUID();
  const expiresAt = Date.now() + 15 * 60 * 1e3;
  user.password_reset = {
    token,
    expires_at: expiresAt
  };
  await saveUser(env, user.id, user);
  return {
    ok: true,
    reset_token: token
    // solo per dev, da togliere in prod
  };
}
__name(requestPasswordReset, "requestPasswordReset");

// workers/user/logic/resetPassword.js
async function resetPassword(env, token, newPassword) {
  const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
  let targetUser = null;
  for (const k of keys) {
    if (k.name === "user:index") continue;
    const raw = await env.AGW_USERS.get(k.name);
    if (!raw) continue;
    let u;
    try {
      u = JSON.parse(raw);
    } catch {
      continue;
    }
    if (u.password_reset?.token === token) {
      targetUser = u;
      break;
    }
  }
  if (!targetUser) {
    return { ok: false, error: "Invalid token", status: 400 };
  }
  if (targetUser.password_reset.expires_at < Date.now()) {
    return { ok: false, error: "Token expired", status: 400 };
  }
  targetUser.password = newPassword;
  targetUser.password_reset = {
    token: null,
    expires_at: null
  };
  await saveUser(env, targetUser.id, targetUser);
  return { ok: true };
}
__name(resetPassword, "resetPassword");

// workers/user/logic/evaluateWeeklyBonus.js
function evaluateWeeklyBonus(dailyCount) {
  if (dailyCount >= 15)
    return {
      award: "ADVANCED",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  if (dailyCount >= 8)
    return {
      award: "COMFORT",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  if (dailyCount >= 5)
    return {
      award: "BASIC",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  return {
    award: null,
    days: 0,
    expiresAt: null
  };
}
__name(evaluateWeeklyBonus, "evaluateWeeklyBonus");

// workers/user/route.js
function userRoutes(url, method, request, env) {
  if (url.pathname === "/api/user/login" && method === "POST") {
    return (async () => {
      const body = await request.json();
      const result = await loginUser(env, body);
      const status = result?.status ?? (result.error ? 400 : 200);
      return json(result, status);
    })();
  }
  if (url.pathname === "/api/user/request-password-reset" && method === "POST") {
    return (async () => {
      const { email } = await request.json();
      const result = await requestPasswordReset(env, email);
      return json(result);
    })();
  }
  if (url.pathname === "/api/user/reset-password" && method === "POST") {
    return (async () => {
      const { token, new_password } = await request.json();
      const result = await resetPassword(env, token, new_password);
      return json(result, result.ok ? 200 : 400);
    })();
  }
  if (url.pathname === "/api/user/register" && method === "POST") {
    return registerUserHandler(request, env);
  }
  if (url.pathname === "/api/user/get" && method === "POST") {
    return (async () => {
      const { id } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      return json(user);
    })();
  }
  if (url.pathname === "/api/user/add-day" && method === "POST") {
    return (async () => {
      const { id } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      user.stats.dayPurchasesLast7Days = (user.stats.dayPurchasesLast7Days || 0) + 1;
      const daily = user.stats.dayPurchasesLast7Days;
      const bonus = evaluateWeeklyBonus(daily);
      if (bonus.award) {
        user.bonus = bonus;
        user.subscription = {
          type: bonus.award,
          expiresAt: bonus.expiresAt
        };
      }
      await saveUser(env, id, user);
      return json(user);
    })();
  }
  if (url.pathname === "/api/user/apply-bonus" && method === "POST") {
    return (async () => {
      const { id, dailyCount } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      const count = Number(dailyCount ?? 0);
      const bonus = evaluateWeeklyBonus(count);
      user.bonus = bonus;
      if (bonus.award) {
        user.subscription = {
          type: bonus.award,
          expiresAt: bonus.expiresAt
        };
      }
      user.stats.dayPurchasesLast7Days = count;
      await saveUser(env, id, user);
      return json(user);
    })();
  }
  if (url.pathname === "/api/admin/user/delete" && method === "POST") {
    return deleteUser(request, env);
  }
  if (url.pathname === "/api/user/update-avatar" && method === "POST") {
    return (async () => {
      const { userId, avatarBase64 } = await request.json();
      if (!userId) return json({ error: "Missing userId" }, 400);
      const user = await getUser(env, userId);
      if (!user) return json({ error: "User not found" }, 404);
      user.profile_image = avatarBase64;
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-profile" && method === "POST") {
    return (async () => {
      const { userId, data } = await request.json();
      if (!userId) return json({ error: "Missing userId" }, 400);
      const user = await getUser(env, userId);
      if (!user) return json({ error: "Not found" }, 404);
      user.firstname = data.firstname || user.firstname;
      user.lastname = data.lastname || user.lastname;
      user.nickname = data.nickname || user.nickname;
      user.personal = { ...user.personal, ...data.personal };
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-email-prefs" && method === "POST") {
    return (async () => {
      const { userId, prefs } = await request.json();
      const user = await getUser(env, userId);
      if (!user) return json({ error: "Not found" }, 404);
      user.mailing.preferences = {
        ...user.mailing.preferences,
        ...prefs
      };
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-password" && method === "POST") {
    return (async () => {
      const { userId, oldPassword, newPassword } = await request.json();
      const user = await getUser(env, userId);
      if (!user) return json({ error: "User not found" }, 404);
      if (user.password !== oldPassword) {
        return json({ error: "Old password incorrect" }, 403);
      }
      user.password = newPassword;
      await saveUser(env, userId, user);
      return json({ ok: true });
    })();
  }
  return null;
}
__name(userRoutes, "userRoutes");

// workers/admin/getAdmin.js
async function getAdmin(env, email) {
  const { keys } = await env.AGW_ADMIN.list({ prefix: "admin:" });
  for (const k of keys) {
    const raw = await env.AGW_ADMIN.get(k.name);
    if (!raw) continue;
    const admin = JSON.parse(raw);
    if (admin.email.toLowerCase() === email.toLowerCase()) {
      return admin;
    }
  }
  return null;
}
__name(getAdmin, "getAdmin");

// workers/admin/createAdminSession.js
async function createAdminSession(env, adminId) {
  const sessionId = crypto.randomUUID();
  const expiresAt = Date.now() + 1e3 * 60 * 60 * 24;
  const payload = {
    adminId,
    createdAt: Date.now(),
    expiresAt
  };
  await env.AGW_ADMIN_SESSIONS.put(`session:${sessionId}`, JSON.stringify(payload));
  return sessionId;
}
__name(createAdminSession, "createAdminSession");

// workers/admin/loginAdmin.js
async function loginAdmin(env, email, password) {
  const admin = await getAdmin(env, email);
  if (!admin) {
    return { ok: false, error: "ADMIN_NOT_FOUND", status: 404 };
  }
  if (admin.password !== password) {
    return { ok: false, error: "WRONG_PASSWORD", status: 401 };
  }
  const sessionId = await createAdminSession(env, admin.id);
  return { ok: true, sessionId, admin };
}
__name(loginAdmin, "loginAdmin");

// workers/admin/logoutAdminSession.js
async function logoutAdmin(env, sessionId) {
  await env.AGW_ADMIN_SESSIONS.delete(`session:${sessionId}`);
  return true;
}
__name(logoutAdmin, "logoutAdmin");

// workers/admin/verifyAdminSession.js
async function verifyAdminSession(env, sessionId) {
  const raw = await env.AGW_ADMIN_SESSIONS.get(`session:${sessionId}`);
  if (!raw) return null;
  const session = JSON.parse(raw);
  if (session.expiresAt < Date.now()) {
    await env.AGW_ADMIN_SESSIONS.delete(`session:${sessionId}`);
    return null;
  }
  return session;
}
__name(verifyAdminSession, "verifyAdminSession");

// workers/api.js
var api_default = {
  async fetch(request, env, ctx) {
    try {
      const url = new URL(request.url);
      const method = request.method;
      const userResult = userRoutes(url, method, request, env);
      if (userResult) return userResult;
      if (method === "OPTIONS") {
        return new Response(null, { status: 204, headers: cors() });
      }
      if (url.pathname === "/api/admin/login" && method === "POST") {
        const { email, password } = await request.json();
        const result = await loginAdmin(env, email, password);
        if (!result.ok) {
          return json(result, result.status ?? 400);
        }
        return json({
          ok: true,
          sessionId: result.sessionId,
          admin: result.admin
        });
      }
      if (url.pathname === "/api/admin/logout" && method === "POST") {
        const { sessionId } = await request.json();
        await logoutAdmin(env, sessionId);
        return json({ ok: true });
      }
      if (url.pathname === "/api/admin/me" && method === "POST") {
        const { sessionId } = await request.json();
        const session = await verifyAdminSession(env, sessionId);
        return json({ ok: !!session, session });
      }
      async function requireAdminSession() {
        const { sessionId } = await request.json();
        const session = await verifyAdminSession(env, sessionId);
        if (!session) return null;
        return session;
      }
      __name(requireAdminSession, "requireAdminSession");
      if (url.pathname === "/api/admin/overview" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
        let totalUsers = 0;
        let subs = 0;
        let bonuses = 0;
        let krm = 0;
        let day = 0;
        let missions = 0;
        for (const k of keys) {
          if (k.name === "user:index") continue;
          const raw = await env.AGW_USERS.get(k.name);
          if (!raw) continue;
          const user = JSON.parse(raw);
          totalUsers++;
          if (user.subscription?.type) subs++;
          if (user.bonus?.award) bonuses++;
          krm += user.stats?.krm_total ?? 0;
          missions += user.stats?.missions_completed_total ?? 0;
          day += user.stats?.dayPurchasesLast7Days ?? 0;
        }
        return json({
          totalUsers,
          activeSubscriptions: subs,
          activeBonuses: bonuses,
          totalKRM: krm,
          totalDay: day,
          totalMissions: missions
        });
      }
      if (url.pathname === "/api/admin/users/list" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
        const users = [];
        for (const k of keys) {
          if (k.name === "user:index") continue;
          const raw = await env.AGW_USERS.get(k.name);
          if (!raw) continue;
          try {
            const user = JSON.parse(raw);
            if (user?.id) users.push(user);
          } catch {
          }
        }
        return json({ users });
      }
      if (url.pathname === "/api/admin/user/create" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        let index = Number(await env.AGW_USERS.get("user:index") || 0);
        index++;
        await env.AGW_USERS.put("user:index", String(index));
        const id = crypto.randomUUID();
        const user = {
          id,
          index,
          nickname: `user${index}`,
          firstname: `name${index}`,
          lastname: `lastname${index}`,
          email: `name${index}.lastname${index}@mail.com`,
          password: "_" + index,
          stats: { level_total: 1 }
        };
        await env.AGW_USERS.put(`user:${id}`, JSON.stringify(user));
        return json(user);
      }
      if (url.pathname === "/api/admin/user/update" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { id, field, value } = body;
        const user = await getUser(env, id);
        if (!user) return json({ error: "User not found" }, 404);
        if (field === "delete") {
          return deleteUser(env, id);
        }
        if (field === "krm") user.stats.krm_total = Number(value);
        if (field === "level") user.stats.level_total = Number(value);
        if (field === "suspend") user.status.suspended = true;
        if (field === "unsuspend") user.status.suspended = false;
        await saveUser(env, id, user);
        return json(user);
      }
      return new Response("Not found", {
        status: 404,
        headers: cors()
      });
    } catch (err) {
      return json({ error: "Internal Error", detail: err?.message }, 500);
    }
  }
};

// ../../../../../.nvm/versions/node/v22.18.0/lib/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts
var drainBody = /* @__PURE__ */ __name(async (request, env, _ctx, middlewareCtx) => {
  try {
    return await middlewareCtx.next(request, env);
  } finally {
    try {
      if (request.body !== null && !request.bodyUsed) {
        const reader = request.body.getReader();
        while (!(await reader.read()).done) {
        }
      }
    } catch (e) {
      console.error("Failed to drain the unused request body.", e);
    }
  }
}, "drainBody");
var middleware_ensure_req_body_drained_default = drainBody;

// ../../../../../.nvm/versions/node/v22.18.0/lib/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts
function reduceError(e) {
  return {
    name: e?.name,
    message: e?.message ?? String(e),
    stack: e?.stack,
    cause: e?.cause === void 0 ? void 0 : reduceError(e.cause)
```

├─ app/admin/analytics/page.tsx
```
//admin/analytics/page.tsx
"use client";

import { Suspense } from "react";
import { useSearchParams } from "next/navigation";

export default function AnalyticsWrapper() {
  return (
    <Suspense fallback={<p className="admin-muted p-6">Caricamento...</p>}>
      <AnalyticsPage />
    </Suspense>
  );
}

function AnalyticsPage() {

  return (
    <div className="space-y-6">
      <h1 className="text-2xl admin-title">Analitiche Avanzate</h1>

      <div className="admin-card space-y-3">
        <p className="admin-muted">Statistiche e trend della piattaforma:</p>

        <ul className="admin-muted list-disc pl-4">
          <li>Crescita utenti</li>
          <li>Retention settimanale / mensile</li>
          <li>Day acquistati nel tempo</li>
          <li>Missioni completate</li>
          <li>Andamento KRM</li>
        </ul>
      </div>
    </div>
  );
}
```

├─ app/admin/components/AdminSidebar.tsx
```
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import {
  LayoutDashboard,
  Users,
  BadgeCheck,
  Target,
  BarChart3,
  Settings,
} from "lucide-react";

export default function AdminSidebar() {
  const pathname = usePathname();

  const items = [
    { label: "Overview", path: "/admin", icon: LayoutDashboard },
    { label: "Users", path: "/admin/users", icon: Users },
    { label: "Subscriptions", path: "/admin/subscriptions", icon: BadgeCheck },
    { label: "Missions", path: "/admin/missions", icon: Target },
    { label: "Analytics", path: "/admin/analytics", icon: BarChart3 },
    { label: "System", path: "/admin/system", icon: Settings },
  ];

  return (
    <aside className="w-64 admin-sidebar min-h-screen p-4 space-y-6">
      <h2 className="text-2xl font-bold text-[hsl(var(--agw-gold))]">
        AGW Admin
      </h2>

      <nav className="space-y-1">
        {items.map((item) => {
          const Icon = item.icon;
          const active = pathname === item.path;

          return (
            <Link
              key={item.path}
              href={item.path}
              className={`flex items-center gap-3 px-3 py-2 rounded-md transition
                ${
                  active
                    ? "bg-[hsl(var(--agw-gold))] text-black font-semibold"
                    : "text-neutral-300 hover:text-white hover:bg-neutral-800"
                }`}
            >
              <Icon size={18} />
              <span>{item.label}</span>
            </Link>
          );
        })}
      </nav>
    </aside>
  );
}
```

├─ app/admin/components/AdminTopbar.tsx
```
"use client";

import { ShieldCheck, Wifi, Database, LogOut } from "lucide-react";
import { useRouter } from "next/navigation";

export default function AdminTopbar() {
  const router = useRouter();

  function logout() {
    router.push("/admin/logout");
  }

  return (
    <header className="admin-topbar w-full px-6 py-4 flex justify-between items-center shadow-sm">
      {/* LEFT */}
      <div className="flex items-center gap-3">
        <ShieldCheck size={20} className="text-[hsl(var(--agw-gold))]" />
        <h1 className="text-lg font-semibold text-[hsl(var(--agw-gold))] tracking-wide">
          AGW Admin Panel
        </h1>

        <span className="px-2 py-1 text-xs rounded-md bg-[hsl(var(--agw-gold))] text-black ml-2">
          ADMIN
        </span>
      </div>

      {/* RIGHT */}
      <div className="flex items-center gap-6">
        <div className="flex items-center gap-1 text-neutral-400 text-sm">
          <Wifi size={16} className="text-green-400" />
          Online
        </div>

        <div className="flex items-center gap-1 text-neutral-400 text-sm">
          <Database size={16} className="text-blue-400" />
          KV OK
        </div>

        <button
          onClick={logout}
          className="flex items-center gap-2 px-3 py-1 rounded-md admin-btn admin-btn-danger hover:opacity-90"
        >
          <LogOut size={16} />
          Logout
        </button>
      </div>
    </header>
  );
}
```

├─ app/admin/layout.tsx
```
"use client";

import type { ReactNode } from "react";
import AdminSidebar from "./components/AdminSidebar";
import AdminTopbar from "./components/AdminTopbar";

interface AdminLayoutProps {
  children: ReactNode;
}

export default function AdminLayout({ children }: AdminLayoutProps) {
  return (
    <div className="admin-theme min-h-screen flex">
      <AdminSidebar />

      <div className="flex flex-col flex-1 min-h-screen">
        <AdminTopbar />

        <main className="p-6 flex-1">
          {children}
        </main>
      </div>
    </div>
  );
}
```

├─ app/admin/login/page.tsx
```
"use client";

import { useState } from "react";

export default function AdminLoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  async function handleLogin(e: React.FormEvent) {
    e.preventDefault();
    setError("");

    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });

    const data = await res.json();

    if (!res.ok) {
      setError(data.error || "Errore login");
      return;
    }

    window.location.href = "/admin";
  }

  return (
    <main className="min-h-screen flex items-center justify-center bg-black">
      <form
        onSubmit={handleLogin}
        className="bg-neutral-900 p-8 rounded-xl shadow-xl w-full max-w-md space-y-4"
      >
        <h1 className="text-2xl text-[hsl(var(--agw-gold))] font-bold text-center">
          Admin Login
        </h1>

        {error && (
          <p className="text-red-500 text-center">{error}</p>
        )}

        <input
          className="admin-input w-full"
          type="email"
          placeholder="Email admin"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
        />

        <input
          className="admin-input w-full"
          type="password"
          placeholder="Password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
        />

        <button
          type="submit"
          className="admin-btn admin-btn-gold w-full"
        >
          Entra
        </button>
      </form>
    </main>
  );
}
```

├─ app/admin/logout/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST() {
  const cookieStore = await cookies();
  const sessionId = cookieStore.get("agw_admin_session")?.value;

  // invalida sessione nel backend
  await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/logout`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sessionId })
  });

  // elimina cookie
  cookieStore.set("agw_admin_session", "", {
    httpOnly: true,
    secure: true,
    path: "/",
    expires: new Date(0),
  });

  return NextResponse.redirect("/admin/login");
}
```

├─ app/admin/me/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function GET() {
  const cookieStore = await cookies();
  const sessionId = cookieStore.get("agw_admin_session")?.value;

  if (!sessionId) {
    return NextResponse.json({ ok: false });
  }

  const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/me`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sessionId })
  });

  const data = await res.json();
  return NextResponse.json(data);
}
```

├─ app/admin/missions/page.tsx
```
"use client";

export default function AdminMissions() {
  return (
    <div className="space-y-6">
      <h1 className="text-2xl admin-title">Gestione Missioni</h1>

      <div className="admin-card space-y-3">
        <p className="admin-muted">Controlla e gestisci le missioni globali:</p>
        <ul className="admin-muted list-disc pl-4">
          <li>Lista missioni</li>
          <li>Creazione / Modifica / Rimozione</li>
          <li>Missioni attive</li>
          <li>Completamenti sospetti</li>
        </ul>
      </div>
    </div>
  );
}
```

├─ app/admin/page.tsx
```
"use client";

import { useEffect, useState } from "react";

export default function AdminHome() {
  const [valid, setValid] = useState<boolean | null>(null);
  const [overview, setOverview] = useState<any>(null);

  // Recupera sessione admin dal browser
  const sessionId =
    typeof window !== "undefined"
      ? localStorage.getItem("agw_admin_session")
      : null;

  async function validate() {
    if (!sessionId) {
      setValid(false);
      return;
    }

    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/me`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId })
    });

    const data = await res.json();

    setValid(data.ok === true);

    if (data.ok) {
      await loadOverview();
    }
  }

  async function loadOverview() {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/overview`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId })
    });

    const data = await res.json();
    setOverview(data);
  }

  useEffect(() => {
    validate();
  }, []);

  if (valid === null)
    return <p className="admin-muted p-6">Verifica in corso...</p>;

  if (!valid)
    return (
      <div className="admin-card p-6">
        <p className="admin-btn-danger p-2 rounded-md text-center">
          Accesso negato
        </p>
      </div>
    );

  if (!overview)
    return <p className="admin-muted p-6">Caricamento dati...</p>;

  return (
    <div className="space-y-8">
      <h1 className="text-3xl admin-title">Admin Dashboard AGW</h1>

      <div className="admin-card space-y-6">
        <h2 className="text-xl admin-title">Panoramica Sistema</h2>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <Stat label="Utenti totali" value={overview.totalUsers} />
          <Stat label="Abbonamenti attivi" value={overview.activeSubscriptions} />
          <Stat label="Bonus attivi" value={overview.activeBonuses} />
          <Stat label="KRM totali generati" value={overview.totalKRM} />
          <Stat label="Day acquistati" value={overview.totalDay} />
          <Stat label="Missioni completate" value={overview.totalMissions} />
        </div>
      </div>
    </div>
  );
}

function Stat({ label, value }: any) {
  return (
    <div className="admin-stat space-y-1">
      <p className="admin-muted">{label}</p>
      <p className="admin-stat-value">{value}</p>
    </div>
  );
}
```

├─ app/admin/src/types/Users.ts
```typescript
export interface User {
    id: string;
    index: number;
  
    nickname: string;
    firstname: string;
    lastname: string;
    email: string;
    password: string;
    phone: string | null;
  
    profile_image: string | null;
    avatar_ai: string | null;
  
    mailing: {
      primary: string;
      secondary: string | null;
      verified: boolean;
      verification_sent_at: number | null;
      verified_at: number | null;
      preferences: {
        newsletter: boolean;
        missions: boolean;
        rewards: boolean;
        billing: boolean;
        security: boolean;
      };
      status: {
        bounced: boolean;
        soft_bounce_count: number;
        hard_bounce: boolean;
        unsubscribe: boolean;
        unsubscribe_at: number | null;
      };
      log: any[];
    };
  
    personal: {
      birthdate: string | null;
      weight: number | null;
      height: number | null;
      gender: string | null;
      job: string | null;
    };
  
    status: {
      suspended: boolean;
      createdAt: number;
    };
  
    stats: {
      level_total: number;
      level_year: number;
      rank_month: number;
      motivation_week: number;
      assessment_day: number;
  
      krm_total: number;
      krm_year: number;
      krm_month: number;
      krm_week: number;
      krm_day: number;
  
      missions_completed_total: number;
      missions_completed_month: number;
      missions_completed_week: number;
      missions_completed_today: number;
    };
  
    discipline: {
      daily_completed: number;
      daily_goal: number;
      weekly_completed: number;
      weekly_goal: number;
    };
  
    subscription: {
      type: string | null;
      renew_every: number;
      last_payment_at: number | null;
      payment_status: "green" | "orange" | "red" | null;
      expires_at: number | null;
    };
  
    bonus: {
      award: string | null;
      expiresAt: number | null;
      days?: number;
    } | null;
  
    missions: {
      status: "approved" | "pending" | "rejected";
      [k: string]: any;
    }[];
  
    delta7?: number;
  }
  ```

├─ app/admin/subscriptions/page.tsx
```
"use client";

export default function AdminSubscriptions() {
  return (
    <div className="space-y-6">
      <h1 className="text-2xl admin-title">Gestione Abbonamenti</h1>

      <div className="admin-card space-y-3">
        <p className="admin-muted">Qui potrai vedere e gestire:</p>
        <ul className="admin-muted list-disc pl-4">
          <li>Abbonamenti attivi</li>
          <li>Data scadenza</li>
          <li>Rinnovi manuali</li>
          <li>Anomalie abbonamenti</li>
        </ul>
      </div>
    </div>
  );
}
```

├─ app/admin/system/page.tsx
```
"use client";

export default function AdminSystem() {
  return (
    <div className="space-y-6">
      <h1 className="text-2xl admin-title">Controllo Sistema</h1>

      <div className="admin-card space-y-3">
        <p className="admin-muted">Strumenti e diagnostica:</p>
        <ul className="admin-muted list-disc pl-4">
          <li>Test API</li>
          <li>Stato KV</li>
          <li>Logs Worker</li>
          <li>Reset Bonus settimanale</li>
          <li>Health-check</li>
          <li>Sicurezza</li>
        </ul>
      </div>
    </div>
  );
}
```

├─ app/admin/users/UserTable.tsx
```
"use client";

import { useState } from "react";
import Image from "next/image";

export default function UserTable({ users }: { users: any[] }) {
  const [search, setSearch] = useState("");
  const [selected, setSelected] = useState<string[]>([]);

  const safeUsers = Array.isArray(users) ? users : [];

  const filtered = safeUsers.filter((u) =>
    JSON.stringify(u).toLowerCase().includes(search.toLowerCase())
  );

  function toggle(id: string) {
    setSelected((prev) =>
      prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id]
    );
  }

  async function handleBulkDelete() {
    if (!confirm(`Eliminare ${selected.length} utenti?`)) return;

    for (const id of selected) {
      await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/user/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, field: "delete" })
      });
    }

    alert("Utenti eliminati");
    window.location.reload();
  }

  return (
    <div className="admin-card p-4 space-y-4 overflow-auto">
      <input
        className="admin-input"
        placeholder="Cerca..."
        value={search}
        onChange={(e) => setSearch(e.target.value)}
      />

      {selected.length > 0 && (
        <button
          onClick={handleBulkDelete}
          className="admin-btn admin-btn-danger"
        >
          Elimina selezionati ({selected.length})
        </button>
      )}

      <div className="overflow-auto">
        <table className="min-w-full text-sm text-left border-collapse">
          <thead>
            <tr>
              <Th></Th>
              <Th>Edit</Th>
              <Th>Delete</Th>
              <Th>ID</Th>
              <Th>Email</Th>
              <Th>Name</Th>
              <Th>Status</Th>
            </tr>
          </thead>

          <tbody>
            {filtered.map((user) => (
              <tr key={user.id}>
                <Td>
                  <input
                    type="checkbox"
                    checked={selected.includes(user.id)}
                    onChange={() => toggle(user.id)}
                  />
                </Td>

                <Td>
                  <a
                    href={`/admin/users/${user.id}/edit`}
                    className="admin-btn admin-btn-blue text-xs"
                  >
                    Edit
                  </a>
                </Td>

                <Td>
                  <button
                    className="admin-btn admin-btn-danger text-xs"
                    onClick={async () => {
                      if (!confirm(`Eliminare ${user.email}?`)) return;

                      await fetch(
                        `${process.env.NEXT_PUBLIC_API_URL}/api/admin/user/update`,
                        {
                          method: "POST",
                          headers: { "Content-Type": "application/json" },
                          body: JSON.stringify({
                            id: user.id,
                            field: "delete"
                          })
                        }
                      );

                      alert("Utente eliminato");
                      window.location.reload();
                    }}
                  >
                    Delete
                  </button>
                </Td>

                <Td>{user.id}</Td>
                <Td>{user.email}</Td>
                <Td>{user.firstname} {user.lastname}</Td>
                <Td>{user.status?.suspended ? "Sospeso" : "Attivo"}</Td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function Th({ children }: any) {
  return (
    <th className="px-3 py-2 font-semibold text-[var(--admin-gold)] whitespace-nowrap">
      {children}
    </th>
  );
}

function Td({ children }: any) {
  return <td className="px-3 py-2 whitespace-nowrap">{children}</td>;
}
```

├─ app/admin/users/[id]/edit/page.tsx
```
"use client";
import type { User } from "app/admin/src/types/Users";

import { useEffect, useState } from "react";
import { useParams, useSearchParams } from "next/navigation";

/* ============================================================================
   PAGE: ADMIN — EDIT USER
   Gestisce profilo, mailing, stats, subscription, bonus,
   discipline, avatar, delete, e ora anche RESET PASSWORD.
============================================================================ */

export default function EditUser() {
  const { id } = useParams();
  const params = useSearchParams();
  const token = params.get("token");

  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [msg, setMsg] = useState("");

  // ==========================================================
  // FETCH USER
  // ==========================================================
  async function load() {
    setLoading(true);

    const res = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL}/api/user/get`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      }
    );

    const data = await res.json();
    setUser(data.error ? null : data);
    setLoading(false);
  }

  // ==========================================================
  // GENERIC UPDATE (deep field edit)
  // ==========================================================
  async function update(field: string, value: any) {
    if (!user) return;

    setSaving(true);
    setMsg("");

    const newUser = { ...user };

    const parts = field.split(".");
    let pointer: any = newUser;

    for (let i = 0; i < parts.length - 1; i++) {
      pointer = pointer[parts[i]];
    }

    pointer[parts[parts.length - 1]] = value;

    const res = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL}/api/admin/user/save`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token,
          id,
          userData: newUser
        })
      }
    );

    const data = await res.json();

    if (data.error) {
      setMsg("❌ " + data.error);
      setSaving(false);
      return;
    }

    setUser(data.user);
    setMsg("✔ Saved");
    setSaving(false);
  }

  // load user
  useEffect(() => {
    if (token) load();
  }, [token]);

  // ==========================================================
  // RENDER STATES
  // ==========================================================
  if (!token) return <p className="admin-muted p-6">Missing token</p>;
  if (loading) return <p className="p-6 admin-muted">Loading...</p>;
  if (!user) return <p className="p-6 text-red-400">User not found</p>;

  // ==========================================================
  // PAGE JSX
  // ==========================================================
  return (
    <div className="space-y-8">

      <h1 className="admin-title text-3xl font-bold">
        Editing User #{user.index} — {user.nickname}
      </h1>
      <p className="admin-muted">{msg}</p>

      {/* ======================================================
         AVATAR + BASIC INFO
      ====================================================== */}
      <section className="admin-card p-6 space-y-4">
        <h2 className="admin-title text-xl">Avatar & Identity</h2>

        <div className="flex items-center gap-6">
          <img
            src={user.profile_image || user.avatar_ai || "/default-avatar.png"}
            className="w-24 h-24 rounded-full object-cover border border-[var(--admin-border)]"
          />

          <div className="flex flex-col gap-3">
            <p className="admin-muted text-sm">
              Profile image + AI avatar management coming soon
            </p>

            <button className="admin-btn admin-btn-blue opacity-60 cursor-not-allowed">
              Upload Profile Image (soon)
            </button>
            <button className="admin-btn admin-btn-gold opacity-60 cursor-not-allowed">
              Generate AI Avatar (soon)
            </button>
          </div>
        </div>

        <Field label="Nickname" value={user.nickname} update={(v)=>update("nickname", v)} />
        <Field label="First Name" value={user.firstname} update={(v)=>update("firstname", v)} />
        <Field label="Last Name" value={user.lastname} update={(v)=>update("lastname", v)} />

      </section>

      {/* ======================================================
         PASSWORD RESET — NEW FEATURE
      ====================================================== */}
      <section className="admin-card p-6 space-y-4 border-red-300">
        <h2 className="admin-title text-xl">Reset Password</h2>

        <form
          action="/api/auth/admin-reset-password"
          method="POST"
          className="flex flex-col gap-3"
        >
          <input type="hidden" name="id" value={user.id} />
          <input type="hidden" name="token" value={token} />

          <input
            type="password"
            name="new_password"
            placeholder="Nuova password"
            className="admin-input"
          />

          <input
            type="password"
            name="confirm_password"
            placeholder="Conferma password"
            className="admin-input"
          />

          <button className="admin-btn admin-btn-blue">
            Aggiorna password
          </button>
        </form>
      </section>

      {/* ======================================================
         MAILING
      ====================================================== */}
      <section className="admin-card p-6 space-y-4">
        <h2 className="admin-title text-xl">Mailing / Contact</h2>

        <Field label="Primary Email" value={user.mailing.primary} update={(v)=>update("mailing.primary", v)} />
        <Field label="Secondary Email" value={user.mailing.secondary} update={(v)=>update("mailing.secondary", v)} />
        <Field label="Phone" value={user.phone} update={(v)=>update("phone", v)} />

        <div className="space-y-2">
          <label className="admin-muted text-sm">Verified?</label>
          <select
            className="admin-input"
            defaultValue={String(user.mailing.verified)}
            onChange={(e) => update("mailing.verified", e.target.value === "true")}
          >
            <option value="true">True</option>
            <option value="false">False</option>
          </select>
        </div>
      </section>

      {/* ======================================================
         PERSONAL
      ====================================================== */}
      <section className="admin-card p-6 space-y-4">
        <h2 className="admin-title text-xl">Personal Details</h2>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Field label="Birthdate" value={user.personal.birthdate} update={(v)=>update("personal.birthdate", v)} />
          <Field label="Gender" value={user.personal.gender} update={(v)=>update("personal.gender", v)} />
          <Field label="Job" value={user.personal.job} update={(v)=>update("personal.job", v)} />
          <Field label="Weight" value={user.personal.weight} update={(v)=>update("personal.weight", Number(v))} />
          <Field label="Height" value={user.personal.height} update={(v)=>update("personal.height", Number(v))} />
        </div>
      </section>

      {/* ======================================================
         STATS
      ====================================================== */}
      <section className="admin-card p-6 space-y-4">
        <h2 className="admin-title text-xl">Stats</h2>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <Field label="Level Total" value={user.stats.level_total} update={(v)=>update("stats.level_total", Number(v))} />
          <Field label="Level Year" value={user.stats.level_year} update={(v)=>update("stats.level_year", Number(v))} />
          <Field label="Rank Month" value={user.stats.rank_month} update={(v)=>update("stats.rank_month", Number(v))} />
          <Field label="Motivation Week" value={user.stats.motivation_week} update={(v)=>update("stats.motivation_week", Number(v))} />
          <Field label="KRM Total" value={user.stats.krm_total} update={(v)=>update("stats.krm_total", Number(v))} />
          <Field label="KRM Year" value={user.stats.krm_year} update={(v)=>update("stats.krm_year", Number(v))} />
          <Field label="KRM Month" value={user.stats.krm_month} update={(v)=>update("stats.krm_month", Number(v))} />
          <Field label="KRM Week" value={user.stats.krm_week} update={(v)=>update("stats.krm_week", Number(v))} />
          <Field label="KRM Day" value={user.stats.krm_day} update={(v)=>update("stats.krm_day", Number(v))} />
        </div>
      </section>

      {/* ======================================================
         DISCIPLINE
      ====================================================== */}
      <section className="admin-card p-6 space-y-4">
        <h2 className="admin-title text-xl">Discipline</h2>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <Field label="Daily Completed" value={user.discipline.daily_completed} update={(v)=>update("discipline.daily_completed", Number(v))} />
          <Field label="Daily Goal" value={user.discipline.daily_goal} update={(v)=>update("discipline.daily_goal", Number(v))} />
          <Field label="Weekly Completed" value={user.discipline.weekly_completed} update={(v)=>update("discipline.weekly_completed", Number(v))} />
          <Field label="Weekly Goal" value={user.discipline.weekly_goal} update={(v)=>update("discipline.weekly_goal", Number(v))} />
        </div>
      </section>

      {/* ======================================================
         SUBSCRIPTION
      ====================================================== */}
      <section className="admin-card p-6 space-y-4">
        <h2 className="admin-title text-xl">Subscription</h2>

        <Field label="Type" value={user.subscription.type} update={(v)=>update("subscription.type", v)} />
        <Field label="Payment Status" value={user.subscription.payment_status} update={(v)=>update("subscription.payment_status", v)} />
        <Field label="Expires At" value={user.subscription.expires_at} update={(v)=>update("subscription.expires_at", Number(v))} />

      </section>

      {/* ======================================================
         BONUS
      ====================================================== */}
      <section className="admin-card p-6 space-y-4">
        <h2 className="admin-title text-xl">Bonus</h2>

        <Field label="Award" value={user.bonus?.award} update={(v)=>update("bonus.award", v)} />
        <Field label="Expires" value={user.bonus?.expiresAt} update={(v)=>update("bonus.expiresAt", Number(v))} />

      </section>

      {/* ======================================================
         DELETE USER
      ====================================================== */}
      <div className="admin-card p-6">
        <button
          className="admin-btn admin-btn-danger"
          onClick={async () => {
            if (!confirm("Confermi l'eliminazione DEFINITIVA di questo utente?")) return;

            const res = await fetch(
              `${process.env.NEXT_PUBLIC_API_URL}/api/admin/user/update`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  token,
                  id: user.id,
                  field: "delete"
                }),
              }
            );

            const data = await res.json();

            if (data.deleted) {
              alert("Utente eliminato con successo.");
              window.location.href = `/admin/users?token=${token}`;
            } else {
              alert("Errore durante l'eliminazione.");
            }
          }}
        >
          Delete User
        </button>
      </div>

    </div>
  );
}

/* ============================================================================
   Reusable field component
============================================================================ */
type FieldProps<T> = {
  label: string;
  value: T;
  update: (v: T) => void;
};

function Field<T>({ label, value, update }: FieldProps<T>) {
  return (
    <div className="space-y-2">
      <label className="admin-muted text-sm">{label}</label>

      <input
        className="admin-input"
        defaultValue={value != null ? String(value) : ""}
        onBlur={(e) => {
          let v: any = e.target.value;
          if (typeof value === "number") v = Number(v);
          update(v as T);
        }}
      />
    </div>
  );
}
```

├─ app/admin/users/change-password/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  const { oldPassword, newPassword } = await req.json();


  if (!oldPassword || !newPassword) {
    return NextResponse.json({ error: "Missing fields" }, { status: 400 });
  }

  // FIX Next.js 16 (cookies async)
  const cookieStore = await cookies();
  const userId = cookieStore.get("agw_session")?.value;

  if (!userId) {
    return NextResponse.json(
      { error: "Not authenticated" },
      { status: 401 }
    );
  }

  const backendUrl =
    process.env.NEXT_PUBLIC_API_URL + "/api/user/update-password";

  const backendRes = await fetch(backendUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      oldPassword,
      newPassword,
    }),
  });

  const data = await backendRes.json();

  if (!backendRes.ok) {
    return NextResponse.json(data, { status: backendRes.status });
  }

  return NextResponse.json({ ok: true });
}
```

├─ app/admin/users/page.tsx
```
"use client";

import { Suspense, useEffect, useState } from "react";
import UserTable from "./UserTable";

export default function AdminUsersPage() {
  return (
    <Suspense fallback={<p className="admin-muted">Caricamento utenti...</p>}>
      <AdminUsers />
    </Suspense>
  );
}

function AdminUsers() {
  const [userList, setUserList] = useState<any[]>([]);
  const [searchId, setSearchId] = useState("");
  const [selectedUser, setSelectedUser] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const [msg, setMsg] = useState("");

  // =============================
  // LOAD USERS — NO TOKEN
  // =============================
  async function loadUserList() {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/users/list`, {
      method: "GET",
      cache: "no-store"
    });

    const data = await res.json();
    if (data.ok) {
      setUserList(data.users);
    } else {
      setMsg(data.error || "Errore di caricamento utenti");
    }
  }

  useEffect(() => {
    loadUserList();
  }, []);

  async function searchUser() {
    if (!searchId) return;

    setLoading(true);
    setMsg("");

    const res = await fetch(`/admin/api/user/get`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: searchId })
    });

    const data = await res.json();
    if (data.error) {
      setSelectedUser(null);
      setMsg(data.error);
    } else {
      setSelectedUser(data);
    }

    setLoading(false);
  }

  return (
    <div className="space-y-6">
      <h1 className="admin-title text-2xl font-bold">Gestione Utenti</h1>

      <button
        onClick={async () => {
          const res = await fetch(`/admin/api/user/create`, {
            method: "POST"
          });

          const data = await res.json();

          if (data.error) {
            alert("Errore creando utente: " + data.error);
            return;
          }

          window.location.href = `/admin/users/${data.id}/edit`;
        }}
        className="admin-btn admin-btn-gold"
      >
        + Create New User
      </button>

      <UserTable users={userList} />

      <div className="admin-card space-y-4">
        <p className="admin-muted">Cerca utente per ID:</p>

        <input
          className="admin-input"
          value={searchId}
          onChange={(e) => setSearchId(e.target.value)}
        />

        <button
          onClick={searchUser}
          className="admin-btn admin-btn-gold"
        >
          {loading ? "Ricerca..." : "Cerca"}
        </button>

        {msg && <p className="admin-muted">{msg}</p>}
      </div>

      {selectedUser && (
        <div className="admin-card">
          <p className="admin-title">User loaded</p>
        </div>
      )}
    </div>
  );
}
```

├─ app/admin/users/update-avatrar/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  const cookieStore = await cookies();
  const userId = cookieStore.get("agw_session")?.value;

  if (!userId)
    return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const { avatarBase64 } = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/update-avatar`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, avatarBase64 }),
    }
  );

  const data = await backend.json();
  return NextResponse.json(data, { status: backend.status });
}
```

├─ app/admin/users/update-email-prefs/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  const cookieStore = await cookies();
  const userId = cookieStore.get("agw_session")?.value;

  if (!userId)
    return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const { prefs } = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/update-email-prefs`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, prefs }),
    }
  );

  const data = await backend.json();
  return NextResponse.json(data, { status: backend.status });
}
```

├─ app/admin/users/update-password/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  const cookieStore = await cookies();
  const userId = cookieStore.get("agw_session")?.value;

  if (!userId)
    return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const { oldPassword, newPassword } = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/update-password`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, oldPassword, newPassword }),
    }
  );

  const data = await backend.json();
  return NextResponse.json(data, { status: backend.status });
}
```

├─ app/admin/users/update-profile/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  try {
    const cookieStore = await cookies();
    const userId = cookieStore.get("agw_session")?.value;

    if (!userId)
      return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

    const body = await req.json();

    const backend = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL}/api/user/update-profile`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId, data: body }),
      }
    );

    const data = await backend.json();
    return NextResponse.json(data, { status: backend.status });
  } catch (e) {
    return NextResponse.json({ error: "Server error" }, { status: 500 });
  }
}
```

├─ app/auth/do-reset/route.ts
```typescript
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  const body = await req.json();

  const apiUrl = process.env.NEXT_PUBLIC_API_URL!;
  const res = await fetch(`${apiUrl}/api/user/reset-password`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const data = await res.json();

  return NextResponse.json(data);
}
```

├─ app/auth/login/route.ts
```typescript
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  try {
    const { email, password } = await req.json();

    const backendRes = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/user/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    // Email non esiste
    if (backendRes.status === 404) {
      return NextResponse.json(
        { error: "EMAIL_NOT_FOUND" },
        { status: 404 }
      );
    }

    let data;
try {
  data = await backendRes.json();
} catch {
  return NextResponse.json(
    { error: "INTERNAL_BACKEND_ERROR" },
    { status: 500 }
  );
}

    // Password errata
    if (!data.ok) {
      return NextResponse.json(
        { error: "WRONG_PASSWORD" },
        { status: 401 }
      );
    }

    // LOGIN OK → Imposta cookie di sessione
    const res = NextResponse.json({ ok: true});

    res.cookies.set("agw_session", data.sessionId, {
      httpOnly: true,
      secure: true,
      sameSite: "lax",
      path: "/"
    });

    return res;

  } catch (err: any) {
    return NextResponse.json(
      { error: "INTERNAL_ERROR" },
      { status: 500 }
    );
  }
}
```

├─ app/auth/logout/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST() {
  const cookieStore = await cookies();

  // Invalida sessione
  cookieStore.set("agw_session", "", {
    httpOnly: true,
    secure: true,
    sameSite: "lax",
    path: "/",
    expires: new Date(0),
  });

  // Next.js 16 → Redirect ASSOLUTO obbligatorio
  const baseUrl = process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000";
  const redirectUrl = `${baseUrl}/login`;

  return NextResponse.redirect(redirectUrl, {
    status: 302,
  });
}
```

├─ app/auth/me/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function GET() {
  const cookieStore = await cookies();
  const session = cookieStore.get("agw_session")?.value;

  if (!session) {
    return NextResponse.json({ ok: false });
  }

  const res = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/get`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: session })
    }
  );

  if (!res.ok) {
    return NextResponse.json({ ok: false });
  }

  const user = await res.json();

  return NextResponse.json({ ok: true, user });
}
```

├─ app/auth/register/route.ts
```typescript
import { NextRequest, NextResponse } from "next/server";

export async function POST(req: NextRequest) {
  const { email, firstname, lastname, password } = await req.json();

  if (!email || !firstname || !lastname || !password) {
    return NextResponse.json(
      { ok: false, error: "Missing fields" },
      { status: 400 }
    );
  }

  const apiUrl = process.env.NEXT_PUBLIC_API_URL;

  const backendRes = await fetch(`${apiUrl}/api/user/register`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, firstname, lastname, password }),
  });

  const data = await backendRes.json();

  if (data.error) {
    return NextResponse.json(
      { ok: false, error: data.error },
      { status: 400 }
    );
  }

  return NextResponse.json({ ok: true, user: data.user });
}
```

├─ app/auth/request-reset/route.ts
```typescript
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  const { email } = await req.json();

  const apiUrl = process.env.NEXT_PUBLIC_API_URL!;
  const res = await fetch(`${apiUrl}/api/user/request-password-reset`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  });

  const data = await res.json();

  return NextResponse.json(data);
}
```

├─ app/components/lib/apiClients.ts
```typescript
```

├─ app/components/lib/auth.ts
```typescript
```

├─ app/components/lib/session.ts
```typescript
```

├─ app/components/store/userStore.ts
```typescript
```

├─ app/dashboard/components/AvatarUploader.tsx
```
"use client";

import { useState } from "react";

export default function AvatarUploader({ user }: { user: any }) {
  const [preview, setPreview] = useState(user.profile_image);

  async function handleUpload(e: any) {
    const file = e.target.files[0];
    if (!file) return;

    const base64 = await toBase64(file);
    setPreview(base64);

    await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/user/update-avatar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: user.id, avatarBase64: base64 }),
    });

    alert("Avatar aggiornato");
  }

  function toBase64(file: File) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result as string);
      reader.readAsDataURL(file);
    });
  }

  return (
    <div className="p-6 bg-white rounded-xl shadow-md flex gap-4">
      <img
        src={preview || "/default-avatar.png"}
        className="w-24 h-24 rounded-full object-cover border"
      />

      <div>
        <h3 className="font-semibold mb-2">Avatar</h3>

        <input type="file" accept="image/*" onChange={handleUpload} />

        <p className="text-sm mt-2 text-gray-500">
          Carica un’immagine quadrata.
        </p>
      </div>
    </div>
  );
}
```

├─ app/dashboard/components/DisciplineCard.tsx
```
export default function DisciplineCard({ user }: any) {
    return (
      <div className="bg-white p-6 rounded-xl shadow-sm">
        <h2 className="text-xl font-semibold mb-3">Disciplina</h2>
  
        <div className="flex justify-between text-lg font-medium">
          <div>
            Giornaliero:
            {" "}
            {user.discipline.daily_completed}/{user.discipline.daily_goal}
          </div>
  
          <div>
            Settimanale:
            {" "}
            {user.discipline.weekly_completed}/{user.discipline.weekly_goal}
          </div>
        </div>
      </div>
    );
  }
  ```

├─ app/dashboard/components/EmailPreferences.tsx
```
"use client";

import { useState } from "react";

export default function EmailPreferences({
  prefs,
  userId,
}: {
  prefs: any;
  userId: string;
}) {
  const [state, setState] = useState(prefs);

  async function savePrefs() {
    const res = await fetch("/admin/user/update-email-prefs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, prefs: state }),
    });

    if (!res.ok) {
      alert("Errore aggiornamento preferenze email");
      return;
    }

    alert("Preferenze aggiornate");
  }

  return (
    <div className="p-6 bg-white rounded-xl shadow-md">
      <h2 className="text-xl font-bold mb-4">Preferenze Email</h2>

      <div className="flex flex-col gap-3">
        {Object.keys(state).map((key) => (
          <label key={key} className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={(state as any)[key]}
              onChange={(e) =>
                setState({
                  ...state,
                  [key]: e.target.checked,
                })
              }
            />
            <span className="capitalize">{key}</span>
          </label>
        ))}
      </div>

      <button
        onClick={savePrefs}
        className="mt-4 bg-green-600 text-white px-4 py-2 rounded"
      >
        Salva preferenze
      </button>
    </div>
  );
}
```

├─ app/dashboard/components/LevelCard.tsx
```
export default function LevelCard({ user }: any) {
    return (
      <div className="bg-white p-6 rounded-xl shadow-sm">
        <h2 className="text-xl font-semibold mb-3">Il tuo livello</h2>
        <div className="text-5xl font-extrabold text-gray-900">
          {user.stats.level_total}
        </div>
        <p className="text-gray-600">
          Continua a migliorare per salire di livello.
        </p>
      </div>
    );
  }
  ```

├─ app/dashboard/components/LogoutButton.tsx
```
"use client";

export default function LogoutButton() {
  async function logout() {
    await fetch("/auth/logout", { method: "POST" });
    window.location.href = "/login";
  }

  return (
    <button
      onClick={logout}
      className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
    >
      Logout
    </button>
  );
}
```

├─ app/dashboard/components/ProfileForm.tsx
```
"use client";

import { useState } from "react";

export default function ProfileForm({ user }: { user: any }) {
  const [form, setForm] = useState({
    firstname: user.firstname || "",
    lastname: user.lastname || "",
    nickname: user.nickname || "",
    birthdate: user.personal?.birthdate || "",
    gender: user.personal?.gender || "",
    height: user.personal?.height || "",
    weight: user.personal?.weight || "",
    job: user.personal?.job || "",
  });

  const [loading, setLoading] = useState(false);

  async function handleSave() {
    setLoading(true);

    const res = await fetch("/api/user/update-profile", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: user.id, data: form }),
    });

    setLoading(false);

    if (!res.ok) {
      alert("Errore aggiornamento profilo");
      return;
    }

    alert("Profilo aggiornato");
  }

  return (
    <div className="p-6 bg-white rounded-xl shadow-md">
      <h2 className="text-xl font-bold mb-4">Dati Personali</h2>

      <div className="grid grid-cols-2 gap-4">
        {Object.keys(form).map((key) => (
          <div key={key} className="flex flex-col">
            <label className="text-sm font-medium capitalize">{key}</label>
            <input
              type="text"
              className="border p-2 rounded bg-gray-50"
              value={(form as any)[key]}
              onChange={(e) =>
                setForm({ ...form, [key]: e.target.value })
              }
            />
          </div>
        ))}
      </div>

      <button
        onClick={handleSave}
        className="mt-4 bg-blue-600 text-white px-4 py-2 rounded"
      >
        {loading ? "Salvataggio..." : "Salva"}
      </button>
    </div>
  );
}
```

├─ app/dashboard/components/ProfileStrip.tsx
```
export default function ProfileStrip({ user }: any) {
    return (
      <div className="flex items-center gap-4 bg-white p-5 rounded-xl shadow-sm">
        <div className="h-14 w-14 rounded-full bg-gray-200" />
  
        <div>
          <div className="text-lg font-semibold">{user.firstname}</div>
          <div className="text-gray-500 text-sm">{user.email}</div>
        </div>
      </div>
    );
  }
  ```

├─ app/dashboard/components/Sidebar.tsx
```
import LogoutButton from "./LogoutButton";
export default function Sidebar() {
    return (
      <aside className="w-64 bg-white shadow-md p-6 flex flex-col gap-4">
        <h2 className="text-xl font-bold">AGW</h2>
  
        <a href="/dashboard" className="text-gray-700 hover:text-black">
          Dashboard
        </a>
        <a href="/dashboard/profile" className="text-gray-700 hover:text-black">
          Profilo
        </a>
        <a href="/dashboard/missions" className="text-gray-700 hover:text-black">
          Missioni
        </a>
        <a href="/dashboard/stats" className="text-gray-700 hover:text-black">
          Statistiche
        </a>
        <a href="/dashboard/settings" className="text-gray-700 hover:text-black">
          Impostazioni
        </a>
        <li className="mt-4">
        <form action={"/auth/logout"} method="POST">

        <button className="w-full text-left px-4 py-2 text-red-600 hover:bg-red-100 rounded">
        Logout
        </button>
        </form>
        </li>
      </aside>
    );
  }
  ```

├─ app/dashboard/components/StatsRow.tsx
```
export default function StatsRow({ user }: any) {
    return (
      <div className="grid grid-cols-3 gap-4">
        <div className="bg-white p-5 rounded-xl shadow-sm text-center">
          <div className="text-gray-400 text-sm">KRM Totali</div>
          <div className="text-3xl font-semibold">
            {user.stats.krm_total}
          </div>
        </div>
  
        <div className="bg-white p-5 rounded-xl shadow-sm text-center">
          <div className="text-gray-400 text-sm">Missioni</div>
          <div className="text-3xl font-semibold">
            {user.stats.missions_completed_total}
          </div>
        </div>
  
        <div className="bg-white p-5 rounded-xl shadow-sm text-center">
          <div className="text-gray-400 text-sm">Attività 7 giorni</div>
          <div className="text-3xl font-semibold">
            {user.stats.dayPurchasesLast7Days}
          </div>
        </div>
      </div>
    );
  }
  ```

├─ app/dashboard/components/TopBar.tsx
```
export default function Topbar({ user }: any) {
    return (
      <header className="h-16 bg-white shadow flex items-center justify-between px-6">
        <div className="text-lg font-semibold">Benvenuto</div>
  
        <div className="flex items-center gap-3">
          <span className="text-gray-700">{user.firstname || user.email}</span>
          <div className="h-10 w-10 rounded-full bg-gray-200"></div>
        </div>
      </header>
    );
  }
  ```

├─ app/dashboard/layout.tsx
```
"use client";

import Sidebar from "./components/Sidebar";
import Topbar from "./components/TopBar";
import { useEffect, useState } from "react";

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const [user, setUser] = useState<any>(null);

  useEffect(() => {
    async function load() {
      const res = await fetch("/auth/me", { cache: "no-store" });
      const data = await res.json();
      if (!data.ok) window.location.href = "/login";
      setUser(data.user);
    }
    load();
  }, []);

  if (!user) return null;

  return (
    <div className="min-h-screen flex bg-gray-100">
      <Sidebar />
      <div className="flex-1 flex flex-col">
        <Topbar user={user} />
        <main className="p-6">{children}</main>
      </div>
    </div>
  );
}
```

├─ app/dashboard/page.tsx
```
"use client";

import ProfileStrip from "./components/ProfileStrip";
import LevelCard from "./components/LevelCard";
import StatsRow from "./components/StatsRow";
import DisciplineCard from "./components/DisciplineCard";
import { useEffect, useState } from "react";

export default function DashboardPage() {
  const [user, setUser] = useState<any>(null);

  useEffect(() => {
    async function load() {
      const res = await fetch("/auth/me", { cache: "no-store" });
      const data = await res.json();
      if (!data.ok) window.location.href = "/login";
      setUser(data.user);
    }
    load();
  }, []);

  if (!user) return null;

  return (
    <div className="flex flex-col gap-6 max-w-4xl mx-auto">
      <ProfileStrip user={user} />
      <LevelCard user={user} />
      <StatsRow user={user} />
      <DisciplineCard user={user} />
    </div>
  );
}
```

├─ app/dashboard/profile/page.tsx
```
import { cookies } from "next/headers";
import { redirect } from "next/navigation";
import ProfileForm from "../components/ProfileForm";
import EmailPreferences from "../components/EmailPreferences";
import AvatarUploader from "../components/AvatarUploader";

export default async function ProfilePage() {
  const cookieStore = await cookies();
  const session = cookieStore.get("agw_session")?.value;

  if (!session) redirect("/login");

  const apiUrl = process.env.NEXT_PUBLIC_API_URL!;
  const res = await fetch(`${apiUrl}/api/user/get`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: session }),
    cache: "no-store",
  });

  const user = await res.json();

  return (
    <div className="flex flex-col gap-8 p-6">
      <h1 className="text-3xl font-bold">Il tuo Profilo</h1>

      <AvatarUploader user={user} />

      <ProfileForm user={user} />

      <EmailPreferences prefs={user.mailing.preferences} userId={user.id} />
    
    </div>
    
  );
}
```

├─ app/dashboard/settings/DangerZone.tsx
```
"use client";

export default function DangerZone() {
  async function handleDelete() {
    if (!confirm("Sei sicuro? Questa azione è irreversibile.")) return;

    const res = await fetch("/api/user/delete-account", {
      method: "POST",
    });

    if (!res.ok) {
      alert("Errore eliminazione account");
      return;
    }

    alert("Account eliminato");
    window.location.href = "/";
  }

  return (
    <div className="p-6 bg-red-50 border border-red-200 rounded-xl shadow-md">
      <h2 className="text-xl font-bold text-red-700 mb-4">Zona Pericolosa</h2>

      <button
        onClick={handleDelete}
        className="bg-red-600 text-white px-4 py-2 rounded"
      >
        Elimina Account
      </button>
    </div>
  );
}
```

├─ app/dashboard/settings/NotificationSetting.tsx
```
"use client";

import { useState } from "react";

export default function NotificationSettings() {
  const [pushEnabled, setPushEnabled] = useState(false);

  return (
    <div className="p-6 bg-white rounded-xl shadow-md">
      <h2 className="text-xl font-bold mb-4">Notifiche</h2>

      <label className="flex items-center gap-2">
        <input
          type="checkbox"
          checked={pushEnabled}
          onChange={(e) => setPushEnabled(e.target.checked)}
        />
        Attiva notifiche push (coming soon)
      </label>
    </div>
  );
}
```

├─ app/dashboard/settings/SecurityPanel.tsx
```
"use client";

import { useState } from "react";

export default function SecurityPanel() {
  const [oldPass, setOldPass] = useState("");
  const [newPass, setNewPass] = useState("");

  async function changePassword() {
    const res = await fetch("/api/user/change-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ oldPassword: oldPass, newPassword: newPass })

    });

    if (!res.ok) {
      alert("Errore nel cambio password");
      return;
    }

    alert("Password aggiornata");
  }

  return (
    <div className="p-6 bg-white rounded-xl shadow-md">
      <h2 className="text-xl font-bold mb-4">Sicurezza</h2>

      <label className="flex flex-col mb-2">
        Vecchia password
        <input
          type="password"
          className="border p-2 rounded"
          onChange={(e) => setOldPass(e.target.value)}
        />
      </label>

      <label className="flex flex-col mb-2">
        Nuova password
        <input
          type="password"
          className="border p-2 rounded"
          onChange={(e) => setNewPass(e.target.value)}
        />
      </label>

      <button
        onClick={changePassword}
        className="mt-2 bg-blue-600 text-white px-4 py-2 rounded"
      >
        Aggiorna
      </button>
    </div>
  );
}
```

├─ app/dashboard/settings/page.tsx
```
import { cookies } from "next/headers";
import { redirect } from "next/navigation";
import SecurityPanel from "./SecurityPanel";
import NotificationSettings from "./NotificationSetting";
import DangerZone from "./DangerZone";

export default async function SettingsPage() {
  const cookieStore = await cookies();
  const session = cookieStore.get("agw_session")?.value;

  if (!session) redirect("/login");

  return (
    <div className="flex flex-col gap-8 p-6">
      <h1 className="text-3xl font-bold">Impostazioni Account</h1>

      <SecurityPanel />
      <NotificationSettings />
      <DangerZone />
    </div>
  );
}
```

├─ app/forgot-password/page.tsx
```
"use client";

import { useState, useEffect } from "react";

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState("");

  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const preEmail = params.get("email");
    if (preEmail) setEmail(preEmail);
  }, []);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/user/request-reset`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    alert("Se l’email è registrata, riceverai un link per reimpostare la password.");
  }

  return (
    <main className="min-h-screen flex items-center justify-center bg-gray-100 p-6">
      <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
        <h1 className="text-2xl font-bold mb-6 text-center">
          Recupera Password
        </h1>

        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          <input
            type="email"
            placeholder="Inserisci la tua email"
            className="p-3 border rounded-lg"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />

          <button
            type="submit"
            className="py-3 bg-black text-white rounded-lg font-semibold hover:bg-gray-800 transition"
          >
            Invia link di recupero
          </button>
        </form>
      </div>
    </main>
  );
}
```

├─ app/layout.tsx
```
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";


const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "AGW - A Gold Winner",
  description: "Reward-Based System",
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <head>
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#FFD700" />
        <link rel="apple-touch-icon" href="/icons/icon-192.png" />
      </head>
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>
        {children}
      </body>
    </html>
  );
}
```

├─ app/login/page.tsx
```
"use client";

import { useState } from "react";

export default function LoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [failCount, setFailCount] = useState(0);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError("");

    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/user/login`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ email, password })
    });
    

    const data = await res.json();

    // EMAIL NON ESISTE
    if (res.status === 404 && data.error === "EMAIL_NOT_FOUND") {
      setError("Questa email non risulta registrata.");
      return;
    }

    // PASSWORD ERRATA
    if (res.status === 401 && data.error === "WRONG_PASSWORD") {
      setFailCount(n => n + 1);
      setError("Password errata. Riprova.");
      return;
    }

    // LOGIN OK
    if (data.ok) {
      window.location.href = "/dashboard";
    }
  }

  return (
    <main className="min-h-screen flex items-center justify-center bg-gray-100 p-6">
      <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
        <h1 className="text-3xl font-bold mb-6 text-center">Accedi</h1>

        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          <input
            type="email"
            placeholder="Email"
            className="p-3 border rounded-lg"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />

          <input
            type="password"
            placeholder="Password"
            className="p-3 border rounded-lg"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            required
          />

          {error && (
            <div className="text-red-600 text-sm text-center">{error}</div>
          )}

          <button
            type="submit"
            className="py-3 bg-black text-white rounded-lg font-semibold hover:bg-gray-800 transition"
          >
            Accedi
          </button>
        </form>

        {/* EMAIL NON REGISTRATA */}
        {error === "Questa email non risulta registrata." && (
          <div className="mt-5 text-center">
            <p className="mb-3">Vuoi creare un nuovo account?</p>
            <a
              href={`/register?email=${encodeURIComponent(email)}`}
              className="text-blue-600 underline font-semibold"
            >
              Registrati con questa email
            </a>
          </div>
        )}

        {/* DOPO 3 ERRORI PASSWORD → PASSWORD RESET */}
        {failCount >= 3 && error !== "Questa email non risulta registrata." && (
          <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
            <p className="text-yellow-800 font-medium mb-2">
              Problemi ad accedere?
            </p>
            <a
              href={`/forgot-password?email=${encodeURIComponent(email)}`}
              className="text-blue-600 underline font-semibold"
            >
              Reimposta la password
            </a>
          </div>
        )}
      </div>
    </main>
  );
}
```

├─ app/page.tsx
```
"use client";

import { useRouter } from "next/navigation";

export default function Home() {
  const router = useRouter();

  return (
    <main
      className="w-full min-h-screen bg-cover bg-center flex flex-col items-center justify-center text-white"
      style={{
        backgroundImage: "url('/wellness-bg.jpg')",
      }}
    >
      <div className="bg-black/40 backdrop-blur-md px-10 py-12 rounded-2xl text-center shadow-xl max-w-md">
        <h1 className="text-4xl font-bold mb-4">Benvenuto in AGW</h1>
        <p className="text-lg mb-8 opacity-90">
          Il tuo percorso di crescita, benessere e disciplina inizia qui.
        </p>

        <div className="flex gap-4 justify-center">
          <button
            onClick={() => router.push("/login")}
            className="px-6 py-3 bg-white text-black text-lg rounded-lg font-semibold hover:bg-gray-200 transition"
          >
            Accedi
          </button>

          <button
            onClick={() => router.push("/register")}
            className="px-6 py-3 bg-blue-600 text-white text-lg rounded-lg font-semibold hover:bg-blue-700 transition"
          >
            Registrati
          </button>
        </div>
      </div>
    </main>
  );
}
```

├─ app/register/page.tsx
```
"use client";

import { useState } from "react";

export default function RegisterPage() {
  const [email, setEmail] = useState("");
  const [firstname, setFirstname] = useState("");
  const [lastname, setLastname] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [ok, setOk] = useState(false);

  async function handleRegister() {
    setError("");
    setOk(false);

    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/user/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, firstname, lastname, password }),
    });

    const data = await res.json();

    if (!res.ok || !data.ok) {
      setError(data.error || "Registrazione fallita");
      return;
    }

    setOk(true);
  }

  return (
    <main className="min-h-screen flex items-center justify-center">
      <div className="w-full max-w-sm p-6 space-y-4 border rounded-lg bg-white">
        <h1 className="text-2xl font-bold text-center">Registrati</h1>

        <input className="w-full border px-3 py-2 rounded" placeholder="Nome" value={firstname} onChange={e => setFirstname(e.target.value)} />
        <input className="w-full border px-3 py-2 rounded" placeholder="Cognome" value={lastname} onChange={e => setLastname(e.target.value)} />
        <input className="w-full border px-3 py-2 rounded" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} />
        <input className="w-full border px-3 py-2 rounded" placeholder="Password" type="password" value={password} onChange={e => setPassword(e.target.value)} />

        {error && <p className="text-sm text-red-600">{error}</p>}
        {ok && <p className="text-sm text-green-600">Registrazione completata. Ora puoi accedere.</p>}

        <button onClick={handleRegister} className="w-full py-2 bg-black text-white rounded">
          Crea account
        </button>
      </div>
    </main>
  );
}
```

├─ app/reset-password/page.tsx
```
"use client";
import { useState } from "react";

export default function ResetPasswordPage({ searchParams }: any) {
  const token = searchParams.token;
  const [done, setDone] = useState(false);

  async function handleSubmit(e: any) {
    e.preventDefault();
    const pass = e.target.password.value;

    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/auth/do-reset`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token, new_password: pass })
    });

    const data = await res.json();
    if (data.ok) setDone(true);
  }

  if (!token) return <p>Token mancante.</p>;

  return (
    <main className="p-8">
      <h1 className="text-xl font-bold mb-4">Imposta nuova password</h1>

      {done ? (
        <p>Password aggiornata. Ora puoi fare login.</p>
      ) : (
        <form onSubmit={handleSubmit} className="flex flex-col gap-3">
          <input type="password" name="password" placeholder="Nuova password" className="border p-2" />
          <button className="bg-green-600 text-white p-2 rounded">Aggiorna</button>
        </form>
      )}
    </main>
  );
}
```

├─ app/test-env/page.tsx
```

"use client";
import { useEffect } from "react";

export default function TestEnv() {
  useEffect(() => {
    console.log("NEXT_PUBLIC_API_URL =", process.env.NEXT_PUBLIC_API_URL);
  }, []);

  return <p>Controlla la console del browser</p>;
}
```

├─ lib/utils.ts
```typescript
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
```

├─ next-env.d.ts
```typescript
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
```

├─ next.config.ts
```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  experimental: {
    optimizeCss: true,
  },

  // Questa linea disabilita l'errore di Turbopack
  turbopack: {},
};

export default nextConfig;
```

├─ package-lock.json
```json
{
  "name": "agw-app",
  "version": "0.1.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "agw-app",
      "version": "0.1.0",
      "dependencies": {
        "@radix-ui/react-dialog": "^1.1.15",
        "@radix-ui/react-slot": "^1.2.4",
        "class-variance-authority": "^0.7.1",
        "clsx": "^2.1.1",
        "lucide-react": "^0.554.0",
        "next": "16.0.3",
        "next-pwa": "^5.6.0",
        "next-themes": "^0.4.6",
        "react": "19.2.0",
        "react-dom": "19.2.0",
        "sonner": "^2.0.7",
        "tailwind-merge": "^3.4.0"
      },
      "devDependencies": {
        "@types/node": "^20",
        "@types/react": "^19",
        "@types/react-dom": "^19",
        "autoprefixer": "^10.4.22",
        "eslint": "^9",
        "eslint-config-next": "16.0.3",
        "postcss": "^8.5.6",
        "tailwindcss": "^3.4.18",
        "tw-animate-css": "^1.4.0",
        "typescript": "^5"
      }
    },
    "node_modules/@alloc/quick-lru": {
      "version": "5.2.0",
      "resolved": "https://registry.npmjs.org/@alloc/quick-lru/-/quick-lru-5.2.0.tgz",
      "integrity": "sha512-UrcABB+4bUrFABwbluTIBErXwvbsU/V7TZWfmbgJfbkwiBuziS9gxdODUyuiecfdGQ85jglMW6juS3+z5TsKLw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/@babel/code-frame": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.27.1.tgz",
      "integrity": "sha512-cjQ7ZlQ0Mv3b47hABuTevyTuYN4i+loJKGeV9flcCgIK37cCXRh+L1bd3iBHlynerhQ7BhCkn2BPbQUL+rGqFg==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-validator-identifier": "^7.27.1",
        "js-tokens": "^4.0.0",
        "picocolors": "^1.1.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/compat-data": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.28.5.tgz",
      "integrity": "sha512-6uFXyCayocRbqhZOB+6XcuZbkMNimwfVGFji8CTZnCzOHVGvDqzvitu1re2AU5LROliz7eQPhB8CpAMvnx9EjA==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/core": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.28.5.tgz",
      "integrity": "sha512-e7jT4DxYvIDLk1ZHmU/m/mB19rex9sv0c2ftBtjSBv+kVM/902eh0fINUzD7UwLLNR+jU585GxUJ8/EBfAM5fw==",
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.5",
        "@babel/helper-compilation-targets": "^7.27.2",
        "@babel/helper-module-transforms": "^7.28.3",
        "@babel/helpers": "^7.28.4",
        "@babel/parser": "^7.28.5",
        "@babel/template": "^7.27.2",
        "@babel/traverse": "^7.28.5",
        "@babel/types": "^7.28.5",
        "@jridgewell/remapping": "^2.3.5",
        "convert-source-map": "^2.0.0",
        "debug": "^4.1.0",
        "gensync": "^1.0.0-beta.2",
        "json5": "^2.2.3",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/babel"
      }
    },
    "node_modules/@babel/generator": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.28.5.tgz",
      "integrity": "sha512-3EwLFhZ38J4VyIP6WNtt2kUdW9dokXA9Cr4IVIFHuCpZ3H8/YFOl5JjZHisrn1fATPBmKKqXzDFvh9fUwHz6CQ==",
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.28.5",
        "@babel/types": "^7.28.5",
        "@jridgewell/gen-mapping": "^0.3.12",
        "@jridgewell/trace-mapping": "^0.3.28",
        "jsesc": "^3.0.2"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-annotate-as-pure": {
      "version": "7.27.3",
      "resolved": "https://registry.npmjs.org/@babel/helper-annotate-as-pure/-/helper-annotate-as-pure-7.27.3.tgz",
      "integrity": "sha512-fXSwMQqitTGeHLBC08Eq5yXz2m37E4pJX1qAU1+2cNedz/ifv/bVXft90VeSav5nFO61EcNgwr0aJxbyPaWBPg==",
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.27.3"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-compilation-targets": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.27.2.tgz",
      "integrity": "sha512-2+1thGUUWWjLTYTHZWK1n8Yga0ijBz1XAhUXcKy81rd5g6yh7hGqMp45v7cadSbEHc9G3OTv45SyneRN3ps4DQ==",
      "license": "MIT",
      "dependencies": {
        "@babel/compat-data": "^7.27.2",
        "@babel/helper-validator-option": "^7.27.1",
        "browserslist": "^4.24.0",
        "lru-cache": "^5.1.1",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-create-class-features-plugin": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/helper-create-class-features-plugin/-/helper-create-class-features-plugin-7.28.5.tgz",
      "integrity": "sha512-q3WC4JfdODypvxArsJQROfupPBq9+lMwjKq7C33GhbFYJsufD0yd/ziwD+hJucLeWsnFPWZjsU2DNFqBPE7jwQ==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-annotate-as-pure": "^7.27.3",
        "@babel/helper-member-expression-to-functions": "^7.28.5",
        "@babel/helper-optimise-call-expression": "^7.27.1",
        "@babel/helper-replace-supers": "^7.27.1",
        "@babel/helper-skip-transparent-expression-wrappers": "^7.27.1",
        "@babel/traverse": "^7.28.5",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-create-regexp-features-plugin": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/helper-create-regexp-features-plugin/-/helper-create-regexp-features-plugin-7.28.5.tgz",
      "integrity": "sha512-N1EhvLtHzOvj7QQOUCCS3NrPJP8c5W6ZXCHDn7Yialuy1iu4r5EmIYkXlKNqT99Ciw+W0mDqWoR6HWMZlFP3hw==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-annotate-as-pure": "^7.27.3",
        "regexpu-core": "^6.3.1",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-define-polyfill-provider": {
      "version": "0.6.5",
      "resolved": "https://registry.npmjs.org/@babel/helper-define-polyfill-provider/-/helper-define-polyfill-provider-0.6.5.tgz",
      "integrity": "sha512-uJnGFcPsWQK8fvjgGP5LZUZZsYGIoPeRjSF5PGwrelYgq7Q15/Ft9NGFp1zglwgIv//W0uG4BevRuSJRyylZPg==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-compilation-targets": "^7.27.2",
        "@babel/helper-plugin-utils": "^7.27.1",
        "debug": "^4.4.1",
        "lodash.debounce": "^4.0.8",
        "resolve": "^1.22.10"
      },
      "peerDependencies": {
        "@babel/core": "^7.4.0 || ^8.0.0-0 <8.0.0"
      }
    },
    "node_modules/@babel/helper-globals": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@babel/helper-globals/-/helper-globals-7.28.0.tgz",
      "integrity": "sha512-+W6cISkXFa1jXsDEdYA8HeevQT/FULhxzR99pxphltZcVaugps53THCeiWA8SguxxpSp3gKPiuYfSWopkLQ4hw==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-member-expression-to-functions": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/helper-member-expression-to-functions/-/helper-member-expression-to-functions-7.28.5.tgz",
      "integrity": "sha512-cwM7SBRZcPCLgl8a7cY0soT1SptSzAlMH39vwiRpOQkJlh53r5hdHwLSCZpQdVLT39sZt+CRpNwYG4Y2v77atg==",
      "license": "MIT",
      "dependencies": {
        "@babel/traverse": "^7.28.5",
        "@babel/types": "^7.28.5"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-imports": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.27.1.tgz",
      "integrity": "sha512-0gSFWUPNXNopqtIPQvlD5WgXYI5GY2kP2cCvoT8kczjbfcfuIljTbcWrulD1CIPIX2gt1wghbDy08yE1p+/r3w==",
      "license": "MIT",
      "dependencies": {
        "@babel/traverse": "^7.27.1",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-transforms": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.28.3.tgz",
      "integrity": "sha512-gytXUbs8k2sXS9PnQptz5o0QnpLL51SwASIORY6XaBKF88nsOT0Zw9szLqlSGQDP/4TljBAD5y98p2U1fqkdsw==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-module-imports": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.27.1",
        "@babel/traverse": "^7.28.3"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-optimise-call-expression": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-optimise-call-expression/-/helper-optimise-call-expression-7.27.1.tgz",
      "integrity": "sha512-URMGH08NzYFhubNSGJrpUEphGKQwMQYBySzat5cAByY1/YgIRkULnIy3tAMeszlL/so2HbeilYloUmSpd7GdVw==",
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-plugin-utils": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.27.1.tgz",
      "integrity": "sha512-1gn1Up5YXka3YYAHGKpbideQ5Yjf1tDa9qYcgysz+cNCXukyLl6DjPXhD3VRwSb8c0J9tA4b2+rHEZtc6R0tlw==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-remap-async-to-generator": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-remap-async-to-generator/-/helper-remap-async-to-generator-7.27.1.tgz",
      "integrity": "sha512-7fiA521aVw8lSPeI4ZOD3vRFkoqkJcS+z4hFo82bFSH/2tNd6eJ5qCVMS5OzDmZh/kaHQeBaeyxK6wljcPtveA==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-annotate-as-pure": "^7.27.1",
        "@babel/helper-wrap-function": "^7.27.1",
        "@babel/traverse": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-replace-supers": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-replace-supers/-/helper-replace-supers-7.27.1.tgz",
      "integrity": "sha512-7EHz6qDZc8RYS5ElPoShMheWvEgERonFCs7IAonWLLUTXW59DP14bCZt89/GKyreYn8g3S83m21FelHKbeDCKA==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-member-expression-to-functions": "^7.27.1",
        "@babel/helper-optimise-call-expression": "^7.27.1",
        "@babel/traverse": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-skip-transparent-expression-wrappers": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-skip-transparent-expression-wrappers/-/helper-skip-transparent-expression-wrappers-7.27.1.tgz",
      "integrity": "sha512-Tub4ZKEXqbPjXgWLl2+3JpQAYBJ8+ikpQ2Ocj/q/r0LwE3UhENh7EUabyHjz2kCEsrRY83ew2DQdHluuiDQFzg==",
      "license": "MIT",
      "dependencies": {
        "@babel/traverse": "^7.27.1",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-string-parser": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
      "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-identifier": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.28.5.tgz",
      "integrity": "sha512-qSs4ifwzKJSV39ucNjsvc6WVHs6b7S03sOh2OcHF9UHfVPqWWALUsNUVzhSBiItjRZoLHx7nIarVjqKVusUZ1Q==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-option": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.27.1.tgz",
      "integrity": "sha512-YvjJow9FxbhFFKDSuFnVCe2WxXk1zWc22fFePVNEaWJEu8IrZVlda6N0uHwzZrUM1il7NC9Mlp4MaJYbYd9JSg==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-wrap-function": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/helper-wrap-function/-/helper-wrap-function-7.28.3.tgz",
      "integrity": "sha512-zdf983tNfLZFletc0RRXYrHrucBEg95NIFMkn6K9dbeMYnsgHaSBGcQqdsCSStG2PYwRre0Qc2NNSCXbG+xc6g==",
      "license": "MIT",
      "dependencies": {
        "@babel/template": "^7.27.2",
        "@babel/traverse": "^7.28.3",
        "@babel/types": "^7.28.2"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helpers": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.28.4.tgz",
      "integrity": "sha512-HFN59MmQXGHVyYadKLVumYsA9dBFun/ldYxipEjzA4196jpLZd8UjEEBLkbEkvfYreDqJhZxYAWFPtrfhNpj4w==",
      "license": "MIT",
      "dependencies": {
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.4"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/parser": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.28.5.tgz",
      "integrity": "sha512-KKBU1VGYR7ORr3At5HAtUQ+TV3SzRCXmA/8OdDZiLDBIZxVyzXuztPjfLd3BV1PRAQGCMWWSHYhL0F8d5uHBDQ==",
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.28.5"
      },
      "bin": {
        "parser": "bin/babel-parser.js"
      },
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@babel/plugin-bugfix-firefox-class-in-computed-class-key": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-firefox-class-in-computed-class-key/-/plugin-bugfix-firefox-class-in-computed-class-key-7.28.5.tgz",
      "integrity": "sha512-87GDMS3tsmMSi/3bWOte1UblL+YUTFMV8SZPZ2eSEL17s74Cw/l63rR6NmGVKMYW2GYi85nE+/d6Hw5N0bEk2Q==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1",
        "@babel/traverse": "^7.28.5"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/plugin-bugfix-safari-class-field-initializer-scope": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-safari-class-field-initializer-scope/-/plugin-bugfix-safari-class-field-initializer-scope-7.27.1.tgz",
      "integrity": "sha512-qNeq3bCKnGgLkEXUuFry6dPlGfCdQNZbn7yUAPCInwAJHMU7THJfrBSozkcWq5sNM6RcF3S8XyQL2A52KNR9IA==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-safari-id-destructuring-collision-in-function-expression/-/plugin-bugfix-safari-id-destructuring-collision-in-function-expression-7.27.1.tgz",
      "integrity": "sha512-g4L7OYun04N1WyqMNjldFwlfPCLVkgB54A/YCXICZYBsvJJE3kByKv9c9+R/nAfmIfjl2rKYLNyMHboYbZaWaA==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-v8-spread-parameters-in-optional-chaining/-/plugin-bugfix-v8-spread-parameters-in-optional-chaining-7.27.1.tgz",
      "integrity": "sha512-oO02gcONcD5O1iTLi/6frMJBIwWEHceWGSGqrpCmEL8nogiS6J9PBlE48CaK20/Jx1LuRml9aDftLgdjXT8+Cw==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1",
        "@babel/helper-skip-transparent-expression-wrappers": "^7.27.1",
        "@babel/plugin-transform-optional-chaining": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.13.0"
      }
    },
    "node_modules/@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/plugin-bugfix-v8-static-class-fields-redefine-readonly/-/plugin-bugfix-v8-static-class-fields-redefine-readonly-7.28.3.tgz",
      "integrity": "sha512-b6YTX108evsvE4YgWyQ921ZAFFQm3Bn+CA3+ZXlNVnPhx+UfsVURoPjfGAPCjBgrqo30yX/C2nZGX96DxvR9Iw==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1",
        "@babel/traverse": "^7.28.3"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/plugin-proposal-private-property-in-object": {
      "version": "7.21.0-placeholder-for-preset-env.2",
      "resolved": "https://registry.npmjs.org/@babel/plugin-proposal-private-property-in-object/-/plugin-proposal-private-property-in-object-7.21.0-placeholder-for-preset-env.2.tgz",
      "integrity": "sha512-SOSkfJDddaM7mak6cPEpswyTRnuRltl429hMraQEglW+OkovnCzsiszTmsrlY//qLFjCpQDFRvjdm2wA5pPm9w==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-syntax-import-assertions": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-syntax-import-assertions/-/plugin-syntax-import-assertions-7.27.1.tgz",
      "integrity": "sha512-UT/Jrhw57xg4ILHLFnzFpPDlMbcdEicaAtjPQpbj9wa8T4r5KVWCimHcL/460g8Ht0DMxDyjsLgiWSkVjnwPFg==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-syntax-import-attributes": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-syntax-import-attributes/-/plugin-syntax-import-attributes-7.27.1.tgz",
      "integrity": "sha512-oFT0FrKHgF53f4vOsZGi2Hh3I35PfSmVs4IBFLFj4dnafP+hIWDLg3VyKmUHfLoLHlyxY4C7DGtmHuJgn+IGww==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-syntax-unicode-sets-regex": {
      "version": "7.18.6",
      "resolved": "https://registry.npmjs.org/@babel/plugin-syntax-unicode-sets-regex/-/plugin-syntax-unicode-sets-regex-7.18.6.tgz",
      "integrity": "sha512-727YkEAPwSIQTv5im8QHz3upqp92JTWhidIC81Tdx4VJYIte/VndKf1qKrfnnhPLiPghStWfvC/iFaMCQu7Nqg==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-create-regexp-features-plugin": "^7.18.6",
        "@babel/helper-plugin-utils": "^7.18.6"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/plugin-transform-arrow-functions": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-arrow-functions/-/plugin-transform-arrow-functions-7.27.1.tgz",
      "integrity": "sha512-8Z4TGic6xW70FKThA5HYEKKyBpOOsucTOD1DjU3fZxDg+K3zBJcXMFnt/4yQiZnf5+MiOMSXQ9PaEK/Ilh1DeA==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-async-generator-functions": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-async-generator-functions/-/plugin-transform-async-generator-functions-7.28.0.tgz",
      "integrity": "sha512-BEOdvX4+M765icNPZeidyADIvQ1m1gmunXufXxvRESy/jNNyfovIqUyE7MVgGBjWktCoJlzvFA1To2O4ymIO3Q==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1",
        "@babel/helper-remap-async-to-generator": "^7.27.1",
        "@babel/traverse": "^7.28.0"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-async-to-generator": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-async-to-generator/-/plugin-transform-async-to-generator-7.27.1.tgz",
      "integrity": "sha512-NREkZsZVJS4xmTr8qzE5y8AfIPqsdQfRuUiLRTEzb7Qii8iFWCyDKaUV2c0rCuh4ljDZ98ALHP/PetiBV2nddA==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-module-imports": "^7.27.1",
        "@babel/helper-plugin-utils": "^7.27.1",
        "@babel/helper-remap-async-to-generator": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-block-scoped-functions": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-block-scoped-functions/-/plugin-transform-block-scoped-functions-7.27.1.tgz",
      "integrity": "sha512-cnqkuOtZLapWYZUYM5rVIdv1nXYuFVIltZ6ZJ7nIj585QsjKM5dhL2Fu/lICXZ1OyIAFc7Qy+bvDAtTXqGrlhg==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-block-scoping": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-block-scoping/-/plugin-transform-block-scoping-7.28.5.tgz",
      "integrity": "sha512-45DmULpySVvmq9Pj3X9B+62Xe+DJGov27QravQJU1LLcapR6/10i+gYVAucGGJpHBp5mYxIMK4nDAT/QDLr47g==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-class-properties": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-class-properties/-/plugin-transform-class-properties-7.27.1.tgz",
      "integrity": "sha512-D0VcalChDMtuRvJIu3U/fwWjf8ZMykz5iZsg77Nuj821vCKI3zCyRLwRdWbsuJ/uRwZhZ002QtCqIkwC/ZkvbA==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-create-class-features-plugin": "^7.27.1",
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-class-static-block": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-class-static-block/-/plugin-transform-class-static-block-7.28.3.tgz",
      "integrity": "sha512-LtPXlBbRoc4Njl/oh1CeD/3jC+atytbnf/UqLoqTDcEYGUPj022+rvfkbDYieUrSj3CaV4yHDByPE+T2HwfsJg==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-create-class-features-plugin": "^7.28.3",
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.12.0"
      }
    },
    "node_modules/@babel/plugin-transform-classes": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-classes/-/plugin-transform-classes-7.28.4.tgz",
      "integrity": "sha512-cFOlhIYPBv/iBoc+KS3M6et2XPtbT2HiCRfBXWtfpc9OAyostldxIf9YAYB6ypURBBbx+Qv6nyrLzASfJe+hBA==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-annotate-as-pure": "^7.27.3",
        "@babel/helper-compilation-targets": "^7.27.2",
        "@babel/helper-globals": "^7.28.0",
        "@babel/helper-plugin-utils": "^7.27.1",
        "@babel/helper-replace-supers": "^7.27.1",
        "@babel/traverse": "^7.28.4"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-computed-properties": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-computed-properties/-/plugin-transform-computed-properties-7.27.1.tgz",
      "integrity": "sha512-lj9PGWvMTVksbWiDT2tW68zGS/cyo4AkZ/QTp0sQT0mjPopCmrSkzxeXkznjqBxzDI6TclZhOJbBmbBLjuOZUw==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1",
        "@babel/template": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-destructuring": {
      "version": "7.28.5",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-destructuring/-/plugin-transform-destructuring-7.28.5.tgz",
      "integrity": "sha512-Kl9Bc6D0zTUcFUvkNuQh4eGXPKKNDOJQXVyyM4ZAQPMveniJdxi8XMJwLo+xSoW3MIq81bD33lcUe9kZpl0MCw==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1",
        "@babel/traverse": "^7.28.5"
      },
      "engines": {
        "node": ">=6.9.0"
```

├─ package.json
```json
{
  "name": "agw-app",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-slot": "^1.2.4",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "lucide-react": "^0.554.0",
    "next": "16.0.3",
    "next-pwa": "^5.6.0",
    "next-themes": "^0.4.6",
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.4.0"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.22",
    "eslint": "^9",
    "eslint-config-next": "16.0.3",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.18",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5"
  }
}
```

├─ postcss.config.js
```javascript
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
```

├─ proxy.ts
```typescript
import { NextResponse, NextRequest } from "next/server";

export function proxy(request: NextRequest) {
  const url = request.nextUrl;
  const userSession = request.cookies.get("agw_session")?.value;
  const adminSession = request.cookies.get("agw_admin_session")?.value;

  // Protect /dashboard/*
  if (url.pathname.startsWith("/dashboard")) {
    if (!userSession) {
      const redirect = url.clone();
      redirect.pathname = "/login";
      return NextResponse.redirect(redirect);
    }
  }

  // Protect /admin/*
  if (url.pathname.startsWith("/admin")) {
    // Allow /admin/login
    if (url.pathname.startsWith("/admin/login")) {
      return NextResponse.next();
    }

    if (!adminSession) {
      const redirect = url.clone();
      redirect.pathname = "/admin/login";
      return NextResponse.redirect(redirect);
    }
  }

  return NextResponse.next();
}

export const config = {
  matcher: [
    "/dashboard/:path*",
    "/admin/:path*"
  ],
};
```

├─ public/manifest.json
```json
{
    "name": "AGW - A Gold Winner",
    "short_name": "AGW",
    "start_url": "/",
    "display": "standalone",
    "background_color": "#000000",
    "theme_color": "#FFD700",
    "description": "AGW platform reward-based gamified system",
    "icons": [
      {
        "src": "/icons/icon-192.png",
        "sizes": "192x192",
        "type": "image/png"
      },
      {
        "src": "/icons/icon-512.png",
        "sizes": "512x512",
        "type": "image/png"
      }
    ]
  }
  ```

├─ public/sw.js
```javascript
self.addEventListener("install", (event) => {
    event.waitUntil(
      caches.open("agw-cache").then((cache) => {
        return cache.addAll(["/"]);
      })
    );
  });
  
  self.addEventListener("fetch", (event) => {
    event.respondWith(
      caches.match(event.request).then((resp) => {
        return resp || fetch(event.request);
      })
    );
  });
  ```

├─ tailwind.config.js
```javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};
```

├─ tsconfig.json
```json
{
  "compilerOptions": {
    
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "baseUrl": ".",
    "paths": {
      "@/components/*": [
        "components/*"
      ],
      "@/lib/*": [
        "lib/*"
      ],
      "@/app/*": [
        "app/*"
      ]
    },
    "typeRoots": [
      "./types",
      "./node_modules/@types"
    ],
    "plugins": [
      {
        "name": "next"
      }
    ]
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
```

├─ types/css.d.ts
```typescript
declare module "*.css";```

├─ workers/admin/createAdminSession.js
```javascript
export async function createAdminSession(env, adminId) {
    const sessionId = crypto.randomUUID();
    const expiresAt = Date.now() + 1000 * 60 * 60 * 24; // 24h
  
    const payload = {
      adminId,
      createdAt: Date.now(),
      expiresAt
    };
  
    await env.AGW_ADMIN_SESSIONS.put(`session:${sessionId}`, JSON.stringify(payload));
  
    return sessionId;
  }
  ```

├─ workers/admin/getAdmin.js
```javascript
export async function getAdmin(env, email) {
    const { keys } = await env.AGW_ADMIN.list({ prefix: "admin:" });
  
    for (const k of keys) {
      const raw = await env.AGW_ADMIN.get(k.name);
      if (!raw) continue;
  
      const admin = JSON.parse(raw);
      if (admin.email.toLowerCase() === email.toLowerCase()) {
        return admin;
      }
    }
  
    return null;
  }
  ```

├─ workers/admin/loginAdmin.js
```javascript
import { getAdmin } from "./getAdmin.js";
import { createAdminSession } from "./createAdminSession.js";

export async function loginAdmin(env, email, password) {
  const admin = await getAdmin(env, email);
  if (!admin) {
    return { ok: false, error: "ADMIN_NOT_FOUND", status: 404 };
  }

  // Password plaintext (per ora) → DA HASHARE
  if (admin.password !== password) {
    return { ok: false, error: "WRONG_PASSWORD", status: 401 };
  }

  const sessionId = await createAdminSession(env, admin.id);

  return { ok: true, sessionId, admin };
}
```

├─ workers/admin/logoutAdminSession.js
```javascript
export async function logoutAdmin(env, sessionId) {
    await env.AGW_ADMIN_SESSIONS.delete(`session:${sessionId}`);
    return true;
  }
  ```

├─ workers/admin/verifyAdminSession.js
```javascript
export async function verifyAdminSession(env, sessionId) {
    const raw = await env.AGW_ADMIN_SESSIONS.get(`session:${sessionId}`);
    if (!raw) return null;
  
    const session = JSON.parse(raw);
  
    if (session.expiresAt < Date.now()) {
      await env.AGW_ADMIN_SESSIONS.delete(`session:${sessionId}`);
      return null;
    }
  
    return session;
  }
  ```

├─ workers/api.js
```javascript
// ============================================================================
// AGW WORKER — BACKEND UFFICIALE
// Admin API + routing principale
// Tutte le API user vengono gestite da userRoutes
// ============================================================================

import { cors } from "./core/cors.js";
import { json } from "./core/response.js";

import { userRoutes } from "./user/route.js";
import { deepMerge } from "./core/deepMerge.js";
import { getUser } from "./user/repo/getUser.js";
import { saveUser } from "./user/repo/saveUser.js";
import { deleteUser } from "./user/logic/deleteUser.js";

// ADMIN MODULES
import { loginAdmin } from "./admin/loginAdmin.js";
import { logoutAdmin } from "./admin/logoutAdminSession.js";
import { verifyAdminSession } from "./admin/verifyAdminSession.js";

// ============================================================================
// MAIN ROUTER
// ============================================================================

export default {
  async fetch(request, env, ctx) {
    try {
      const url = new URL(request.url);
      const method = request.method;

      // 1) USER ROUTES
      const userResult = userRoutes(url, method, request, env);
      if (userResult) return userResult;

      // 2) CORS preflight
      if (method === "OPTIONS") {
        return new Response(null, { status: 204, headers: cors() });
      }

      // ======================================================================
      // =============================  ADMIN  =================================
      // ======================================================================

      // LOGIN ADMIN
      if (url.pathname === "/api/admin/login" && method === "POST") {
        const { email, password } = await request.json();

        const result = await loginAdmin(env, email, password);

        if (!result.ok) {
          return json(result, result.status ?? 400);
        }

        return json({
          ok: true,
          sessionId: result.sessionId,
          admin: result.admin
        });
      }

      // LOGOUT ADMIN
      if (url.pathname === "/api/admin/logout" && method === "POST") {
        const { sessionId } = await request.json();
        await logoutAdmin(env, sessionId);
        return json({ ok: true });
      }

      // SESSION CHECK
      if (url.pathname === "/api/admin/me" && method === "POST") {
        const { sessionId } = await request.json();
        const session = await verifyAdminSession(env, sessionId);
        return json({ ok: !!session, session });
      }

      // ADMIN AUTH GUARD
      async function requireAdminSession() {
        const { sessionId } = await request.json();
        const session = await verifyAdminSession(env, sessionId);
        if (!session) return null;
        return session;
      }

      // ADMIN: Overview
      if (url.pathname === "/api/admin/overview" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);

        const { keys } = await env.AGW_USERS.list({ prefix: "user:" });

        let totalUsers = 0;
        let subs = 0;
        let bonuses = 0;
        let krm = 0;
        let day = 0;
        let missions = 0;

        for (const k of keys) {
          if (k.name === "user:index") continue;

          const raw = await env.AGW_USERS.get(k.name);
          if (!raw) continue;

          const user = JSON.parse(raw);
          totalUsers++;
          if (user.subscription?.type) subs++;
          if (user.bonus?.award) bonuses++;
          krm += user.stats?.krm_total ?? 0;
          missions += user.stats?.missions_completed_total ?? 0;
          day += user.stats?.dayPurchasesLast7Days ?? 0;
        }

        return json({
          totalUsers,
          activeSubscriptions: subs,
          activeBonuses: bonuses,
          totalKRM: krm,
          totalDay: day,
          totalMissions: missions
        });
      }

      // ADMIN: List Users
      if (url.pathname === "/api/admin/users/list" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);

        const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
        const users = [];

        for (const k of keys) {
          if (k.name === "user:index") continue;

          const raw = await env.AGW_USERS.get(k.name);
          if (!raw) continue;

          try {
            const user = JSON.parse(raw);
            if (user?.id) users.push(user);
          } catch {}
        }

        return json({ users });
      }

      // ADMIN: Create User
      if (url.pathname === "/api/admin/user/create" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);

        let index = Number(await env.AGW_USERS.get("user:index") || 0);
        index++;
        await env.AGW_USERS.put("user:index", String(index));

        const id = crypto.randomUUID();
        const user = {
          id,
          index,
          nickname: `user${index}`,
          firstname: `name${index}`,
          lastname: `lastname${index}`,
          email: `name${index}.lastname${index}@mail.com`,
          password: "_" + index,
          stats: { level_total: 1 }
        };

        await env.AGW_USERS.put(`user:${id}`, JSON.stringify(user));

        return json(user);
      }

      // ADMIN: Update User
      if (url.pathname === "/api/admin/user/update" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);

        const { id, field, value } = body;
        const user = await getUser(env, id);

        if (!user) return json({ error: "User not found" }, 404);

        if (field === "delete") {
          return deleteUser(env, id);
        }

        if (field === "krm") user.stats.krm_total = Number(value);
        if (field === "level") user.stats.level_total = Number(value);
        if (field === "suspend") user.status.suspended = true;
        if (field === "unsuspend") user.status.suspended = false;

        await saveUser(env, id, user);
        return json(user);
      }

      // ======================================================================
      // FALLBACK 404
      // ======================================================================
      return new Response("Not found", {
        status: 404,
        headers: cors()
      });

    } catch (err) {
      return json({ error: "Internal Error", detail: err?.message }, 500);
    }
  }
};
```

├─ workers/core/cors.js
```javascript
export function cors(type = "application/json") {
    return {
      "Content-Type": type,
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, x-admin-token"
    };
  }
  ```

├─ workers/core/deepMerge.js
```javascript
export function deepMerge(base, update) {
    for (const k in update) {
      if (
        typeof base[k] === "object" &&
        base[k] !== null &&
        typeof update[k] === "object" &&
        update[k] !== null &&
        !Array.isArray(base[k])
      ) {
        deepMerge(base[k], update[k]);
      } else {
        base[k] = update[k];
      }
    }
    return base;
  }
  ```

├─ workers/core/response.js
```javascript

import { cors } from "./cors.js";

export function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: cors("application/json")
  });
}
```

├─ workers/index.js
```javascript
import api from "./api.js";

export default {
  async fetch(request, env, ctx) {
    return api.fetch(request, env, ctx);
  }
};
```

├─ workers/security/hashPassword.js
```javascript
export async function hashPassword(password) {
    const encoder = new TextEncoder();
    
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const keyMaterial = await crypto.subtle.importKey(
      "raw",
      encoder.encode(password),
      { name: "PBKDF2" },
      false,
      ["deriveBits", "deriveKey"]
    );
  
    const key = await crypto.subtle.deriveKey(
      {
        name: "PBKDF2",
        salt,
        iterations: 200_000,
        hash: "SHA-256"
      },
      keyMaterial,
      { name: "AES-GCM", length: 256 },
      true,
      ["encrypt", "decrypt"]
    );
  
    const rawKey = new Uint8Array(await crypto.subtle.exportKey("raw", key));
  
    return {
      hash: btoa(String.fromCharCode(...rawKey)),
      salt: btoa(String.fromCharCode(...salt)),
    };
  }
  ```

├─ workers/security/verifyPassword.js
```javascript
export async function verifyPassword(password, hash, salt) {
    const encoder = new TextEncoder();
  
    const saltBytes = Uint8Array.from(atob(salt), c => c.charCodeAt(0));
    const hashBytes = Uint8Array.from(atob(hash), c => c.charCodeAt(0));
  
    const keyMaterial = await crypto.subtle.importKey(
      "raw",
      encoder.encode(password),
      { name: "PBKDF2" },
      false,
      ["deriveBits", "deriveKey"]
    );
  
    const key = await crypto.subtle.deriveKey(
      {
        name: "PBKDF2",
        salt: saltBytes,
        iterations: 200_000,
        hash: "SHA-256"
      },
      keyMaterial,
      { name: "AES-GCM", length: 256 },
      true,
      ["encrypt", "decrypt"]
    );
  
    const rawKey = new Uint8Array(await crypto.subtle.exportKey("raw", key));
  
    return crypto.subtle.timingSafeEqual
      ? crypto.subtle.timingSafeEqual(rawKey, hashBytes)
      : rawKey.every((b, i) => b === hashBytes[i]); // fallback
  }
  ```

├─ workers/sessions/createSession.js
```javascript
export async function createSession(env, userId, role = "user") {
    const sessionId = crypto.randomUUID();
  
    const data = {
      userId,
      role,
      createdAt: Date.now(),
    };
  
    // TTL: 30 giorni
    await env.AGW_SESSIONS.put(`sess:${sessionId}`, JSON.stringify(data), {
      expirationTtl: 60 * 60 * 24 * 30
    });
  
    return sessionId;
  }
  ```

├─ workers/sessions/deleteSession.js
```javascript
export async function deleteSession(env, sessionId) {
    await env.AGW_SESSIONS.delete(`sess:${sessionId}`);
  }
  ```

├─ workers/sessions/getSession.js
```javascript
export async function getSession(env, sessionId) {
    const raw = await env.AGW_SESSIONS.get(`sess:${sessionId}`);
    return raw ? JSON.parse(raw) : null;
  }
  ```

├─ workers/user/logic/deleteUser.js
```javascript
// workers/user/logic/deleteUser.js

import { json } from "../../core/response.js";

export async function deleteUser(env, id) {
  if (!id) return json({ error: "Missing id" }, 400);

  await env.AGW_USERS.delete(`user:${id}`);

  return json({ deleted: true });
}
```

├─ workers/user/logic/evaluateWeeklyBonus.js
```javascript
// ============================================================================
// BUSINESS LOGIC (BONUS SYSTEM)
// ============================================================================

export function evaluateWeeklyBonus(dailyCount) {
    if (dailyCount >= 15)
      return {
        award: "ADVANCED",
        days: 30,
        expiresAt: Date.now() + 30 * 86400000
      };
  
    if (dailyCount >= 8)
      return {
        award: "COMFORT",
        days: 30,
        expiresAt: Date.now() + 30 * 86400000
      };
  
    if (dailyCount >= 5)
      return {
        award: "BASIC",
        days: 30,
        expiresAt: Date.now() + 30 * 86400000
      };
  
    return {
      award: null,
      days: 0,
      expiresAt: null
    };
  }```

├─ workers/user/logic/loginUser.js
```javascript
import { findUserByEmail } from "../repo/findUserByEmail.js";
import { verifyPassword } from "../../security/verifyPassword.js";
import { createSession } from "../../sessions/createSession.js";
import { json } from "../../core/response.js";

export async function loginUser(env, body) {
  const { email, password } = body;

  if (!email || !password)
    return json({ ok: false, error: "Missing credentials" }, 400);

  const user = await findUserByEmail(env, email);
  if (!user)
    return json({ ok: false, error: "EMAIL_NOT_FOUND" }, 404);

  const match = await verifyPassword(password, user.password_hash, user.password_salt);
  if (!match)
    return json({ ok: false, error: "WRONG_PASSWORD" }, 401);

  if (user.status?.suspended)
    return json({ ok: false, error: "ACCOUNT_SUSPENDED" }, 403);

  const sessionId = await createSession(env, user.id, "user");

  return json({
    ok: true,
    sessionId,
    user: {
      id: user.id,
      email: user.email,
      firstname: user.firstname,
      lastname: user.lastname
    }
  });
}
```

├─ workers/user/logic/registerUser.js
```javascript
import { json } from "../../core/response.js";
import { saveUser } from "../repo/saveUser.js";
import { getUser } from "../repo/getUser.js";
import { createDefaultUser } from "../model/defaultUser.js";

// Utility per cercare user via email (parte del repo)
import { findUserByEmail } from "../repo/findUserByEmail.js";

export async function registerUserHandler(request, env) {
  const body = await request.json();
  const { email, firstname, lastname, password } = body;

  // Validazioni minime
  if (!email) return json({ error: "Missing email" }, 400);
  if (!password) return json({ error: "Missing password" }, 400);

  // Check utente già esistente
  const existing = await findUserByEmail(env, email);
  if (existing) return json({ error: "Email already registered" }, 409);

  // Create user
  const id = crypto.randomUUID();
  const user = createDefaultUser(id);

  // Assegna campi base
  user.email = email;
  user.mailing.primary = email;
  user.firstname = firstname || "";
  user.lastname = lastname || "";
  user.password = password;   // (da hashare in futuro)

  // Salvataggio
  await saveUser(env, id, user);

  return json({ ok: true, user });
}
```

├─ workers/user/logic/requestPasswordReset.js
```javascript
import { findUserByEmail } from "../repo/findUserByEmail.js";
import { saveUser } from "../repo/saveUser.js";

export async function requestPasswordReset(env, email) {
  const user = await findUserByEmail(env, email);

  // Sicurezza: ritorniamo sempre ok anche se user non esiste
  if (!user) {
    return { ok: true };
  }

  const token = crypto.randomUUID();
  const expiresAt = Date.now() + 15 * 60 * 1000; // 15 minuti

  user.password_reset = {
    token,
    expires_at: expiresAt
  };

  await saveUser(env, user.id, user);

  return {
    ok: true,
    reset_token: token  // solo per dev, da togliere in prod
  };
}
```

├─ workers/user/logic/resetPassword.js
```javascript
import { getUser } from "../repo/getUser.js";
import { saveUser } from "../repo/saveUser.js";

export async function resetPassword(env, token, newPassword) {
  const { keys } = await env.AGW_USERS.list({ prefix: "user:" });

  let targetUser = null;

  for (const k of keys) {
    if (k.name === "user:index") continue;

    const raw = await env.AGW_USERS.get(k.name);
    if (!raw) continue;

    let u;
    try { u = JSON.parse(raw); } catch { continue; }

    if (u.password_reset?.token === token) {
      targetUser = u;
      break;
    }
  }

  if (!targetUser) {
    return { ok: false, error: "Invalid token", status: 400 };
  }

  if (targetUser.password_reset.expires_at < Date.now()) {
    return { ok: false, error: "Token expired", status: 400 };
  }

  // Reset password
  targetUser.password = newPassword;

  // Remove token  
  targetUser.password_reset = {
    token: null,
    expires_at: null
  };

  await saveUser(env, targetUser.id, targetUser);

  return { ok: true };
}
```

├─ workers/user/model/defaultUser.js
```javascript
export function createDefaultUser(id) {
  return {
    id,
    nickname: "",
    firstname: "",
    lastname: "",
    email: "",
    profile_image: null,
    avatar_ai: null,

    password_reset: {
      token: null,
      expires_at: null
    },

    mailing: {
      primary: "",
      secondary: null,
      verified: false,
      verification_sent_at: null,
      verified_at: null,
      preferences: {
        newsletter: true,
        missions: true,
        rewards: true,
        billing: true,
        security: true
      },
      status: {
        bounced: false,
        soft_bounce_count: 0,
        hard_bounce: false,
        unsubscribe: false,
        unsubscribe_at: null
      },
      log: []
    },

    personal: {
      birthdate: null,
      weight: null,
      height: null,
      gender: null,
      job: null
    },

    status: {
      suspended: false,
      createdAt: Date.now()
    },

    stats: {
      level_total: 1,
      level_year: 1,

      rank_month: 0,
      motivation_week: 0,
      assessment_day: 0,

      krm_total: 0,
      krm_year: 0,
      krm_month: 0,
      krm_week: 0,
      krm_day: 0,

      missions_completed_total: 0,
      missions_completed_month: 0,
      missions_completed_week: 0,
      missions_completed_today: 0,

      dayPurchasesLast7Days: 0
    },

    discipline: {
      daily_completed: 0,
      daily_goal: 3,
      weekly_completed: 0,
      weekly_goal: 7
    },

    subscription: {
      type: null,
      renew_every: null,
      last_payment_at: null,
      payment_status: null,
      expires_at: null
    },

    bonus: null
  };
}
```

├─ workers/user/model/normalizeUser.js
```javascript
import { createDefaultUser } from "./defaultUser.js";
import { deepMerge } from "../../core/deepMerge.js";

export function normalizeUserProfile(u) {
  const base = createDefaultUser(u.id || "unknown");

  const merged = deepMerge(base, u);

  // Assicura compatibilità versioni precedenti
  if (!merged.password_reset) {
    merged.password_reset = {
      token: null,
      expires_at: null
    };
  }

  return merged;
}
```

├─ workers/user/repo/findUserByEmail.js
```javascript
export async function findUserByEmail(env, email) {
  // normalizza (trim + lowercase) tutto
  const norm = (v) => (v || "").trim().toLowerCase();

  const target = norm(email);
  if (!target) return null;

  const { keys } = await env.AGW_USERS.list({ prefix: "user:" });

  for (const k of keys) {
    if (k.name === "user:index") continue;

    const raw = await env.AGW_USERS.get(k.name);
    if (!raw) continue;

    let user;
    try {
      user = JSON.parse(raw);
    } catch {
      continue;
    }

    // match sia su user.email sia su mailing.primary
    if (
      norm(user.email) === target ||
      norm(user.mailing?.primary) === target
    ) {
      return user;
    }
  }

  return null;
}
```

├─ workers/user/repo/getUser.js
```javascript
export async function getUser(env, id) {
    const raw = await env.AGW_USERS.get(`user:${id}`);
    return raw ? JSON.parse(raw) : null;
  }
  ```

├─ workers/user/repo/saveUser.js
```javascript
export async function saveUser(env, id, user) {
  await env.AGW_USERS.put(`user:${id}`, JSON.stringify(user));
}
```

├─ workers/user/route.js
```javascript
import { registerUserHandler } from "./logic/registerUser.js";
import { deleteUser } from "./logic/deleteUser.js";
import { loginUser } from "./logic/loginUser.js";
import { getUser } from "./repo/getUser.js";
import { saveUser } from "./repo/saveUser.js";
import { requestPasswordReset } from "./logic/requestPasswordReset.js";
import { resetPassword } from "./logic/resetPassword.js";
import { evaluateWeeklyBonus } from "./logic/evaluateWeeklyBonus.js";
import { json } from "../core/response.js";

export function userRoutes(url, method, request, env) {

  // -------------------------
  // LOGIN
  // -------------------------
  if (url.pathname === "/api/user/login" && method === "POST") {
    return (async () => {
      const body = await request.json();
      const result = await loginUser(env, body);
      const status = result?.status ?? (result.error ? 400 : 200);
      return json(result, status);
    })();
  }

  // -------------------------
  // REQUEST PASSWORD RESET
  // -------------------------
  if (url.pathname === "/api/user/request-password-reset" && method === "POST") {
    return (async () => {
      const { email } = await request.json();
      const result = await requestPasswordReset(env, email);
      return json(result);
    })();
  }

  // -------------------------
  // DO PASSWORD RESET
  // -------------------------
  if (url.pathname === "/api/user/reset-password" && method === "POST") {
    return (async () => {
      const { token, new_password } = await request.json();
      const result = await resetPassword(env, token, new_password);
      return json(result, result.ok ? 200 : 400);
    })();
  }

  // -------------------------
  // REGISTER (public)
  // -------------------------
  if (url.pathname === "/api/user/register" && method === "POST") {
    return registerUserHandler(request, env);
  }

  // -------------------------
  // GET USER
  // -------------------------
  if (url.pathname === "/api/user/get" && method === "POST") {
    return (async () => {
      const { id } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);

      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);

      return json(user);
    })();
  }

  // -------------------------
  // ADD DAY
  // -------------------------
  if (url.pathname === "/api/user/add-day" && method === "POST") {
    return (async () => {
      const { id } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);

      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);

      user.stats.dayPurchasesLast7Days =
        (user.stats.dayPurchasesLast7Days || 0) + 1;

      const daily = user.stats.dayPurchasesLast7Days;
      const bonus = evaluateWeeklyBonus(daily);

      if (bonus.award) {
        user.bonus = bonus;
        user.subscription = {
          type: bonus.award,
          expiresAt: bonus.expiresAt,
        };
      }

      await saveUser(env, id, user);
      return json(user);
    })();
  }

  // -------------------------
  // APPLY BONUS (manual)
  // -------------------------
  if (url.pathname === "/api/user/apply-bonus" && method === "POST") {
    return (async () => {
      const { id, dailyCount } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);

      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);

      const count = Number(dailyCount ?? 0);
      const bonus = evaluateWeeklyBonus(count);

      user.bonus = bonus;

      if (bonus.award) {
        user.subscription = {
          type: bonus.award,
          expiresAt: bonus.expiresAt,
        };
      }

      user.stats.dayPurchasesLast7Days = count;

      await saveUser(env, id, user);
      return json(user);
    })();
  }

  // -------------------------
  // DELETE USER (admin)
  // -------------------------
  if (url.pathname === "/api/admin/user/delete" && method === "POST") {
    return deleteUser(request, env);
  }

  // -------------------------
  // UPDATE AVATAR
  // -------------------------
  if (url.pathname === "/api/user/update-avatar" && method === "POST") {
    return (async () => {
      const { userId, avatarBase64 } = await request.json();
      if (!userId) return json({ error: "Missing userId" }, 400);

      const user = await getUser(env, userId);
      if (!user) return json({ error: "User not found" }, 404);

      user.profile_image = avatarBase64;
      await saveUser(env, userId, user);

      return json({ ok: true, user });
    })();
  }

  // -------------------------
  // UPDATE PROFILE
  // -------------------------
  if (url.pathname === "/api/user/update-profile" && method === "POST") {
    return (async () => {
      const { userId, data } = await request.json();
      if (!userId) return json({ error: "Missing userId" }, 400);

      const user = await getUser(env, userId);
      if (!user) return json({ error: "Not found" }, 404);

      user.firstname = data.firstname || user.firstname;
      user.lastname = data.lastname || user.lastname;
      user.nickname = data.nickname || user.nickname;
      user.personal = { ...user.personal, ...data.personal };

      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }

  // -------------------------
  // UPDATE EMAIL PREFS
  // -------------------------
  if (url.pathname === "/api/user/update-email-prefs" && method === "POST") {
    return (async () => {
      const { userId, prefs } = await request.json();

      const user = await getUser(env, userId);
      if (!user) return json({ error: "Not found" }, 404);

      user.mailing.preferences = {
        ...user.mailing.preferences,
        ...prefs,
      };

      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }

  // -------------------------
  // UPDATE PASSWORD
  // -------------------------
  if (url.pathname === "/api/user/update-password" && method === "POST") {
    return (async () => {
      const { userId, oldPassword, newPassword } = await request.json();

      const user = await getUser(env, userId);
      if (!user) return json({ error: "User not found" }, 404);

      if (user.password !== oldPassword) {
        return json({ error: "Old password incorrect" }, 403);
      }

      user.password = newPassword;
      await saveUser(env, userId, user);

      return json({ ok: true });
    })();
  }

  // -------------------------
  // DEFAULT: no match
  // -------------------------
  return null;
}
```

