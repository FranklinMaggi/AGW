francescomaggi@MacBook-Pro agw-app % showall
├─ .wrangler/tmp/dev-WycVxd/api.js
```javascript
var __defProp = Object.defineProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });

// workers/core/cors.js
function cors(type = "application/json") {
  return {
    "Content-Type": type,
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, x-admin-token"
  };
}
__name(cors, "cors");

// workers/core/response.js
function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: cors("application/json")
  });
}
__name(json, "json");

// workers/user/repo/saveUser.js
async function saveUser(env, id, user) {
  await env.AGW_USERS.put(`user:${id}`, JSON.stringify(user));
}
__name(saveUser, "saveUser");

// workers/user/repo/getUser.js
async function getUser(env, id) {
  const raw = await env.AGW_USERS.get(`user:${id}`);
  return raw ? JSON.parse(raw) : null;
}
__name(getUser, "getUser");

// workers/user/model/defaultUser.js
function createDefaultUser(id) {
  return {
    id,
    nickname: "",
    firstname: "",
    lastname: "",
    email: "",
    profile_image: null,
    avatar_ai: null,
    password_reset: {
      token: null,
      expires_at: null
    },
    mailing: {
      primary: "",
      secondary: null,
      verified: false,
      verification_sent_at: null,
      verified_at: null,
      preferences: {
        newsletter: true,
        missions: true,
        rewards: true,
        billing: true,
        security: true
      },
      status: {
        bounced: false,
        soft_bounce_count: 0,
        hard_bounce: false,
        unsubscribe: false,
        unsubscribe_at: null
      },
      log: []
    },
    personal: {
      birthdate: null,
      weight: null,
      height: null,
      gender: null,
      job: null
    },
    status: {
      suspended: false,
      createdAt: Date.now()
    },
    stats: {
      level_total: 1,
      level_year: 1,
      rank_month: 0,
      motivation_week: 0,
      assessment_day: 0,
      krm_total: 0,
      krm_year: 0,
      krm_month: 0,
      krm_week: 0,
      krm_day: 0,
      missions_completed_total: 0,
      missions_completed_month: 0,
      missions_completed_week: 0,
      missions_completed_today: 0,
      dayPurchasesLast7Days: 0
    },
    discipline: {
      daily_completed: 0,
      daily_goal: 3,
      weekly_completed: 0,
      weekly_goal: 7
    },
    subscription: {
      type: null,
      renew_every: null,
      last_payment_at: null,
      payment_status: null,
      expires_at: null
    },
    bonus: null
  };
}
__name(createDefaultUser, "createDefaultUser");

// workers/user/repo/findUserByEmail.js
async function findUserByEmail(env, email) {
  const norm = /* @__PURE__ */ __name((v) => (v || "").trim().toLowerCase(), "norm");
  const target = norm(email);
  if (!target) return null;
  const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
  for (const k of keys) {
    if (k.name === "user:index") continue;
    const raw = await env.AGW_USERS.get(k.name);
    if (!raw) continue;
    let user;
    try {
      user = JSON.parse(raw);
    } catch {
      continue;
    }
    if (norm(user.email) === target || norm(user.mailing?.primary) === target) {
      return user;
    }
  }
  return null;
}
__name(findUserByEmail, "findUserByEmail");

// workers/user/logic/registerUser.js
async function registerUserHandler(request, env) {
  const body = await request.json();
  const { email, firstname, lastname, password } = body;
  if (!email) return json({ error: "Missing email" }, 400);
  if (!password) return json({ error: "Missing password" }, 400);
  const existing = await findUserByEmail(env, email);
  if (existing) return json({ error: "Email already registered" }, 409);
  const id = crypto.randomUUID();
  const user = createDefaultUser(id);
  user.email = email;
  user.mailing.primary = email;
  user.firstname = firstname || "";
  user.lastname = lastname || "";
  user.password = password;
  await saveUser(env, id, user);
  return json({ ok: true, user });
}
__name(registerUserHandler, "registerUserHandler");

// workers/user/logic/deleteUser.js
async function deleteUser(env, id) {
  if (!id) return json({ error: "Missing id" }, 400);
  await env.AGW_USERS.delete(`user:${id}`);
  return json({ deleted: true });
}
__name(deleteUser, "deleteUser");

// workers/security/verifyPassword.js
async function verifyPassword(password, hash, salt) {
  const encoder = new TextEncoder();
  const saltBytes = Uint8Array.from(atob(salt), (c) => c.charCodeAt(0));
  const hashBytes = Uint8Array.from(atob(hash), (c) => c.charCodeAt(0));
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    encoder.encode(password),
    { name: "PBKDF2" },
    false,
    ["deriveBits", "deriveKey"]
  );
  const key = await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: saltBytes,
      iterations: 2e5,
      hash: "SHA-256"
    },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    true,
    ["encrypt", "decrypt"]
  );
  const rawKey = new Uint8Array(await crypto.subtle.exportKey("raw", key));
  return crypto.subtle.timingSafeEqual ? crypto.subtle.timingSafeEqual(rawKey, hashBytes) : rawKey.every((b, i) => b === hashBytes[i]);
}
__name(verifyPassword, "verifyPassword");

// workers/sessions/createSession.js
async function createSession(env, userId, role = "user") {
  const sessionId = crypto.randomUUID();
  const data = {
    userId,
    role,
    createdAt: Date.now()
  };
  await env.AGW_SESSIONS.put(`sess:${sessionId}`, JSON.stringify(data), {
    expirationTtl: 60 * 60 * 24 * 30
  });
  return sessionId;
}
__name(createSession, "createSession");

// workers/user/logic/loginUser.js
async function loginUser(env, body) {
  const { email, password } = body;
  if (!email || !password)
    return json({ ok: false, error: "Missing credentials" }, 400);
  const user = await findUserByEmail(env, email);
  if (!user)
    return json({ ok: false, error: "EMAIL_NOT_FOUND" }, 404);
  const match = await verifyPassword(password, user.password_hash, user.password_salt);
  if (!match)
    return json({ ok: false, error: "WRONG_PASSWORD" }, 401);
  if (user.status?.suspended)
    return json({ ok: false, error: "ACCOUNT_SUSPENDED" }, 403);
  const sessionId = await createSession(env, user.id, "user");
  return json({
    ok: true,
    sessionId,
    user: {
      id: user.id,
      email: user.email,
      firstname: user.firstname,
      lastname: user.lastname
    }
  });
}
__name(loginUser, "loginUser");

// workers/user/logic/requestPasswordReset.js
async function requestPasswordReset(env, email) {
  const user = await findUserByEmail(env, email);
  if (!user) {
    return { ok: true };
  }
  const token = crypto.randomUUID();
  const expiresAt = Date.now() + 15 * 60 * 1e3;
  user.password_reset = {
    token,
    expires_at: expiresAt
  };
  await saveUser(env, user.id, user);
  return {
    ok: true,
    reset_token: token
    // solo per dev, da togliere in prod
  };
}
__name(requestPasswordReset, "requestPasswordReset");

// workers/user/logic/resetPassword.js
async function resetPassword(env, token, newPassword) {
  const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
  let targetUser = null;
  for (const k of keys) {
    if (k.name === "user:index") continue;
    const raw = await env.AGW_USERS.get(k.name);
    if (!raw) continue;
    let u;
    try {
      u = JSON.parse(raw);
    } catch {
      continue;
    }
    if (u.password_reset?.token === token) {
      targetUser = u;
      break;
    }
  }
  if (!targetUser) {
    return { ok: false, error: "Invalid token", status: 400 };
  }
  if (targetUser.password_reset.expires_at < Date.now()) {
    return { ok: false, error: "Token expired", status: 400 };
  }
  targetUser.password = newPassword;
  targetUser.password_reset = {
    token: null,
    expires_at: null
  };
  await saveUser(env, targetUser.id, targetUser);
  return { ok: true };
}
__name(resetPassword, "resetPassword");

// workers/user/logic/evaluateWeeklyBonus.js
function evaluateWeeklyBonus(dailyCount) {
  if (dailyCount >= 15)
    return {
      award: "ADVANCED",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  if (dailyCount >= 8)
    return {
      award: "COMFORT",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  if (dailyCount >= 5)
    return {
      award: "BASIC",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  return {
    award: null,
    days: 0,
    expiresAt: null
  };
}
__name(evaluateWeeklyBonus, "evaluateWeeklyBonus");

// workers/user/route.js
function userRoutes(url, method, request, env) {
  if (url.pathname === "/api/user/login" && method === "POST") {
    return (async () => {
      const body = await request.json();
      const result = await loginUser(env, body);
      const status = result?.status ?? (result.error ? 400 : 200);
      return json(result, status);
    })();
  }
  if (url.pathname === "/api/user/request-password-reset" && method === "POST") {
    return (async () => {
      const { email } = await request.json();
      const result = await requestPasswordReset(env, email);
      return json(result);
    })();
  }
  if (url.pathname === "/api/user/reset-password" && method === "POST") {
    return (async () => {
      const { token, new_password } = await request.json();
      const result = await resetPassword(env, token, new_password);
      return json(result, result.ok ? 200 : 400);
    })();
  }
  if (url.pathname === "/api/user/register" && method === "POST") {
    return registerUserHandler(request, env);
  }
  if (url.pathname === "/api/user/get" && method === "POST") {
    return (async () => {
      const { id } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      return json(user);
    })();
  }
  if (url.pathname === "/api/user/add-day" && method === "POST") {
    return (async () => {
      const { id } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      user.stats.dayPurchasesLast7Days = (user.stats.dayPurchasesLast7Days || 0) + 1;
      const daily = user.stats.dayPurchasesLast7Days;
      const bonus = evaluateWeeklyBonus(daily);
      if (bonus.award) {
        user.bonus = bonus;
        user.subscription = {
          type: bonus.award,
          expiresAt: bonus.expiresAt
        };
      }
      await saveUser(env, id, user);
      return json(user);
    })();
  }
  if (url.pathname === "/api/user/apply-bonus" && method === "POST") {
    return (async () => {
      const { id, dailyCount } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      const count = Number(dailyCount ?? 0);
      const bonus = evaluateWeeklyBonus(count);
      user.bonus = bonus;
      if (bonus.award) {
        user.subscription = {
          type: bonus.award,
          expiresAt: bonus.expiresAt
        };
      }
      user.stats.dayPurchasesLast7Days = count;
      await saveUser(env, id, user);
      return json(user);
    })();
  }
  if (url.pathname === "/api/admin/user/delete" && method === "POST") {
    return deleteUser(request, env);
  }
  if (url.pathname === "/api/user/update-avatar" && method === "POST") {
    return (async () => {
      const { userId, avatarBase64 } = await request.json();
      if (!userId) return json({ error: "Missing userId" }, 400);
      const user = await getUser(env, userId);
      if (!user) return json({ error: "User not found" }, 404);
      user.profile_image = avatarBase64;
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-profile" && method === "POST") {
    return (async () => {
      const { userId, data } = await request.json();
      if (!userId) return json({ error: "Missing userId" }, 400);
      const user = await getUser(env, userId);
      if (!user) return json({ error: "Not found" }, 404);
      user.firstname = data.firstname || user.firstname;
      user.lastname = data.lastname || user.lastname;
      user.nickname = data.nickname || user.nickname;
      user.personal = { ...user.personal, ...data.personal };
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-email-prefs" && method === "POST") {
    return (async () => {
      const { userId, prefs } = await request.json();
      const user = await getUser(env, userId);
      if (!user) return json({ error: "Not found" }, 404);
      user.mailing.preferences = {
        ...user.mailing.preferences,
        ...prefs
      };
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-password" && method === "POST") {
    return (async () => {
      const { userId, oldPassword, newPassword } = await request.json();
      const user = await getUser(env, userId);
      if (!user) return json({ error: "User not found" }, 404);
      if (user.password !== oldPassword) {
        return json({ error: "Old password incorrect" }, 403);
      }
      user.password = newPassword;
      await saveUser(env, userId, user);
      return json({ ok: true });
    })();
  }
  return null;
}
__name(userRoutes, "userRoutes");

// workers/admin/getAdmin.js
async function getAdmin(env, email) {
  const { keys } = await env.AGW_ADMIN.list({ prefix: "admin:" });
  for (const k of keys) {
    const raw = await env.AGW_ADMIN.get(k.name);
    if (!raw) continue;
    const admin = JSON.parse(raw);
    if (admin.email.toLowerCase() === email.toLowerCase()) {
      return admin;
    }
  }
  return null;
}
__name(getAdmin, "getAdmin");

// workers/admin/createAdminSession.js
async function createAdminSession(env, adminId) {
  const sessionId = crypto.randomUUID();
  const expiresAt = Date.now() + 1e3 * 60 * 60 * 24;
  const payload = {
    adminId,
    createdAt: Date.now(),
    expiresAt
  };
  await env.AGW_ADMIN_SESSIONS.put(`session:${sessionId}`, JSON.stringify(payload));
  return sessionId;
}
__name(createAdminSession, "createAdminSession");

// workers/admin/loginAdmin.js
async function loginAdmin(env, email, password) {
  const admin = await getAdmin(env, email);
  if (!admin) {
    return { ok: false, error: "ADMIN_NOT_FOUND", status: 404 };
  }
  if (admin.password !== password) {
    return { ok: false, error: "WRONG_PASSWORD", status: 401 };
  }
  const sessionId = await createAdminSession(env, admin.id);
  return { ok: true, sessionId, admin };
}
__name(loginAdmin, "loginAdmin");

// workers/admin/logoutAdminSession.js
async function logoutAdmin(env, sessionId) {
  await env.AGW_ADMIN_SESSIONS.delete(`session:${sessionId}`);
  return true;
}
__name(logoutAdmin, "logoutAdmin");

// workers/admin/verifyAdminSession.js
async function verifyAdminSession(env, sessionId) {
  const raw = await env.AGW_ADMIN_SESSIONS.get(`session:${sessionId}`);
  if (!raw) return null;
  const session = JSON.parse(raw);
  if (session.expiresAt < Date.now()) {
    await env.AGW_ADMIN_SESSIONS.delete(`session:${sessionId}`);
    return null;
  }
  return session;
}
__name(verifyAdminSession, "verifyAdminSession");

// workers/api.js
var api_default = {
  async fetch(request, env, ctx) {
    try {
      const url = new URL(request.url);
      const method = request.method;
      const userResult = userRoutes(url, method, request, env);
      if (userResult) return userResult;
      if (method === "OPTIONS") {
        return new Response(null, { status: 204, headers: cors() });
      }
      if (url.pathname === "/api/admin/login" && method === "POST") {
        const { email, password } = await request.json();
        const result = await loginAdmin(env, email, password);
        if (!result.ok) {
          return json(result, result.status ?? 400);
        }
        return json({
          ok: true,
          sessionId: result.sessionId,
          admin: result.admin
        });
      }
      if (url.pathname === "/api/admin/logout" && method === "POST") {
        const { sessionId } = await request.json();
        await logoutAdmin(env, sessionId);
        return json({ ok: true });
      }
      if (url.pathname === "/api/admin/me" && method === "POST") {
        const { sessionId } = await request.json();
        const session = await verifyAdminSession(env, sessionId);
        return json({ ok: !!session, session });
      }
      async function requireAdminSession() {
        const { sessionId } = await request.json();
        const session = await verifyAdminSession(env, sessionId);
        if (!session) return null;
        return session;
      }
      __name(requireAdminSession, "requireAdminSession");
      if (url.pathname === "/api/admin/overview" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
        let totalUsers = 0;
        let subs = 0;
        let bonuses = 0;
        let krm = 0;
        let day = 0;
        let missions = 0;
        for (const k of keys) {
          if (k.name === "user:index") continue;
          const raw = await env.AGW_USERS.get(k.name);
          if (!raw) continue;
          const user = JSON.parse(raw);
          totalUsers++;
          if (user.subscription?.type) subs++;
          if (user.bonus?.award) bonuses++;
          krm += user.stats?.krm_total ?? 0;
          missions += user.stats?.missions_completed_total ?? 0;
          day += user.stats?.dayPurchasesLast7Days ?? 0;
        }
        return json({
          totalUsers,
          activeSubscriptions: subs,
          activeBonuses: bonuses,
          totalKRM: krm,
          totalDay: day,
          totalMissions: missions
        });
      }
      if (url.pathname === "/api/admin/users/list" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
        const users = [];
        for (const k of keys) {
          if (k.name === "user:index") continue;
          const raw = await env.AGW_USERS.get(k.name);
          if (!raw) continue;
          try {
            const user = JSON.parse(raw);
            if (user?.id) users.push(user);
          } catch {
          }
        }
        return json({ users });
      }
      if (url.pathname === "/api/admin/user/create" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        let index = Number(await env.AGW_USERS.get("user:index") || 0);
        index++;
        await env.AGW_USERS.put("user:index", String(index));
        const id = crypto.randomUUID();
        const user = {
          id,
          index,
          nickname: `user${index}`,
          firstname: `name${index}`,
          lastname: `lastname${index}`,
          email: `name${index}.lastname${index}@mail.com`,
          password: "_" + index,
          stats: { level_total: 1 }
        };
        await env.AGW_USERS.put(`user:${id}`, JSON.stringify(user));
        return json(user);
      }
      if (url.pathname === "/api/admin/user/update" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { id, field, value } = body;
        const user = await getUser(env, id);
        if (!user) return json({ error: "User not found" }, 404);
        if (field === "delete") {
          return deleteUser(env, id);
        }
        if (field === "krm") user.stats.krm_total = Number(value);
        if (field === "level") user.stats.level_total = Number(value);
        if (field === "suspend") user.status.suspended = true;
        if (field === "unsuspend") user.status.suspended = false;
        await saveUser(env, id, user);
        return json(user);
      }
      return new Response("Not found", {
        status: 404,
        headers: cors()
      });
    } catch (err) {
      return json({ error: "Internal Error", detail: err?.message }, 500);
    }
  }
};

// ../../../../../.nvm/versions/node/v22.18.0/lib/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts
var drainBody = /* @__PURE__ */ __name(async (request, env, _ctx, middlewareCtx) => {
  try {
    return await middlewareCtx.next(request, env);
  } finally {
    try {
      if (request.body !== null && !request.bodyUsed) {
        const reader = request.body.getReader();
        while (!(await reader.read()).done) {
        }
      }
    } catch (e) {
      console.error("Failed to drain the unused request body.", e);
    }
  }
}, "drainBody");
var middleware_ensure_req_body_drained_default = drainBody;

// .wrangler/tmp/bundle-Wnah6p/middleware-insertion-facade.js
var __INTERNAL_WRANGLER_MIDDLEWARE__ = [
  middleware_ensure_req_body_drained_default
];
var middleware_insertion_facade_default = api_default;

// ../../../../../.nvm/versions/node/v22.18.0/lib/node_modules/wrangler/templates/middleware/common.ts
```

├─ .wrangler/tmp/dev-fVZfc6/api.js
```javascript
var __defProp = Object.defineProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });

// workers/core/cors.js
function cors(type = "application/json") {
  return {
    "Content-Type": type,
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, x-admin-token"
  };
}
__name(cors, "cors");

// workers/core/response.js
function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: cors("application/json")
  });
}
__name(json, "json");

// workers/user/repo/saveUser.js
async function saveUser(env, id, user) {
  await env.AGW_USERS.put(`user:${id}`, JSON.stringify(user));
}
__name(saveUser, "saveUser");

// workers/user/repo/getUser.js
async function getUser(env, id) {
  const raw = await env.AGW_USERS.get(`user:${id}`);
  return raw ? JSON.parse(raw) : null;
}
__name(getUser, "getUser");

// workers/user/model/defaultUser.js
function createDefaultUser(id) {
  return {
    id,
    nickname: "",
    firstname: "",
    lastname: "",
    email: "",
    profile_image: null,
    avatar_ai: null,
    password_reset: {
      token: null,
      expires_at: null
    },
    mailing: {
      primary: "",
      secondary: null,
      verified: false,
      verification_sent_at: null,
      verified_at: null,
      preferences: {
        newsletter: true,
        missions: true,
        rewards: true,
        billing: true,
        security: true
      },
      status: {
        bounced: false,
        soft_bounce_count: 0,
        hard_bounce: false,
        unsubscribe: false,
        unsubscribe_at: null
      },
      log: []
    },
    personal: {
      birthdate: null,
      weight: null,
      height: null,
      gender: null,
      job: null
    },
    status: {
      suspended: false,
      createdAt: Date.now()
    },
    stats: {
      level_total: 1,
      level_year: 1,
      rank_month: 0,
      motivation_week: 0,
      assessment_day: 0,
      krm_total: 0,
      krm_year: 0,
      krm_month: 0,
      krm_week: 0,
      krm_day: 0,
      missions_completed_total: 0,
      missions_completed_month: 0,
      missions_completed_week: 0,
      missions_completed_today: 0,
      dayPurchasesLast7Days: 0
    },
    discipline: {
      daily_completed: 0,
      daily_goal: 3,
      weekly_completed: 0,
      weekly_goal: 7
    },
    subscription: {
      type: null,
      renew_every: null,
      last_payment_at: null,
      payment_status: null,
      expires_at: null
    },
    bonus: null
  };
}
__name(createDefaultUser, "createDefaultUser");

// workers/user/repo/findUserByEmail.js
async function findUserByEmail(env, email) {
  const norm = /* @__PURE__ */ __name((v) => (v || "").trim().toLowerCase(), "norm");
  const target = norm(email);
  if (!target) return null;
  const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
  for (const k of keys) {
    if (k.name === "user:index") continue;
    const raw = await env.AGW_USERS.get(k.name);
    if (!raw) continue;
    let user;
    try {
      user = JSON.parse(raw);
    } catch {
      continue;
    }
    if (norm(user.email) === target || norm(user.mailing?.primary) === target) {
      return user;
    }
  }
  return null;
}
__name(findUserByEmail, "findUserByEmail");

// workers/user/logic/registerUser.js
async function registerUserHandler(request, env) {
  const body = await request.json();
  const { email, firstname, lastname, password } = body;
  if (!email) return json({ error: "Missing email" }, 400);
  if (!password) return json({ error: "Missing password" }, 400);
  const existing = await findUserByEmail(env, email);
  if (existing) return json({ error: "Email already registered" }, 409);
  const id = crypto.randomUUID();
  const user = createDefaultUser(id);
  user.email = email;
  user.mailing.primary = email;
  user.firstname = firstname || "";
  user.lastname = lastname || "";
  user.password = password;
  await saveUser(env, id, user);
  return json({ ok: true, user });
}
__name(registerUserHandler, "registerUserHandler");

// workers/user/logic/deleteUser.js
async function deleteUser(env, id) {
  if (!id) return json({ error: "Missing id" }, 400);
  await env.AGW_USERS.delete(`user:${id}`);
  return json({ deleted: true });
}
__name(deleteUser, "deleteUser");

// workers/security/verifyPassword.js
async function verifyPassword(password, hash, salt) {
  const encoder = new TextEncoder();
  const saltBytes = Uint8Array.from(atob(salt), (c) => c.charCodeAt(0));
  const hashBytes = Uint8Array.from(atob(hash), (c) => c.charCodeAt(0));
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    encoder.encode(password),
    { name: "PBKDF2" },
    false,
    ["deriveBits", "deriveKey"]
  );
  const key = await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: saltBytes,
      iterations: 2e5,
      hash: "SHA-256"
    },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    true,
    ["encrypt", "decrypt"]
  );
  const rawKey = new Uint8Array(await crypto.subtle.exportKey("raw", key));
  return crypto.subtle.timingSafeEqual ? crypto.subtle.timingSafeEqual(rawKey, hashBytes) : rawKey.every((b, i) => b === hashBytes[i]);
}
__name(verifyPassword, "verifyPassword");

// workers/sessions/createSession.js
async function createSession(env, userId, role = "user") {
  const sessionId = crypto.randomUUID();
  const data = {
    userId,
    role,
    createdAt: Date.now()
  };
  await env.AGW_SESSIONS.put(`sess:${sessionId}`, JSON.stringify(data), {
    expirationTtl: 60 * 60 * 24 * 30
  });
  return sessionId;
}
__name(createSession, "createSession");

// workers/user/logic/loginUser.js
async function loginUser(env, body) {
  const { email, password } = body;
  if (!email || !password)
    return json({ ok: false, error: "Missing credentials" }, 400);
  const user = await findUserByEmail(env, email);
  if (!user)
    return json({ ok: false, error: "EMAIL_NOT_FOUND" }, 404);
  const match = await verifyPassword(password, user.password_hash, user.password_salt);
  if (!match)
    return json({ ok: false, error: "WRONG_PASSWORD" }, 401);
  if (user.status?.suspended)
    return json({ ok: false, error: "ACCOUNT_SUSPENDED" }, 403);
  const sessionId = await createSession(env, user.id, "user");
  return json({
    ok: true,
    sessionId,
    user: {
      id: user.id,
      email: user.email,
      firstname: user.firstname,
      lastname: user.lastname
    }
  });
}
__name(loginUser, "loginUser");

// workers/user/logic/requestPasswordReset.js
async function requestPasswordReset(env, email) {
  const user = await findUserByEmail(env, email);
  if (!user) {
    return { ok: true };
  }
  const token = crypto.randomUUID();
  const expiresAt = Date.now() + 15 * 60 * 1e3;
  user.password_reset = {
    token,
    expires_at: expiresAt
  };
  await saveUser(env, user.id, user);
  return {
    ok: true,
    reset_token: token
    // solo per dev, da togliere in prod
  };
}
__name(requestPasswordReset, "requestPasswordReset");

// workers/user/logic/resetPassword.js
async function resetPassword(env, token, newPassword) {
  const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
  let targetUser = null;
  for (const k of keys) {
    if (k.name === "user:index") continue;
    const raw = await env.AGW_USERS.get(k.name);
    if (!raw) continue;
    let u;
    try {
      u = JSON.parse(raw);
    } catch {
      continue;
    }
    if (u.password_reset?.token === token) {
      targetUser = u;
      break;
    }
  }
  if (!targetUser) {
    return { ok: false, error: "Invalid token", status: 400 };
  }
  if (targetUser.password_reset.expires_at < Date.now()) {
    return { ok: false, error: "Token expired", status: 400 };
  }
  targetUser.password = newPassword;
  targetUser.password_reset = {
    token: null,
    expires_at: null
  };
  await saveUser(env, targetUser.id, targetUser);
  return { ok: true };
}
__name(resetPassword, "resetPassword");

// workers/user/logic/evaluateWeeklyBonus.js
function evaluateWeeklyBonus(dailyCount) {
  if (dailyCount >= 15)
    return {
      award: "ADVANCED",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  if (dailyCount >= 8)
    return {
      award: "COMFORT",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  if (dailyCount >= 5)
    return {
      award: "BASIC",
      days: 30,
      expiresAt: Date.now() + 30 * 864e5
    };
  return {
    award: null,
    days: 0,
    expiresAt: null
  };
}
__name(evaluateWeeklyBonus, "evaluateWeeklyBonus");

// workers/user/route.js
function userRoutes(url, method, request, env) {
  if (url.pathname === "/api/user/login" && method === "POST") {
    return (async () => {
      const body = await request.json();
      const result = await loginUser(env, body);
      const status = result?.status ?? (result.error ? 400 : 200);
      return json(result, status);
    })();
  }
  if (url.pathname === "/api/user/request-password-reset" && method === "POST") {
    return (async () => {
      const { email } = await request.json();
      const result = await requestPasswordReset(env, email);
      return json(result);
    })();
  }
  if (url.pathname === "/api/user/reset-password" && method === "POST") {
    return (async () => {
      const { token, new_password } = await request.json();
      const result = await resetPassword(env, token, new_password);
      return json(result, result.ok ? 200 : 400);
    })();
  }
  if (url.pathname === "/api/user/register" && method === "POST") {
    return registerUserHandler(request, env);
  }
  if (url.pathname === "/api/user/get" && method === "POST") {
    return (async () => {
      const { id } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      return json(user);
    })();
  }
  if (url.pathname === "/api/user/add-day" && method === "POST") {
    return (async () => {
      const { id } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      user.stats.dayPurchasesLast7Days = (user.stats.dayPurchasesLast7Days || 0) + 1;
      const daily = user.stats.dayPurchasesLast7Days;
      const bonus = evaluateWeeklyBonus(daily);
      if (bonus.award) {
        user.bonus = bonus;
        user.subscription = {
          type: bonus.award,
          expiresAt: bonus.expiresAt
        };
      }
      await saveUser(env, id, user);
      return json(user);
    })();
  }
  if (url.pathname === "/api/user/apply-bonus" && method === "POST") {
    return (async () => {
      const { id, dailyCount } = await request.json();
      if (!id) return json({ error: "Missing user id" }, 400);
      const user = await getUser(env, id);
      if (!user) return json({ error: "User not found" }, 404);
      const count = Number(dailyCount ?? 0);
      const bonus = evaluateWeeklyBonus(count);
      user.bonus = bonus;
      if (bonus.award) {
        user.subscription = {
          type: bonus.award,
          expiresAt: bonus.expiresAt
        };
      }
      user.stats.dayPurchasesLast7Days = count;
      await saveUser(env, id, user);
      return json(user);
    })();
  }
  if (url.pathname === "/api/admin/user/delete" && method === "POST") {
    return deleteUser(request, env);
  }
  if (url.pathname === "/api/user/update-avatar" && method === "POST") {
    return (async () => {
      const { userId, avatarBase64 } = await request.json();
      if (!userId) return json({ error: "Missing userId" }, 400);
      const user = await getUser(env, userId);
      if (!user) return json({ error: "User not found" }, 404);
      user.profile_image = avatarBase64;
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-profile" && method === "POST") {
    return (async () => {
      const { userId, data } = await request.json();
      if (!userId) return json({ error: "Missing userId" }, 400);
      const user = await getUser(env, userId);
      if (!user) return json({ error: "Not found" }, 404);
      user.firstname = data.firstname || user.firstname;
      user.lastname = data.lastname || user.lastname;
      user.nickname = data.nickname || user.nickname;
      user.personal = { ...user.personal, ...data.personal };
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-email-prefs" && method === "POST") {
    return (async () => {
      const { userId, prefs } = await request.json();
      const user = await getUser(env, userId);
      if (!user) return json({ error: "Not found" }, 404);
      user.mailing.preferences = {
        ...user.mailing.preferences,
        ...prefs
      };
      await saveUser(env, userId, user);
      return json({ ok: true, user });
    })();
  }
  if (url.pathname === "/api/user/update-password" && method === "POST") {
    return (async () => {
      const { userId, oldPassword, newPassword } = await request.json();
      const user = await getUser(env, userId);
      if (!user) return json({ error: "User not found" }, 404);
      if (user.password !== oldPassword) {
        return json({ error: "Old password incorrect" }, 403);
      }
      user.password = newPassword;
      await saveUser(env, userId, user);
      return json({ ok: true });
    })();
  }
  return null;
}
__name(userRoutes, "userRoutes");

// workers/admin/getAdmin.js
async function getAdmin(env, email) {
  const { keys } = await env.AGW_ADMIN.list({ prefix: "admin:" });
  for (const k of keys) {
    const raw = await env.AGW_ADMIN.get(k.name);
    if (!raw) continue;
    const admin = JSON.parse(raw);
    if (admin.email.toLowerCase() === email.toLowerCase()) {
      return admin;
    }
  }
  return null;
}
__name(getAdmin, "getAdmin");

// workers/admin/createAdminSession.js
async function createAdminSession(env, adminId) {
  const sessionId = crypto.randomUUID();
  const expiresAt = Date.now() + 1e3 * 60 * 60 * 24;
  const payload = {
    adminId,
    createdAt: Date.now(),
    expiresAt
  };
  await env.AGW_ADMIN_SESSIONS.put(`session:${sessionId}`, JSON.stringify(payload));
  return sessionId;
}
__name(createAdminSession, "createAdminSession");

// workers/admin/loginAdmin.js
async function loginAdmin(env, email, password) {
  const admin = await getAdmin(env, email);
  if (!admin) {
    return { ok: false, error: "ADMIN_NOT_FOUND", status: 404 };
  }
  if (admin.password !== password) {
    return { ok: false, error: "WRONG_PASSWORD", status: 401 };
  }
  const sessionId = await createAdminSession(env, admin.id);
  return { ok: true, sessionId, admin };
}
__name(loginAdmin, "loginAdmin");

// workers/admin/logoutAdminSession.js
async function logoutAdmin(env, sessionId) {
  await env.AGW_ADMIN_SESSIONS.delete(`session:${sessionId}`);
  return true;
}
__name(logoutAdmin, "logoutAdmin");

// workers/admin/verifyAdminSession.js
async function verifyAdminSession(env, sessionId) {
  const raw = await env.AGW_ADMIN_SESSIONS.get(`session:${sessionId}`);
  if (!raw) return null;
  const session = JSON.parse(raw);
  if (session.expiresAt < Date.now()) {
    await env.AGW_ADMIN_SESSIONS.delete(`session:${sessionId}`);
    return null;
  }
  return session;
}
__name(verifyAdminSession, "verifyAdminSession");

// workers/api.js
var api_default = {
  async fetch(request, env, ctx) {
    try {
      const url = new URL(request.url);
      const method = request.method;
      const userResult = userRoutes(url, method, request, env);
      if (userResult) return userResult;
      if (method === "OPTIONS") {
        return new Response(null, { status: 204, headers: cors() });
      }
      if (url.pathname === "/api/admin/login" && method === "POST") {
        const { email, password } = await request.json();
        const result = await loginAdmin(env, email, password);
        if (!result.ok) {
          return json(result, result.status ?? 400);
        }
        return json({
          ok: true,
          sessionId: result.sessionId,
          admin: result.admin
        });
      }
      if (url.pathname === "/api/admin/logout" && method === "POST") {
        const { sessionId } = await request.json();
        await logoutAdmin(env, sessionId);
        return json({ ok: true });
      }
      if (url.pathname === "/api/admin/me" && method === "POST") {
        const { sessionId } = await request.json();
        const session = await verifyAdminSession(env, sessionId);
        return json({ ok: !!session, session });
      }
      async function requireAdminSession() {
        const { sessionId } = await request.json();
        const session = await verifyAdminSession(env, sessionId);
        if (!session) return null;
        return session;
      }
      __name(requireAdminSession, "requireAdminSession");
      if (url.pathname === "/api/admin/overview" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
        let totalUsers = 0;
        let subs = 0;
        let bonuses = 0;
        let krm = 0;
        let day = 0;
        let missions = 0;
        for (const k of keys) {
          if (k.name === "user:index") continue;
          const raw = await env.AGW_USERS.get(k.name);
          if (!raw) continue;
          const user = JSON.parse(raw);
          totalUsers++;
          if (user.subscription?.type) subs++;
          if (user.bonus?.award) bonuses++;
          krm += user.stats?.krm_total ?? 0;
          missions += user.stats?.missions_completed_total ?? 0;
          day += user.stats?.dayPurchasesLast7Days ?? 0;
        }
        return json({
          totalUsers,
          activeSubscriptions: subs,
          activeBonuses: bonuses,
          totalKRM: krm,
          totalDay: day,
          totalMissions: missions
        });
      }
      if (url.pathname === "/api/admin/users/list" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { keys } = await env.AGW_USERS.list({ prefix: "user:" });
        const users = [];
        for (const k of keys) {
          if (k.name === "user:index") continue;
          const raw = await env.AGW_USERS.get(k.name);
          if (!raw) continue;
          try {
            const user = JSON.parse(raw);
            if (user?.id) users.push(user);
          } catch {
          }
        }
        return json({ users });
      }
      if (url.pathname === "/api/admin/user/create" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        let index = Number(await env.AGW_USERS.get("user:index") || 0);
        index++;
        await env.AGW_USERS.put("user:index", String(index));
        const id = crypto.randomUUID();
        const user = {
          id,
          index,
          nickname: `user${index}`,
          firstname: `name${index}`,
          lastname: `lastname${index}`,
          email: `name${index}.lastname${index}@mail.com`,
          password: "_" + index,
          stats: { level_total: 1 }
        };
        await env.AGW_USERS.put(`user:${id}`, JSON.stringify(user));
        return json(user);
      }
      if (url.pathname === "/api/admin/user/update" && method === "POST") {
        const body = await request.json();
        const session = await verifyAdminSession(env, body.sessionId);
        if (!session) return json({ error: "Unauthorized" }, 403);
        const { id, field, value } = body;
        const user = await getUser(env, id);
        if (!user) return json({ error: "User not found" }, 404);
        if (field === "delete") {
          return deleteUser(env, id);
        }
        if (field === "krm") user.stats.krm_total = Number(value);
        if (field === "level") user.stats.level_total = Number(value);
        if (field === "suspend") user.status.suspended = true;
        if (field === "unsuspend") user.status.suspended = false;
        await saveUser(env, id, user);
        return json(user);
      }
      return new Response("Not found", {
        status: 404,
        headers: cors()
      });
    } catch (err) {
      return json({ error: "Internal Error", detail: err?.message }, 500);
    }
  }
};

// ../../../../../.nvm/versions/node/v22.18.0/lib/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts
var drainBody = /* @__PURE__ */ __name(async (request, env, _ctx, middlewareCtx) => {
  try {
    return await middlewareCtx.next(request, env);
  } finally {
    try {
      if (request.body !== null && !request.bodyUsed) {
        const reader = request.body.getReader();
        while (!(await reader.read()).done) {
        }
      }
    } catch (e) {
      console.error("Failed to drain the unused request body.", e);
    }
  }
}, "drainBody");
var middleware_ensure_req_body_drained_default = drainBody;

// ../../../../../.nvm/versions/node/v22.18.0/lib/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts
function reduceError(e) {
  return {
    name: e?.name,
    message: e?.message ?? String(e),
    stack: e?.stack,
    cause: e?.cause === void 0 ? void 0 : reduceError(e.cause)
```

├─ app/admin/analytics/page.tsx
```
//admin/analytics/page.tsx
"use client";

import { Suspense } from "react";
import { useSearchParams } from "next/navigation";

export default function AnalyticsWrapper() {
  return (
    <Suspense fallback={<p className="admin-muted p-6">Caricamento...</p>}>
      <AnalyticsPage />
    </Suspense>
  );
}

function AnalyticsPage() {

  return (
    <div className="space-y-6">
      <h1 className="text-2xl admin-title">Analitiche Avanzate</h1>

      <div className="admin-card space-y-3">
        <p className="admin-muted">Statistiche e trend della piattaforma:</p>

        <ul className="admin-muted list-disc pl-4">
          <li>Crescita utenti</li>
          <li>Retention settimanale / mensile</li>
          <li>Day acquistati nel tempo</li>
          <li>Missioni completate</li>
          <li>Andamento KRM</li>
        </ul>
      </div>
    </div>
  );
}
```

├─ app/admin/components/AdminSidebar.tsx
```
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import {
  LayoutDashboard,
  Users,
  BadgeCheck,
  Target,
  BarChart3,
  Settings,
} from "lucide-react";

export default function AdminSidebar() {
  const pathname = usePathname();

  const items = [
    { label: "Overview", path: "/admin", icon: LayoutDashboard },
    { label: "Users", path: "/admin/users", icon: Users },
    { label: "Subscriptions", path: "/admin/subscriptions", icon: BadgeCheck },
    { label: "Missions", path: "/admin/missions", icon: Target },
    { label: "Analytics", path: "/admin/analytics", icon: BarChart3 },
    { label: "System", path: "/admin/system", icon: Settings },
  ];

  return (
    <aside className="w-64 admin-sidebar min-h-screen p-4 space-y-6">
      <h2 className="text-2xl font-bold text-[hsl(var(--agw-gold))]">
        AGW Admin
      </h2>

      <nav className="space-y-1">
        {items.map((item) => {
          const Icon = item.icon;
          const active = pathname === item.path;

          return (
            <Link
              key={item.path}
              href={item.path}
              className={`flex items-center gap-3 px-3 py-2 rounded-md transition
                ${
                  active
                    ? "bg-[hsl(var(--agw-gold))] text-black font-semibold"
                    : "text-neutral-300 hover:text-white hover:bg-neutral-800"
                }`}
            >
              <Icon size={18} />
              <span>{item.label}</span>
            </Link>
          );
        })}
      </nav>
    </aside>
  );
}
```

├─ app/admin/components/AdminTopbar.tsx
```
"use client";

import { ShieldCheck, Wifi, Database, LogOut } from "lucide-react";
import { useRouter } from "next/navigation";

export default function AdminTopbar() {
  const router = useRouter();

  function logout() {
    router.push("/admin/logout");
  }

  return (
    <header className="admin-topbar w-full px-6 py-4 flex justify-between items-center shadow-sm">
      {/* LEFT */}
      <div className="flex items-center gap-3">
        <ShieldCheck size={20} className="text-[hsl(var(--agw-gold))]" />
        <h1 className="text-lg font-semibold text-[hsl(var(--agw-gold))] tracking-wide">
          AGW Admin Panel
        </h1>

        <span className="px-2 py-1 text-xs rounded-md bg-[hsl(var(--agw-gold))] text-black ml-2">
          ADMIN
        </span>
      </div>

      {/* RIGHT */}
      <div className="flex items-center gap-6">
        <div className="flex items-center gap-1 text-neutral-400 text-sm">
          <Wifi size={16} className="text-green-400" />
          Online
        </div>

        <div className="flex items-center gap-1 text-neutral-400 text-sm">
          <Database size={16} className="text-blue-400" />
          KV OK
        </div>

        <button
          onClick={logout}
          className="flex items-center gap-2 px-3 py-1 rounded-md admin-btn admin-btn-danger hover:opacity-90"
        >
          <LogOut size={16} />
          Logout
        </button>
      </div>
    </header>
  );
}
```

├─ app/admin/layout.tsx
```
"use client";

import type { ReactNode } from "react";
import AdminSidebar from "./components/AdminSidebar";
import AdminTopbar from "./components/AdminTopbar";

interface AdminLayoutProps {
  children: ReactNode;
}

export default function AdminLayout({ children }: AdminLayoutProps) {
  return (
    <div className="admin-theme min-h-screen flex">
      <AdminSidebar />

      <div className="flex flex-col flex-1 min-h-screen">
        <AdminTopbar />

        <main className="p-6 flex-1">
          {children}
        </main>
      </div>
    </div>
  );
}
```

├─ app/admin/login/page.tsx
```
"use client";

import { useState } from "react";

export default function AdminLoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  async function handleLogin(e: React.FormEvent) {
    e.preventDefault();
    setError("");

    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });

    const data = await res.json();

    if (!res.ok) {
      setError(data.error || "Errore login");
      return;
    }

    window.location.href = "/admin";
  }

  return (
    <main className="min-h-screen flex items-center justify-center bg-black">
      <form
        onSubmit={handleLogin}
        className="bg-neutral-900 p-8 rounded-xl shadow-xl w-full max-w-md space-y-4"
      >
        <h1 className="text-2xl text-[hsl(var(--agw-gold))] font-bold text-center">
          Admin Login
        </h1>

        {error && (
          <p className="text-red-500 text-center">{error}</p>
        )}

        <input
          className="admin-input w-full"
          type="email"
          placeholder="Email admin"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
        />

        <input
          className="admin-input w-full"
          type="password"
          placeholder="Password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
        />

        <button
          type="submit"
          className="admin-btn admin-btn-gold w-full"
        >
          Entra
        </button>
      </form>
    </main>
  );
}
```

├─ app/admin/missions/page.tsx
```
"use client";

export default function AdminMissions() {
  return (
    <div className="space-y-6">
      <h1 className="text-2xl admin-title">Gestione Missioni</h1>

      <div className="admin-card space-y-3">
        <p className="admin-muted">Controlla e gestisci le missioni globali:</p>
        <ul className="admin-muted list-disc pl-4">
          <li>Lista missioni</li>
          <li>Creazione / Modifica / Rimozione</li>
          <li>Missioni attive</li>
          <li>Completamenti sospetti</li>
        </ul>
      </div>
    </div>
  );
}
```

├─ app/admin/page.tsx
```
"use client";

import { useEffect, useState } from "react";

export default function AdminHome() {
  const [valid, setValid] = useState<boolean | null>(null);
  const [overview, setOverview] = useState<any>(null);

  // Recupera sessione admin dal browser
  const sessionId =
    typeof window !== "undefined"
      ? localStorage.getItem("agw_admin_session")
      : null;

  async function validate() {
    if (!sessionId) {
      setValid(false);
      return;
    }

    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/me`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId })
    });

    const data = await res.json();

    setValid(data.ok === true);

    if (data.ok) {
      await loadOverview();
    }
  }

  async function loadOverview() {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/overview`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId })
    });

    const data = await res.json();
    setOverview(data);
  }

  useEffect(() => {
    validate();
  }, []);

  if (valid === null)
    return <p className="admin-muted p-6">Verifica in corso...</p>;

  if (!valid)
    return (
      <div className="admin-card p-6">
        <p className="admin-btn-danger p-2 rounded-md text-center">
          Accesso negato
        </p>
      </div>
    );

  if (!overview)
    return <p className="admin-muted p-6">Caricamento dati...</p>;

  return (
    <div className="space-y-8">
      <h1 className="text-3xl admin-title">Admin Dashboard AGW</h1>

      <div className="admin-card space-y-6">
        <h2 className="text-xl admin-title">Panoramica Sistema</h2>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <Stat label="Utenti totali" value={overview.totalUsers} />
          <Stat label="Abbonamenti attivi" value={overview.activeSubscriptions} />
          <Stat label="Bonus attivi" value={overview.activeBonuses} />
          <Stat label="KRM totali generati" value={overview.totalKRM} />
          <Stat label="Day acquistati" value={overview.totalDay} />
          <Stat label="Missioni completate" value={overview.totalMissions} />
        </div>
      </div>
    </div>
  );
}

function Stat({ label, value }: any) {
  return (
    <div className="admin-stat space-y-1">
      <p className="admin-muted">{label}</p>
      <p className="admin-stat-value">{value}</p>
    </div>
  );
}
```

├─ app/admin/src/types/Users.ts
```typescript
export interface User {
    id: string;
    index: number;
  
    nickname: string;
    firstname: string;
    lastname: string;
    email: string;
    password: string;
    phone: string | null;
  
    profile_image: string | null;
    avatar_ai: string | null;
  
    mailing: {
      primary: string;
      secondary: string | null;
      verified: boolean;
      verification_sent_at: number | null;
      verified_at: number | null;
      preferences: {
        newsletter: boolean;
        missions: boolean;
        rewards: boolean;
        billing: boolean;
        security: boolean;
      };
      status: {
        bounced: boolean;
        soft_bounce_count: number;
        hard_bounce: boolean;
        unsubscribe: boolean;
        unsubscribe_at: number | null;
      };
      log: any[];
    };
  
    personal: {
      birthdate: string | null;
      weight: number | null;
      height: number | null;
      gender: string | null;
      job: string | null;
    };
  
    status: {
      suspended: boolean;
      createdAt: number;
    };
  
    stats: {
      level_total: number;
      level_year: number;
      rank_month: number;
      motivation_week: number;
      assessment_day: number;
  
      krm_total: number;
      krm_year: number;
      krm_month: number;
      krm_week: number;
      krm_day: number;
  
      missions_completed_total: number;
      missions_completed_month: number;
      missions_completed_week: number;
      missions_completed_today: number;
    };
  
    discipline: {
      daily_completed: number;
      daily_goal: number;
      weekly_completed: number;
      weekly_goal: number;
    };
  
    subscription: {
      type: string | null;
      renew_every: number;
      last_payment_at: number | null;
      payment_status: "green" | "orange" | "red" | null;
      expires_at: number | null;
    };
  
    bonus: {
      award: string | null;
      expiresAt: number | null;
      days?: number;
    } | null;
  
    missions: {
      status: "approved" | "pending" | "rejected";
      [k: string]: any;
    }[];
  
    delta7?: number;
  }
  ```

├─ app/admin/subscriptions/page.tsx
```
"use client";

export default function AdminSubscriptions() {
  return (
    <div className="space-y-6">
      <h1 className="text-2xl admin-title">Gestione Abbonamenti</h1>

      <div className="admin-card space-y-3">
        <p className="admin-muted">Qui potrai vedere e gestire:</p>
        <ul className="admin-muted list-disc pl-4">
          <li>Abbonamenti attivi</li>
          <li>Data scadenza</li>
          <li>Rinnovi manuali</li>
          <li>Anomalie abbonamenti</li>
        </ul>
      </div>
    </div>
  );
}
```

├─ app/admin/system/page.tsx
```
"use client";

export default function AdminSystem() {
  return (
    <div className="space-y-6">
      <h1 className="text-2xl admin-title">Controllo Sistema</h1>

      <div className="admin-card space-y-3">
        <p className="admin-muted">Strumenti e diagnostica:</p>
        <ul className="admin-muted list-disc pl-4">
          <li>Test API</li>
          <li>Stato KV</li>
          <li>Logs Worker</li>
          <li>Reset Bonus settimanale</li>
          <li>Health-check</li>
          <li>Sicurezza</li>
        </ul>
      </div>
    </div>
  );
}
```

├─ app/admin/users/UserTable.tsx
```
"use client";

import { useState } from "react";

export default function UserTable({ users }: { users: any[] }) {
  const [search, setSearch] = useState("");
  const [selected, setSelected] = useState<string[]>([]);

  const safeUsers = Array.isArray(users) ? users : [];

  const filtered = safeUsers.filter((u) =>
    JSON.stringify(u).toLowerCase().includes(search.toLowerCase())
  );

  function toggle(id: string) {
    setSelected((prev) =>
      prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id]
    );
  }

  async function handleBulkDelete() {
    if (!confirm(`Eliminare ${selected.length} utenti?`)) return;

    for (const id of selected) {
      await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/user/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, field: "delete" })
      });
    }

    alert("Utenti eliminati");
    window.location.reload();
  }

  return (
    <div className="admin-card p-4 space-y-4 overflow-auto">
      <input
        className="admin-input"
        placeholder="Cerca..."
        value={search}
        onChange={(e) => setSearch(e.target.value)}
      />

      {selected.length > 0 && (
        <button
          onClick={handleBulkDelete}
          className="admin-btn admin-btn-danger"
        >
          Elimina selezionati ({selected.length})
        </button>
      )}

      <div className="overflow-auto">
        <table className="min-w-full text-sm text-left border-collapse">
          <thead>
            <tr>
              <Th></Th>
              <Th>Edit</Th>
              <Th>Delete</Th>
              <Th>ID</Th>
              <Th>Email</Th>
              <Th>Name</Th>
              <Th>Status</Th>
            </tr>
          </thead>

          <tbody>
            {filtered.map((user) => (
              <tr key={user.id}>
                <Td>
                  <input
                    type="checkbox"
                    checked={selected.includes(user.id)}
                    onChange={() => toggle(user.id)}
                  />
                </Td>

                <Td>
                  <a
                    href={`/admin/users/${user.id}/edit`}
                    className="admin-btn admin-btn-blue text-xs"
                  >
                    Edit
                  </a>
                </Td>

                <Td>
                  <button
                    className="admin-btn admin-btn-danger text-xs"
                    onClick={async () => {
                      if (!confirm(`Eliminare ${user.email}?`)) return;

                      await fetch(
                        `${process.env.NEXT_PUBLIC_API_URL}/api/admin/user/update`,
                        {
                          method: "POST",
                          headers: { "Content-Type": "application/json" },
                          body: JSON.stringify({
                            id: user.id,
                            field: "delete"
                          })
                        }
                      );

                      alert("Utente eliminato");
                      window.location.reload();
                    }}
                  >
                    Delete
                  </button>
                </Td>

                <Td>{user.id}</Td>
                <Td>{user.email}</Td>
                <Td>{user.firstname} {user.lastname}</Td>
                <Td>{user.status?.suspended ? "Sospeso" : "Attivo"}</Td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function Th({ children }: any) {
  return (
    <th className="px-3 py-2 font-semibold text-[var(--admin-gold)] whitespace-nowrap">
      {children}
    </th>
  );
}

function Td({ children }: any) {
  return <td className="px-3 py-2 whitespace-nowrap">{children}</td>;
}
```

├─ app/admin/users/[id]/edit/page.tsx
```
"use client";
import type { User } from "app/admin/src/types/Users";

import { useEffect, useState } from "react";
import { useParams, useSearchParams } from "next/navigation";

/* ============================================================================
   PAGE: ADMIN — EDIT USER
   Gestisce profilo, mailing, stats, subscription, bonus,
   discipline, avatar, delete, e RESET PASSWORD.
============================================================================ */

export default function EditUser() {
  const { id } = useParams();
  const params = useSearchParams();
  const token = params.get("token");

  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [msg, setMsg] = useState("");

  // ==========================================================
  // FETCH USER
  // ==========================================================
  async function load() {
    setLoading(true);

    const res = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL}/api/user/get`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      }
    );

    const data = await res.json();
    setUser(data.error ? null : data);
    setLoading(false);
  }

  // ==========================================================
  // GENERIC UPDATE (deep field edit)
  // ==========================================================
  async function update(field: string, value: any) {
    if (!user) return;

    setSaving(true);
    setMsg("");

    const newUser: any = { ...user };

    // Gestione nested path "a.b.c"
    const parts = field.split(".");
    let pointer = newUser;

    for (let i = 0; i < parts.length - 1; i++) {
      pointer = pointer[parts[i]];
    }

    pointer[parts[parts.length - 1]] = value;

    const res = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL}/api/admin/user/save`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token,
          id,
          userData: newUser
        })
      }
    );

    const data = await res.json();

    if (data.error) {
      setMsg("❌ " + data.error);
      setSaving(false);
      return;
    }

    setUser(data.user);
    setMsg("✔ Saved");
    setSaving(false);
  }

  // ==========================================================
  // RESET PASSWORD
  // ==========================================================
  async function resetPassword() {
    const newPass = prompt("Inserisci nuova password:");

    if (!newPass) return;

    const res = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL}/api/user/update-password`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: user?.id,
          newPassword: newPass
        })
      }
    );

    const data = await res.json();

    if (data.ok) {
      alert("Password aggiornata.");
    } else {
      alert("Errore durante l'aggiornamento della password.");
    }
  }

  // ==========================================================
  // DELETE USER (definitivo)
  // ==========================================================
  async function deleteUser() {
    if (!confirm("Confermi l'eliminazione DEFINITIVA di questo utente?"))
      return;

    const res = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL}/api/admin/user/update`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token,
          id: user?.id,
          field: "delete"
        })
      }
    );

    const data = await res.json();

    if (data.deleted) {
      alert("Utente eliminato con successo.");
      window.location.href = `/admin/users?token=${token}`;
    } else {
      alert("Errore durante l'eliminazione.");
    }
  }

  // ==========================================================
  // LOAD USER ON MOUNT
  // ==========================================================
  useEffect(() => {
    if (token) load();
  }, [token]);

  // ==========================================================
  // RENDER STATES
  // ==========================================================
  if (!token) return <p className="admin-muted p-6">Missing token</p>;
  if (loading) return <p className="p-6 admin-muted">Loading...</p>;
  if (!user) return <p className="p-6 text-red-400">User not found</p>;

  // ==========================================================
  // PAGE JSX
  // ==========================================================
  return (
    <div className="space-y-8">

      <h1 className="admin-title text-3xl font-bold">
        Editing User #{user.index} — {user.nickname}
      </h1>

      <p className="admin-muted">{msg}</p>

      {/* ======================================================
         USER BASIC INFO
      ====================================================== */}
      <section className="admin-card p-6 space-y-4">
        <h2 className="admin-title text-xl">Profilo</h2>

        <Field label="Email" value={user.email} update={(v)=>update("email", v)} />
        <Field label="Firstname" value={user.firstname} update={(v)=>update("firstname", v)} />
        <Field label="Lastname" value={user.lastname} update={(v)=>update("lastname", v)} />
      </section>

      {/* ======================================================
         STATS
      ====================================================== */}
      <section className="admin-card p-6 space-y-4">
        <h2 className="admin-title text-xl">Stats</h2>

        <Field label="KRM" value={user.stats?.krm_total} update={(v)=>update("stats.krm_total", Number(v))} />
        <Field label="Level" value={user.stats?.level_total} update={(v)=>update("stats.level_total", Number(v))} />
      </section>

      {/* ======================================================
         STATUS
      ====================================================== */}
      <section className="admin-card p-6 space-y-4">
        <h2 className="admin-title text-xl">Status</h2>

        <select
          className="admin-input"
          defaultValue={user.status?.suspended ? "suspended" : "active"}
          onChange={(e) =>
            update("status.suspended", e.target.value === "suspended")
          }
        >
          <option value="active">Active</option>
          <option value="suspended">Suspended</option>
        </select>
      </section>

      {/* ======================================================
         RESET PASSWORD
      ====================================================== */}
      <div className="admin-card p-6">
        <button
          className="admin-btn admin-btn-blue"
          onClick={resetPassword}
        >
          Reset Password
        </button>
      </div>

      {/* ======================================================
         DELETE USER
      ====================================================== */}
      <div className="admin-card p-6">
        <button
          className="admin-btn admin-btn-danger"
          onClick={deleteUser}
        >
          Delete User
        </button>
      </div>

    </div>
  );
}

/* ============================================================================
   Reusable field component
============================================================================ */
type FieldProps<T> = {
  label: string;
  value: T;
  update: (v: T) => void;
};

function Field<T>({ label, value, update }: FieldProps<T>) {
  return (
    <div className="space-y-2">
      <label className="admin-muted text-sm">{label}</label>

      <input
        className="admin-input"
        defaultValue={value != null ? String(value) : ""}
        onBlur={(e) => {
          let v: any = e.target.value;
          if (typeof value === "number") v = Number(v);
          update(v as T);
        }}
      />
    </div>
  );
}
```

├─ app/admin/users/page.tsx
```
"use client";

import { Suspense, useEffect, useState } from "react";
import UserTable from "./UserTable";

export default function AdminUsersPage() {
  return (
    <Suspense fallback={<p className="admin-muted">Caricamento utenti...</p>}>
      <AdminUsers />
    </Suspense>
  );
}

function AdminUsers() {
  const [userList, setUserList] = useState<any[]>([]);
  const [searchId, setSearchId] = useState("");
  const [selectedUser, setSelectedUser] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const [msg, setMsg] = useState("");

  async function loadUserList() {
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/admin/users/list`, {
      method: "GET",
      cache: "no-store"
    });

    const data = await res.json();
    if (data.ok) {
      setUserList(data.users);
    } else {
      setMsg(data.error || "Errore di caricamento utenti");
    }
  }

  useEffect(() => {
    loadUserList();
  }, []);

  async function searchUser() {
    if (!searchId) return;

    setLoading(true);
    setMsg("");

    const res = await fetch(`/admin/api/user/get`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: searchId })
    });

    const data = await res.json();
    if (data.error) {
      setSelectedUser(null);
      setMsg(data.error);
    } else {
      setSelectedUser(data);
    }

    setLoading(false);
  }

  return (
    <div className="space-y-6">
      <h1 className="admin-title text-2xl font-bold">Gestione Utenti</h1>

      <button
        onClick={async () => {
          const res = await fetch(`/admin/api/user/create`, {
            method: "POST"
          });

          const data = await res.json();

          if (data.error) {
            alert("Errore creando utente: " + data.error);
            return;
          }

          window.location.href = `/admin/users/${data.id}/edit`;
        }}
        className="admin-btn admin-btn-gold"
      >
        + Create New User
      </button>

      <UserTable users={userList} />

      <div className="admin-card space-y-4">
        <p className="admin-muted">Cerca utente per ID:</p>

        <input
          className="admin-input"
          value={searchId}
          onChange={(e) => setSearchId(e.target.value)}
        />

        <button
          onClick={searchUser}
          className="admin-btn admin-btn-gold"
        >
          {loading ? "Ricerca..." : "Cerca"}
        </button>

        {msg && <p className="admin-muted">{msg}</p>}
      </div>

      {selectedUser && (
        <div className="admin-card">
          <p className="admin-title">User loaded</p>
        </div>
      )}
    </div>
  );
}
```

├─ app/api/admin/login/route.ts
```typescript
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  const body = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/admin/login`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    }
  );

  const data = await backend.json();

  if (!backend.ok) {
    return NextResponse.json(data, { status: backend.status });
  }

  const res = NextResponse.json({ ok: true });

  res.cookies.set("agw_admin_session", data.sessionId, {
    httpOnly: true,
    secure: true,
    sameSite: "lax",
    path: "/",
  });

  return res;
}
```

├─ app/api/admin/logout/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST() {
  const cookieStore = await cookies();

  cookieStore.set("agw_admin_session", "", {
    httpOnly: true,
    secure: true,
    sameSite: "lax",
    path: "/",
    expires: new Date(0),
  });

  return NextResponse.json({ ok: true });
}
```

├─ app/api/admin/me/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST() {
  const cookieStore = await cookies();
  const sessionId = cookieStore.get("agw_admin_session")?.value;

  if (!sessionId)
    return NextResponse.json({ ok: false });

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/admin/me`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId }),
    }
  );

  return NextResponse.json(await backend.json());
}
```

├─ app/api/admin/overview/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST() {
  const cookieStore = await cookies();
  const sessionId = cookieStore.get("agw_admin_session")?.value;

  if (!sessionId)
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 });

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/admin/overview`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId }),
    }
  );

  const data = await backend.json();

  return NextResponse.json(data, { status: backend.status });
}
```

├─ app/api/admin/user-update/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  const cookieStore = await cookies();
  const sessionId = cookieStore.get("agw_admin_session")?.value;

  if (!sessionId)
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 });

  const body = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/admin/user/update`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId, ...body }),
    }
  );

  const data = await backend.json();

  return NextResponse.json(data, { status: backend.status });
}
```

├─ app/api/admin/users/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function GET() {
  const cookieStore = await cookies();
  const sessionId = cookieStore.get("agw_admin_session")?.value;

  if (!sessionId)
    return NextResponse.json({ error: "Unauthorized" }, { status: 403 });

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/admin/users/list`,
    { cache: "no-store" }
  );

  const data = await backend.json();
  return NextResponse.json(data, { status: backend.status });
}
```

├─ app/api/user/delete-account/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST() {
  const cookieStore = await cookies();
  const userId = cookieStore.get("agw_session")?.value;

  if (!userId)
    return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/delete-account`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId }),
    }
  );

  return NextResponse.json(await backend.json(), {
    status: backend.status,
  });
}
```

├─ app/api/user/do-reset/route.ts
```typescript
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  const body = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/do-reset`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    }
  );

  return NextResponse.json(await backend.json(), {
    status: backend.status,
  });
}
```

├─ app/api/user/get/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST() {
  const cookieStore = await cookies();
  const sessionId = cookieStore.get("agw_session")?.value;

  if (!sessionId)
    return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/get`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: sessionId }),
    }
  );

  const data = await backend.json();

  return NextResponse.json(data, { status: backend.status });
}
```

├─ app/api/user/login/route.ts
```typescript
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  const { email, password } = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/login`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    }
  );

  const data = await backend.json();

  if (!backend.ok) {
    return NextResponse.json(data, { status: backend.status });
  }

  const res = NextResponse.json({ ok: true });

  res.cookies.set("agw_session", data.sessionId, {
    httpOnly: true,
    secure: true,
    sameSite: "lax",
    path: "/",
  });

  return res;
}
```

├─ app/api/user/logout/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST() {
  const cookieStore = await cookies();

  cookieStore.set("agw_session", "", {
    httpOnly: true,
    secure: true,
    sameSite: "lax",
    path: "/",
    expires: new Date(0),
  });

  return NextResponse.json({ ok: true });
}
```

├─ app/api/user/register/route.ts
```typescript
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  const body = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/register`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    }
  );

  const data = await backend.json();
  return NextResponse.json(data, { status: backend.status });
}
```

├─ app/api/user/request-reset/route.ts
```typescript
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  const { email } = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/request-reset`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email }),
    }
  );

  return NextResponse.json(await backend.json(), {
    status: backend.status,
  });
}
```

├─ app/api/user/update-avatar/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  const cookieStore = await cookies();
  const userId = cookieStore.get("agw_session")?.value;

  if (!userId)
    return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const { avatarBase64 } = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/update-avatar`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, avatarBase64 }),
    }
  );

  return NextResponse.json(await backend.json(), {
    status: backend.status,
  });
}
```

├─ app/api/user/update-email-prefs/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  const cookieStore = await cookies();
  const userId = cookieStore.get("agw_session")?.value;

  if (!userId)
    return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const { prefs } = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/update-email-prefs`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, prefs }),
    }
  );

  return NextResponse.json(await backend.json(), {
    status: backend.status,
  });
}
```

├─ app/api/user/update-password/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  const cookieStore = await cookies();
  const userId = cookieStore.get("agw_session")?.value;

  if (!userId)
    return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const body = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/update-password`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, ...body }),
    }
  );

  return NextResponse.json(await backend.json(), {
    status: backend.status,
  });
}
```

├─ app/api/user/update-profile/route.ts
```typescript
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  const cookieStore = await cookies();
  const userId = cookieStore.get("agw_session")?.value;

  if (!userId)
    return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const data = await req.json();

  const backend = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/user/update-profile`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, data }),
    }
  );

  return NextResponse.json(await backend.json(), {
    status: backend.status,
  });
}
```

├─ app/components/lib/apiClients.ts
```typescript
```

├─ app/components/lib/auth.ts
```typescript
```

├─ app/components/lib/session.ts
```typescript
```

├─ app/components/store/userStore.ts
```typescript
```

├─ app/dashboard/components/AvatarUploader.tsx
```
"use client";

import { useState } from "react";

export default function AvatarUploader({ user }: { user: any }) {
  const [preview, setPreview] = useState(user.profile_image);

  async function handleUpload(e: any) {
    const file = e.target.files[0];
    if (!file) return;

    const base64 = await toBase64(file);
    setPreview(base64);

    await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/user/update-avatar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: user.id, avatarBase64: base64 }),
    });

    alert("Avatar aggiornato");
  }

  function toBase64(file: File) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result as string);
      reader.readAsDataURL(file);
    });
  }

  return (
    <div className="p-6 bg-white rounded-xl shadow-md flex gap-4">
      <img
        src={preview || "/default-avatar.png"}
        className="w-24 h-24 rounded-full object-cover border"
      />

      <div>
        <h3 className="font-semibold mb-2">Avatar</h3>

        <input type="file" accept="image/*" onChange={handleUpload} />

        <p className="text-sm mt-2 text-gray-500">
          Carica un’immagine quadrata.
        </p>
      </div>
    </div>
  );
}
```

├─ app/dashboard/components/DisciplineCard.tsx
```
export default function DisciplineCard({ user }: any) {
    return (
      <div className="bg-white p-6 rounded-xl shadow-sm">
        <h2 className="text-xl font-semibold mb-3">Disciplina</h2>
  
        <div className="flex justify-between text-lg font-medium">
          <div>
            Giornaliero:
            {" "}
            {user.discipline.daily_completed}/{user.discipline.daily_goal}
          </div>
  
          <div>
            Settimanale:
            {" "}
            {user.discipline.weekly_completed}/{user.discipline.weekly_goal}
          </div>
        </div>
      </div>
    );
  }
  ```

├─ app/dashboard/components/EmailPreferences.tsx
```
"use client";

import { useState } from "react";

export default function EmailPreferences({
  prefs,
  userId,
}: {
  prefs: any;
  userId: string;
}) {
  const [state, setState] = useState(prefs);

  async function savePrefs() {
    const res = await fetch("/admin/user/update-email-prefs", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId, prefs: state }),
    });

    if (!res.ok) {
      alert("Errore aggiornamento preferenze email");
      return;
    }

    alert("Preferenze aggiornate");
  }

  return (
    <div className="p-6 bg-white rounded-xl shadow-md">
      <h2 className="text-xl font-bold mb-4">Preferenze Email</h2>

      <div className="flex flex-col gap-3">
        {Object.keys(state).map((key) => (
          <label key={key} className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={(state as any)[key]}
              onChange={(e) =>
                setState({
                  ...state,
                  [key]: e.target.checked,
                })
              }
            />
            <span className="capitalize">{key}</span>
          </label>
        ))}
      </div>

      <button
        onClick={savePrefs}
        className="mt-4 bg-green-600 text-white px-4 py-2 rounded"
      >
        Salva preferenze
      </button>
    </div>
  );
}
```

├─ app/dashboard/components/LevelCard.tsx
```
export default function LevelCard({ user }: any) {
    return (
      <div className="bg-white p-6 rounded-xl shadow-sm">
        <h2 className="text-xl font-semibold mb-3">Il tuo livello</h2>
        <div className="text-5xl font-extrabold text-gray-900">
          {user.stats.level_total}
        </div>
        <p className="text-gray-600">
          Continua a migliorare per salire di livello.
        </p>
      </div>
    );
  }
  ```

├─ app/dashboard/components/LogoutButton.tsx
```
"use client";

export default function LogoutButton() {
  async function logout() {
    await fetch("/auth/logout", { method: "POST" });
    window.location.href = "/login";
  }

  return (
    <button
      onClick={logout}
      className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
    >
      Logout
    </button>
  );
}
```

├─ app/dashboard/components/ProfileForm.tsx
```
"use client";

import { useState } from "react";

export default function ProfileForm({ user }: { user: any }) {
  const [form, setForm] = useState({
    firstname: user.firstname || "",
    lastname: user.lastname || "",
    nickname: user.nickname || "",
    birthdate: user.personal?.birthdate || "",
    gender: user.personal?.gender || "",
    height: user.personal?.height || "",
    weight: user.personal?.weight || "",
    job: user.personal?.job || "",
  });

  const [loading, setLoading] = useState(false);

  async function handleSave() {
    setLoading(true);

    const res = await fetch("/api/user/update-profile", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: user.id, data: form }),
    });

    setLoading(false);

    if (!res.ok) {
      alert("Errore aggiornamento profilo");
      return;
    }

    alert("Profilo aggiornato");
  }

  return (
    <div className="p-6 bg-white rounded-xl shadow-md">
      <h2 className="text-xl font-bold mb-4">Dati Personali</h2>

      <div className="grid grid-cols-2 gap-4">
        {Object.keys(form).map((key) => (
          <div key={key} className="flex flex-col">
            <label className="text-sm font-medium capitalize">{key}</label>
            <input
              type="text"
              className="border p-2 rounded bg-gray-50"
              value={(form as any)[key]}
              onChange={(e) =>
                setForm({ ...form, [key]: e.target.value })
              }
            />
          </div>
        ))}
      </div>

      <button
        onClick={handleSave}
        className="mt-4 bg-blue-600 text-white px-4 py-2 rounded"
      >
        {loading ? "Salvataggio..." : "Salva"}
      </button>
    </div>
  );
}
```

├─ app/dashboard/components/ProfileStrip.tsx
```
export default function ProfileStrip({ user }: any) {
    return (
      <div className="flex items-center gap-4 bg-white p-5 rounded-xl shadow-sm">
        <div className="h-14 w-14 rounded-full bg-gray-200" />
  
        <div>
          <div className="text-lg font-semibold">{user.firstname}</div>
          <div className="text-gray-500 text-sm">{user.email}</div>
        </div>
      </div>
    );
  }
  ```

├─ app/dashboard/components/Sidebar.tsx
```
import LogoutButton from "./LogoutButton";
export default function Sidebar() {
    return (
      <aside className="w-64 bg-white shadow-md p-6 flex flex-col gap-4">
        <h2 className="text-xl font-bold">AGW</h2>
  
        <a href="/dashboard" className="text-gray-700 hover:text-black">
          Dashboard
        </a>
        <a href="/dashboard/profile" className="text-gray-700 hover:text-black">
          Profilo
        </a>
        <a href="/dashboard/missions" className="text-gray-700 hover:text-black">
          Missioni
        </a>
        <a href="/dashboard/stats" className="text-gray-700 hover:text-black">
          Statistiche
        </a>
        <a href="/dashboard/settings" className="text-gray-700 hover:text-black">
          Impostazioni
        </a>
        <li className="mt-4">
        <form action={"/auth/logout"} method="POST">

        <button className="w-full text-left px-4 py-2 text-red-600 hover:bg-red-100 rounded">
        Logout
        </button>
        </form>
        </li>
      </aside>
    );
  }
  ```

├─ app/dashboard/components/StatsRow.tsx
```
export default function StatsRow({ user }: any) {
    return (
      <div className="grid grid-cols-3 gap-4">
        <div className="bg-white p-5 rounded-xl shadow-sm text-center">
          <div className="text-gray-400 text-sm">KRM Totali</div>
          <div className="text-3xl font-semibold">
            {user.stats.krm_total}
          </div>
        </div>
  
        <div className="bg-white p-5 rounded-xl shadow-sm text-center">
          <div className="text-gray-400 text-sm">Missioni</div>
          <div className="text-3xl font-semibold">
            {user.stats.missions_completed_total}
          </div>
        </div>
  
        <div className="bg-white p-5 rounded-xl shadow-sm text-center">
          <div className="text-gray-400 text-sm">Attività 7 giorni</div>
          <div className="text-3xl font-semibold">
            {user.stats.dayPurchasesLast7Days}
          </div>
        </div>
      </div>
    );
  }
  ```

├─ app/dashboard/components/TopBar.tsx
```
export default function Topbar({ user }: any) {
    return (
      <header className="h-16 bg-white shadow flex items-center justify-between px-6">
        <div className="text-lg font-semibold">Benvenuto</div>
  
        <div className="flex items-center gap-3">
          <span className="text-gray-700">{user.firstname || user.email}</span>
          <div className="h-10 w-10 rounded-full bg-gray-200"></div>
        </div>
      </header>
    );
  }
  ```

├─ app/dashboard/layout.tsx
```
"use client";

import Sidebar from "./components/Sidebar";
import Topbar from "./components/TopBar";
import { useEffect, useState } from "react";

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const [user, setUser] = useState<any>(null);

  useEffect(() => {
    async function load() {
      const res = await fetch("/auth/me", { cache: "no-store" });
      const data = await res.json();
      if (!data.ok) window.location.href = "/login";
      setUser(data.user);
    }
    load();
  }, []);

  if (!user) return null;

  return (
    <div className="min-h-screen flex bg-gray-100">
      <Sidebar />
      <div className="flex-1 flex flex-col">
        <Topbar user={user} />
        <main className="p-6">{children}</main>
      </div>
    </div>
  );
}
```

├─ app/dashboard/page.tsx
```
"use client";

import ProfileStrip from "./components/ProfileStrip";
import LevelCard from "./components/LevelCard";
import StatsRow from "./components/StatsRow";
import DisciplineCard from "./components/DisciplineCard";
import { useEffect, useState } from "react";

export default function DashboardPage() {
  const [user, setUser] = useState<any>(null);

  useEffect(() => {
    async function load() {
      const res = await fetch("/auth/me", { cache: "no-store" });
      const data = await res.json();
      if (!data.ok) window.location.href = "/login";
      setUser(data.user);
    }
    load();
  }, []);

  if (!user) return null;

  return (
    <div className="flex flex-col gap-6 max-w-4xl mx-auto">
      <ProfileStrip user={user} />
      <LevelCard user={user} />
      <StatsRow user={user} />
      <DisciplineCard user={user} />
    </div>
  );
}
```

├─ app/dashboard/profile/page.tsx
```
import { cookies } from "next/headers";
import { redirect } from "next/navigation";
import ProfileForm from "../components/ProfileForm";
import EmailPreferences from "../components/EmailPreferences";
import AvatarUploader from "../components/AvatarUploader";

export default async function ProfilePage() {
  const cookieStore = await cookies();
  const session = cookieStore.get("agw_session")?.value;

  if (!session) redirect("/login");

  const apiUrl = process.env.NEXT_PUBLIC_API_URL!;
  const res = await fetch(`${apiUrl}/api/user/get`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id: session }),
    cache: "no-store",
  });

  const user = await res.json();

  return (
    <div className="flex flex-col gap-8 p-6">
      <h1 className="text-3xl font-bold">Il tuo Profilo</h1>

      <AvatarUploader user={user} />

      <ProfileForm user={user} />

      <EmailPreferences prefs={user.mailing.preferences} userId={user.id} />
    
    </div>
    
  );
}
```

├─ app/dashboard/settings/DangerZone.tsx
```
"use client";

export default function DangerZone() {
  async function handleDelete() {
    if (!confirm("Sei sicuro? Questa azione è irreversibile.")) return;

    const res = await fetch("/api/user/delete-account", {
      method: "POST",
    });

    if (!res.ok) {
      alert("Errore eliminazione account");
      return;
    }

    alert("Account eliminato");
    window.location.href = "/";
  }

  return (
    <div className="p-6 bg-red-50 border border-red-200 rounded-xl shadow-md">
      <h2 className="text-xl font-bold text-red-700 mb-4">Zona Pericolosa</h2>

      <button
        onClick={handleDelete}
        className="bg-red-600 text-white px-4 py-2 rounded"
      >
        Elimina Account
      </button>
    </div>
  );
}
```

├─ app/dashboard/settings/NotificationSetting.tsx
```
"use client";

import { useState } from "react";

export default function NotificationSettings() {
  const [pushEnabled, setPushEnabled] = useState(false);

  return (
    <div className="p-6 bg-white rounded-xl shadow-md">
      <h2 className="text-xl font-bold mb-4">Notifiche</h2>

      <label className="flex items-center gap-2">
        <input
          type="checkbox"
          checked={pushEnabled}
          onChange={(e) => setPushEnabled(e.target.checked)}
        />
        Attiva notifiche push (coming soon)
      </label>
    </div>
  );
}
```

├─ app/dashboard/settings/SecurityPanel.tsx
```
"use client";

import { useState } from "react";

export default function SecurityPanel() {
  const [oldPass, setOldPass] = useState("");
  const [newPass, setNewPass] = useState("");

  async function changePassword() {
    const res = await fetch("/api/user/change-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ oldPassword: oldPass, newPassword: newPass })

    });

    if (!res.ok) {
      alert("Errore nel cambio password");
      return;
    }

    alert("Password aggiornata");
  }

  return (
    <div className="p-6 bg-white rounded-xl shadow-md">
      <h2 className="text-xl font-bold mb-4">Sicurezza</h2>

      <label className="flex flex-col mb-2">
        Vecchia password
        <input
          type="password"
          className="border p-2 rounded"
          onChange={(e) => setOldPass(e.target.value)}
        />
      </label>

      <label className="flex flex-col mb-2">
        Nuova password
        <input
          type="password"
          className="border p-2 rounded"
          onChange={(e) => setNewPass(e.target.value)}
        />
      </label>

      <button
        onClick={changePassword}
        className="mt-2 bg-blue-600 text-white px-4 py-2 rounded"
      >
        Aggiorna
      </button>
    </div>
  );
}
```

├─ app/dashboard/settings/page.tsx
```
import { cookies } from "next/headers";
import { redirect } from "next/navigation";
import SecurityPanel from "./SecurityPanel";
import NotificationSettings from "./NotificationSetting";
import DangerZone from "./DangerZone";

export default async function SettingsPage() {
  const cookieStore = await cookies();
  const session = cookieStore.get("agw_session")?.value;

  if (!session) redirect("/login");

  return (
    <div className="flex flex-col gap-8 p-6">
      <h1 className="text-3xl font-bold">Impostazioni Account</h1>

      <SecurityPanel />
      <NotificationSettings />
      <DangerZone />
    </div>
  );
}
```

├─ app/forgot-password/page.tsx
```
"use client";

import { useState, useEffect } from "react";

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState("");

  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const preEmail = params.get("email");
    if (preEmail) setEmail(preEmail);
  }, []);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();

    await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/user/request-reset`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    alert("Se l’email è registrata, riceverai un link per reimpostare la password.");
  }

  return (
    <main className="min-h-screen flex items-center justify-center bg-gray-100 p-6">
      <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
        <h1 className="text-2xl font-bold mb-6 text-center">
          Recupera Password
        </h1>

        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          <input
            type="email"
            placeholder="Inserisci la tua email"
            className="p-3 border rounded-lg"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />

          <button
            type="submit"
            className="py-3 bg-black text-white rounded-lg font-semibold hover:bg-gray-800 transition"
          >
            Invia link di recupero
          </button>
        </form>
      </div>
    </main>
  );
}
```

├─ app/layout.tsx
```
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";


const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "AGW - A Gold Winner",
  description: "Reward-Based System",
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <head>
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#FFD700" />
        <link rel="apple-touch-icon" href="/icons/icon-192.png" />
      </head>
      <body className={`${geistSans.variable} ${geistMono.variable} antialiased`}>
        {children}
      </body>
    </html>
  );
}
```

├─ app/login/page.tsx
```
"use client";

import { useState } from "react";

export default function LoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [failCount, setFailCount] = useState(0);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError("");

    const res = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/user/login`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ email, password })
    });
    

    const data = await res.json();

    // EMAIL NON ESISTE
    if (res.status === 404 && data.error === "EMAIL_NOT_FOUND") {
      setError("Questa email non risulta registrata.");
      return;
    }

    // PASSWORD ERRATA
    if (res.status === 401 && data.error === "WRONG_PASSWORD") {
      setFailCount(n => n + 1);
      setError("Password errata. Riprova.");
      return;
    }

    // LOGIN OK
    if (data.ok) {
      window.location.href = "/dashboard";
    }
  }

  return (
    <main className="min-h-screen flex items-center justify-center bg-gray-100 p-6">
      <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
        <h1 className="text-3xl font-bold mb-6 text-center">Accedi</h1>

        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
          <input
            type="email"
            placeholder="Email"
            className="p-3 border rounded-lg"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />

          <input
            type="password"
            placeholder="Password"
            className="p-3 border rounded-lg"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            required
          />

          {error && (
            <div className="text-red-600 text-sm text-center">{error}</div>
          )}

          <button
            type="submit"
            className="py-3 bg-black text-white rounded-lg font-semibold hover:bg-gray-800 transition"
          >
            Accedi
          </button>
        </form>

        {/* EMAIL NON REGISTRATA */}
        {error === "Questa email non risulta registrata." && (
          <div className="mt-5 text-center">
            <p className="mb-3">Vuoi creare un nuovo account?</p>
            <a
              href={`/register?email=${encodeURIComponent(email)}`}
              className="text-blue-600 underline font-semibold"
            >
              Registrati con questa email
            </a>
          </div>
        )}

        {/* DOPO 3 ERRORI PASSWORD → PASSWORD RESET */}
        {failCount >= 3 && error !== "Questa email non risulta registrata." && (
          <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
            <p className="text-yellow-800 font-medium mb-2">
              Problemi ad accedere?
            </p>
            <a
              href={`/forgot-password?email=${encodeURIComponent(email)}`}
              className="text-blue-600 underline font-semibold"
            >
              Reimposta la password
            </a>
          </div>
        )}
      </div>
    </main>
  );
}
```

